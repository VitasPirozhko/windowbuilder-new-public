(this.webpackJsonpwindowbuilder=this.webpackJsonpwindowbuilder||[]).push([[45],{981:function(t,e,n){(function(e){t.exports=function({$p:t,paper:n}){const s={tune_paper(e){const n=t.job_prm.builder||{};n.handle_size&&(e.handleSize=n.handle_size),this.sticking=n.sticking||90,this.sticking_l=n.sticking_l||9,this.sticking0=this.sticking/2,this.sticking2=this.sticking*this.sticking,this.font_size=n.font_size||90,this.font_family=n.font_family||"GOST type B",this.elm_font_size=n.elm_font_size||60,this.cutoff=n.cutoff||1300,n.font_family||(n.font_family=this.font_family),n.font_size||(n.font_size=this.font_size),n.elm_font_size||(n.elm_font_size=this.elm_font_size),t.wsql.alasql.utils.isNode&&(this.font_size*=1.2,this.elm_font_size*=1.2),this.orientation_delta=n.orientation_delta||30},epsilon:.01,move_points:"move_points",move_handle:"move_handle",move_shapes:"move-shapes"};class i extends n.PaperScope{constructor(){super(),this._undo={clear(){},save_snapshot(){}},this.eve=new(Object.getPrototypeOf(t.md.constructor)),s.tune_paper(this.settings)}get consts(){return s}elm(t){return this.project.getItem({class:b,elm:t})}set_text(){}create_scheme(){return this._canvas||(this._canvas=document.createElement("CANVAS"),this._canvas.height=480,this._canvas.width=480,this.setup(this._canvas)),!this.projects.lengrh||this.projects[0]instanceof D||this.projects[0].remove(),new D(this._canvas,this,!0)}unload(){this.eve.removeAllListeners();const t=this.projects.concat(this.tools);for(;t.length;){const e=t[0];e.unload?e.unload():e.remove&&e.remove(),t.splice(0,1)}for(let t in i._scopes)i._scopes[t]===this&&delete i._scopes[t]}paths_intersecting_rect(t){const e=[],s=new n.Path.Rectangle(t);return this.project.getItems({class:z}).forEach(n=>{t.contains(n.generatrix.bounds)&&e.push(n.generatrix)}),s.remove(),e}segments_in_rect(t){const e=[];return this.project.getItems({class:l}).forEach((function s(i){if(i._locked||!i._visible||i._guide)return;const r=i.children||[];if(t.intersects(i.bounds))if(i instanceof n.Path){if(i.parent instanceof z){if(i!=i.parent.generatrix)return;for(let n=0;n<i.segments.length;n++)t.contains(i.segments[n].point)&&e.push(i.segments[n])}}else for(let t=r.length-1;t>=0;t--)s(r[t])})),e}clear_selection_bounds(){this._selectionBoundsShape&&this._selectionBoundsShape.remove(),this._selectionBoundsShape=null}hide_selection_bounds(){this._drawSelectionBounds>0&&this._drawSelectionBounds--,0==this._drawSelectionBounds&&this._selectionBoundsShape&&(this._selectionBoundsShape.visible=!1)}canvas_cursor(t){this.projects.forEach(e=>{for(let n=0;n<e.view.element.classList.length;n++){const s=e.view.element.classList[n];if(s==t)return;/\bcursor-\S+/g.test(s)&&e.view.element.classList.remove(s)}e.view.element.classList.add(t)})}}t.EditorInvisible=i,i.ToolElement=class extends n.Tool{resetHot(t,e,n){}testHot(t,e,n){return this.hitTest(e)}detache_wnd(){this.profile=null}check_layer(){const{project:t,eve:e}=this._scope;t.contours.length||(new i.Contour({parent:void 0}),e.emit_async("rows",t.ox,{constructions:!0}))}on_activate(e){if(this._scope.canvas_cursor(e),this.eve.emit_async("tool_activated",this),"select_node"!=this.options.name&&(this.check_layer(),this.project._dp.sys.empty())){const{msg:e,ui:n}=t;n&&n.dialogs.alert({text:e.bld_not_sys,title:e.bld_title})}}get eve(){return this._scope.eve}get project(){return this._scope.project}};const r=t=>class extends t{is_pos(t){if(1==this.project.contours.count||this.parent)return!0;let e=Math.abs(this.bounds[t]-this.project.bounds[t])<s.sticking_l;if(!e){let s;"top"==t?s=new n.Rectangle(this.bounds.topLeft,this.bounds.topRight.add([0,-200])):"left"==t?s=new n.Rectangle(this.bounds.topLeft,this.bounds.bottomLeft.add([-200,0])):"right"==t?s=new n.Rectangle(this.bounds.topRight,this.bounds.bottomRight.add([200,0])):"bottom"==t&&(s=new n.Rectangle(this.bounds.bottomLeft,this.bounds.bottomRight.add([0,200]))),e=!this.project.contours.some(t=>t!=this&&s.intersects(t.bounds))}return e}profiles_by_side(t,e){e||(e=this.profiles);const n={left:1/0,top:1/0,bottom:-1/0,right:-1/0},s={},i=[];function r(t){i.some(e=>{if(e[t]==n[t])return s[t]=e.profile,!0})}if(e.length){if(e.forEach(t=>{const{b:e,e:s}=t,r=e.x+s.x,o=e.y+s.y;r<n.left&&(n.left=r),r>n.right&&(n.right=r),o<n.top&&(n.top=o),o>n.bottom&&(n.bottom=o),i.push({profile:t,left:r,top:o,bottom:o,right:r})}),t)return r(t),s[t];Object.keys(n).forEach(r)}return s}get contours(){return this.children.filter(t=>t instanceof l)}get l_dimensions(){const{_attr:t}=this;return t._dimlns||(t._dimlns=new u({parent:this}))}get dimension_bounds(){let{bounds:t}=this;return this.getItems({class:m}).forEach(e=>{t=t.unite(e.bounds)}),t}};i.AbstractFilling=r;class a{constructor(t,e,n,s){this.profile=t,this.b=e.clone(),this.e=n.clone(),this.outer=s,this.segment()}segment(){let t;this.profile.children.some(e=>{if(e instanceof E&&this.outer==e.outer){t||(t=this.profile.generatrix);const n=this.profile instanceof E?this.profile.b:this.b,s=this.profile instanceof E?this.profile.e:this.e;if(n.is_nearest(t.getNearestPoint(e.b),!0)&&s.is_nearest(t.getNearestPoint(e.e),!0))return this.profile=e,this.outer=!1,!0}})&&this.segment()}break_by_angle(t,e,n,s,i,r){const o=t.byPoint(n);if(!o)return!1;let a=i.generatrix.getTangentAt(s);this.outer&&(a=a.negate());const c=[];for(const t of o){if(t.profile===i)continue;const{generatrix:s}=t.profile,r=s.getNearestPoint(n),o=s.getOffsetOf(r),l=s.getTangentAt(o);for(const n of e)n.profile===t.profile&&n.b.is_nearest(r,!0)&&c.push({profile:t.profile,angle:a.getDirectedAngle(n.outer?l.negate():l)})}let l;for(const t of c)t.profile===r&&(!l||t.angle>l)&&(l=t.angle);if(l<0)return!0;for(const t of c)if(t.profile!==r&&t.angle>l)return!0}has_cnn(t,e,n){const s=t.b;if(!this.e.is_nearest(s,0))return!1;let i=this.profile,r=t.profile;for(;i instanceof E;)this.outer||(this.outer=!i.is_collinear(i.parent)),i=i.parent;for(;r instanceof E;)t.outer||(t.outer=!r.is_collinear(r.parent)),r=r.parent;if(i===r&&(this.profile instanceof E||t.profile instanceof E))return!1;if(i.gb.is_nearest(s,!0)){const t=this.break_by_angle(e,n,s,0,i,r);if(t)return!1;if(void 0===t||i.rays.b.profile===r)return!0}if(i.ge.is_nearest(s,!0)){const t=this.break_by_angle(e,n,s,i.generatrix.length,i,r);if(t)return!1;if(void 0===t||i.rays.e.profile===r)return!0}if(r.gb.is_nearest(s,!0)){const o=t.break_by_angle(e,n,s,0,r,i);if(o)return!1;if(void 0===o||r.rays.b.profile==i)return!0}if(r.ge.is_nearest(s,!0)){const o=t.break_by_angle(e,n,s,r.generatrix.length,r,i);if(o)return!1;if(void 0===o||r.rays.e.profile==i)return!0}return!1}get _sub(){const{sub_path:t}=this;return{get b(){return t?t.firstSegment.point:new n.Point},set b(e){t&&(t.firstSegment.point=e)},get e(){return t?t.lastSegment.point:new n.Point},set e(e){t&&(t.lastSegment.point=e)}}}}class c extends Map{byPoint(t){for(const[e,n]of this)if(t.is_nearest(e,0))return n.length>2&&n}}class l extends(r(n.Layer)){constructor(e){super({parent:e.parent}),this._attr={};const{ox:n,l_connective:s}=this.project;if(e.row)this._row=e.row;else{const{constructions:t}=n;this._row=t.add({parent:e.parent?e.parent.cnstr:0}),this._row.cnstr=t.aggregate([],["cnstr"],"MAX")+1}const{cnstr:i}=this;if(i){const{coordinates:e}=n,{elm_types:s}=t.enm;e.find_rows({cnstr:i},t=>{s.profiles.includes(t.elm_type)?t.parent?new N({row:t,parent:this}):new S({row:t,parent:this}):s.glasses.includes(t.elm_type)?new w({row:t,parent:this}):t.elm_type===s.Водоотлив?new M({row:t,parent:this}):t.elm_type===s.Текст&&new x({row:t,parent:this.l_text})})}s.bringToFront()}activate(t){this.project._activeLayer=this,this._row&&(this.notify(this,"layer_activated",!t),this.project.register_update())}get area(){return(this.bounds.area/1e6).round(3)}get form_area(){let t;return this.glasses(!1,!0).concat(this.profiles).forEach(({path:e})=>{t=t?t.unite(e,{insert:!1}):e.clone({insert:!1})}),(t.area/1e6).round(3)}get furn(){return this._row.furn}set furn(e){const{_row:n}=this;n.furn!=e&&(n.furn=e,this.direction.empty()&&this.project._dp.sys.furn_params.find_rows({param:t.job_prm.properties.direction},({value:t})=>(n.direction=t,!1)),n.furn.refill_prm(this),this.project.register_change(!0),this.notify(this,"furn_changed"))}glasses(t,e){return this.children.filter(n=>{if(!e&&n instanceof l||n instanceof w)return t&&(n.visible=!1),!0})}get fillings(){const t=[];for(const e of this.glasses())e instanceof l?t.push.apply(t,e.fillings):t.push(e);return t}get glass_contours(){const t=this.glass_segments,e=this.count_nodes(),n=[];let s,i;function r(n){const o=a.next(n,e,t);for(const t of o){if(t===s)return o;if(i.every(e=>e!==t))return i.push(t),r(t)}}for(;t.length;)s=t[0],i=[s],r(s)&&i.length>1&&n.push(i),i.forEach(e=>{const n=t.indexOf(e);-1!=n&&t.splice(n,1)});return n}glass_nodes(t,e,n){const s=[],i=[],r=t.interiorPoint.negate();let o,a,c,l,_;e||(e=this.nodes);for(let h in t.curves){o=t.curves[h];let p=1/0,d=1/0;if(e.forEach(t=>{(c=t.getDistance(o.point1,!0))<p&&(p=c,l=t),(c=t.getDistance(o.point2,!0))<d&&(d=c,_=t)}),-1==i.indexOf(l)&&i.push(l),-1==i.indexOf(_)&&i.push(_),n&&l!==_){a=!1;for(let t in s)if(s[t].node1==l&&s[t].node2==_){a=!0;break}if(!a){a=this.profile_by_nodes(l,_);const t=a.generatrix.getNearestLocation(l),e=a.generatrix.getNearestLocation(_);l.add(r).getDirectedAngle(_.add(r))<0?s.push({node1:_,node2:l,profile:a,out:e.index==t.index?e.parameter>t.parameter:e.index>t.index}):s.push({node1:l,node2:_,profile:a,out:t.index==e.index?t.parameter>e.parameter:t.index>e.index})}}}return this.sort_nodes(s),i}calck_rating(t,e){const{outer_profiles:n}=e;let s=0;if(n.length)for(const e of t){for(const t of n)if(e.profile==t.profile&&e.b.is_nearest(t.b)&&e.e.is_nearest(t.e)){s++;break}if(s>2)break}else{const{nodes:n}=e;for(const e of t){for(const t of n)if(e.b.is_nearest(t)){s++;break}if(s>2)break}}return s}glass_recalc(){const{glass_contours:t}=this,e=this.glasses(!0),s=new Set;for(const n of e)if(!n.visible)for(const e of t)if(!s.has(e)&&this.calck_rating(e,n)>2){n.path=e,n.visible=!0,n instanceof w&&n.redraw(),s.add(e);break}for(const i of t){if(s.has(i))continue;let t,r,o,a,c=0;for(const s in e)t=e[s],t.visible||(r=this.calck_rating(i,t),(r>c||!o)&&(c=r,o=t),r==c&&o!=t&&(a||(a=i.reduce((t,e)=>t.add(e.b),new n.Point).divide(i.length)),a.getDistance(t.bounds.center,!0)<a.getDistance(o.bounds.center,!0)&&(o=t)));o||(o=this.getItem({class:w,visible:!1}))?(o.path=i,o.visible=!0,o instanceof w&&o.redraw()):((t=this.getItem({class:w}))||(t=this.project.getItem({class:w})),o=new w({proto:t,parent:this,path:i}),o.redraw())}}get glass_segments(){const t=[];function e(e,n,s,i=!1){if(!n.is_nearest(s,0)){for(const r of t)if(r.profile===e&&r.b.is_nearest(n,0)&&r.e.is_nearest(s,0)&&r.outer==i)return;t.push(new a(e,n,s,i))}}for(const t of this.profiles){const n=a.fn_sort.bind(t.generatrix),s=t.joined_imposts(),{b:i,e:r}=t.rays,o=i.is_t&&i.profile.d0?i.profile.generatrix.getNearestPoint(t.b):t.b,c=r.is_t&&r.profile.d0?r.profile.generatrix.getNearestPoint(t.e):t.e;if(s.inner.length){s.inner.sort(n),i.is_i||o.is_nearest(s.inner[0].point)||e(t,o,s.inner[0].point);for(let n=1;n<s.inner.length;n++)e(t,s.inner[n-1].point,s.inner[n].point);r.is_i||s.inner[s.inner.length-1].point.is_nearest(c)||e(t,s.inner[s.inner.length-1].point,c)}if(s.outer.length){s.outer.sort(n),i.is_i||s.outer[0].point.is_nearest(o)||e(t,s.outer[0].point,o,!0);for(let n=1;n<s.outer.length;n++)e(t,s.outer[n].point,s.outer[n-1].point,!0);r.is_i||c.is_nearest(s.outer[s.outer.length-1].point)||e(t,c,s.outer[s.outer.length-1].point,!0)}s.inner.length||i.is_i||r.is_i||e(t,o,c),!s.outer.length&&(i.is_cut||r.is_cut||i.is_t||r.is_t)?i.is_i||r.is_i||e(t,c,o,!0):(i.is_x||r.is_x)&&e(t,c,o,!0)}return t}get is_rectangular(){const{Импост:e}=t.enm.elm_types,n=this.profiles.filter(t=>t.elm_type!=e);return 4===n.length&&!n.some(t=>!(t.is_linear()&&Math.abs(t.angle_hor%90)<.2))}move(t){const{contours:e,profiles:n,project:s}=this,i=t=>t.rays.clear();this.translate(t),e.forEach(t=>t.profiles.forEach(i)),n.forEach(i),s.register_change()}get nodes(){const t=[];return this.profiles.forEach(({b:e,e:n})=>{let s,i;t.forEach(t=>{e&&e.is_nearest(t)&&(s=!0),n&&n.is_nearest(t)&&(i=!0)}),!s&&e&&t.push(e.clone()),!i&&n&&t.push(n.clone())}),t}count_nodes(){const t=new c;return this.profiles.forEach(e=>{const{b:n,e:s}=e;let i,r;for(const[o,a]of t)n&&n.is_nearest(o)&&(a.push({profile:e,point:"b"}),i=!0),s&&s.is_nearest(o)&&(a.push({profile:e,point:"e"}),r=!0);!i&&n&&t.set(n.clone(),[{profile:e,point:"b"}]),!r&&s&&t.set(s.clone(),[{profile:e,point:"e"}])}),t}notify(t,e="update"){t.type&&(e=t.type),this.project._scope.eve.emit_async(e,t),e===s.move_points&&this.project.register_change()}get outer_nodes(){return this.outer_profiles.map(t=>t.elm)}get outer_profiles(){const{profiles:t}=this,e=[],n=[];let s,i;for(let n=0;n<t.length;n++){const r=t[n];if(!r._attr.simulated){s=!1,i=!1;for(let e=0;e<t.length;e++)t[e]!=r&&(!s&&r.has_cnn(t[e],r.b)&&r.b.is_nearest(t[e].e)&&(s=!0),!i&&r.has_cnn(t[e],r.e)&&r.e.is_nearest(t[e].b)&&(i=!0));s&&i||e.push(r)}}for(let s=0;s<t.length;s++){const i=t[s];-1==e.indexOf(i)&&(i._attr.binded=!1,n.push({elm:i,profile:i.nearest(!0),b:i.b,e:i.e}))}return n}profile_by_furn_side(e,n){n&&n.profiles||(n={profiles:this.outer_nodes,bottom:this.profiles_by_side("bottom")});const s=this.direction==t.enm.open_directions.Правое?"b":"e",i="b"==s?"e":"b";let r=n.bottom;const o=()=>--e<=0?r:(n.profiles.some(t=>{if(t[i].is_nearest(r[s]))return r=t,!0}),o());return o()}profile_by_nodes(t,e,n){const{profiles:s}=this;for(let i=0;i<s.length;i++){const{generatrix:r}=s[i];if(r.getNearestPoint(t).is_nearest(t)&&r.getNearestPoint(e).is_nearest(e)&&(!n||r.getNearestPoint(n).is_nearest(n)))return s[i]}}remove(){const{children:t,_row:e,cnstr:n}=this;for(;t.length;)t[0].remove();if(e){const{ox:t}=this.project;t.coordinates.clear({cnstr:n}),t.params.clear({cnstr:n}),t===e._owner._owner&&e._owner.del(e),this._row=null}super.remove()}get _manager(){return this.project._dp._manager}_metadata(t){const{tabular_sections:e}=this.project.ox._metadata(),{fields:n}=e.constructions;return t?n[t]||e[t]:{fields:{furn:n.furn,direction:n.direction,h_ruch:n.h_ruch},tabular_sections:{params:e.params}}}get bounds(){const{_attr:t,parent:e}=this;return t._bounds&&t._bounds.width&&t._bounds.height||(this.profiles.forEach(n=>{const s=n.path&&n.path.segments.length?n.path:n.generatrix;if(s&&(t._bounds=t._bounds?t._bounds.unite(s.bounds):s.bounds,!e)){const{d0:e}=n;e&&(t._bounds=t._bounds.unite(n.generatrix.bounds))}}),this.sectionals.forEach(e=>{t._bounds=t._bounds?t._bounds.unite(e.bounds):e.bounds}),t._bounds||(t._bounds=new n.Rectangle)),t._bounds}get cnstr(){return this._row?this._row.cnstr:0}set cnstr(t){this._row&&(this._row.cnstr=t)}get dimension_bounds(){let t=super.dimension_bounds;const e=this.l_visualization._by_insets.bounds;if(e.height&&e.bottom>t.bottom){const s=e.bottom-t.bottom+10;t=t.unite(new n.Rectangle(t.bottomLeft,t.bottomRight.add([0,s<250?1.1*s:1.2*s])))}return t}get direction(){return this._row.direction}set direction(t){this._row.direction=t,this.project.register_change(!0)}zoom_fit(){this.project.zoom_fit.call(this,null,!0)}draw_cnn_errors(){const{l_visualization:t}=this;t._cnn?t._cnn.removeChildren():t._cnn=new n.Group({parent:t});const e={strokeColor:"red",strokeWidth:2,strokeCap:"round",strokeScaling:!1,dashOffset:4,dashArray:[4,4],guide:!0,parent:t._cnn};this.glasses(!1,!0).forEach(t=>{let n;if(t.profiles.forEach(({cnn:t,sub_path:s})=>{t||(Object.assign(s,e),n=!0)}),n||t.path.is_self_intersected())t.fill_error();else{const{form_area:e,inset:{smin:n,smax:s}}=t;n&&n>e||s&&s<e?t.fill_error():t.path.fillColor=b.clr_by_clr.call(t,t._row.clr,!1)}t.imposts.forEach(t=>{if(t instanceof A){const{b:n,e:s}=t._attr._rays,i=Object.assign({radius:50},e);n.check_err(i),s.check_err(i)}})}),this.profiles.forEach(t=>{const{_corns:n,_rays:s}=t._attr;s.b.check_err(e),s.e.check_err(e),!t.nearest(!0)||t._attr._nearest_cnn&&!t._attr._nearest_cnn.empty()||Object.assign(t.path.get_subpath(n[1],n[2]),e),t.addls.forEach(t=>{!t.nearest(!0)||t._attr._nearest_cnn&&!t._attr._nearest_cnn.empty()||Object.assign(t.path.get_subpath(n[1],n[2]),e)})})}draw_mosquito(){const{l_visualization:e,project:i}=this;!1!==i.builder_props.mosquito&&i.ox.inserts.find_rows({cnstr:this.cnstr},i=>{if(i.inset.insert_type==t.enm.inserts_types.МоскитнаяСетка){const r={parent:new n.Group({parent:e._by_insets}),strokeColor:"grey",strokeWidth:3,dashArray:[6,4],strokeScaling:!1};let o,a;i.inset.specification.forEach(e=>{o||e.count_calc_method!=t.enm.count_calculating_ways.ПоПериметру||e.nom.elm_type!=t.enm.elm_types.Рама||(o=e.sz),a||e.count_calc_method!=t.enm.count_calculating_ways.ПоШагам||e.nom.elm_type!=t.enm.elm_types.Импост||(a=e)});const c=[];"number"!=typeof o&&(o=20),this.outer_profiles.forEach(t=>{const e=t.profile||t.elm,n=(Math.abs(e.angle_hor-t.elm.angle_hor)>60?e.rays.outer:e.rays.inner).get_subpath(t.b,t.e).equidistant(o);c.push(Object.assign(n,r))});const l=c.length-1;c.forEach((t,e)=>{const n=0==e?c[l]:c[e-1],s=e==l?c[0]:c[e+1],i=t.getIntersections(n),r=t.getIntersections(s);i.length&&(t.firstSegment.point=i[0].point),r.length&&(t.lastSegment.point=r[0].point)});const{elm_font_size:_}=s,{bounds:h}=r.parent;if(new n.PointText({parent:r.parent,fillColor:"black",fontFamily:s.font_family,fontSize:s.elm_font_size,guide:!0,content:i.inset.presentation,point:h.bottomLeft.add([1.2*_,.4*-_])}),a){const{offsets:t,do_center:e,step:s}=a,i=function(t){const e=Object.assign(new n.Path({insert:!1,segments:[[h.left,t],[h.right,t]]}),r),{length:s}=e;c.forEach(t=>{const n=t.getIntersections(e);if(n.length){const t=e.firstSegment.point.getDistance(n[0].point),i=e.lastSegment.point.getDistance(n[0].point);t<s/2&&(e.firstSegment.point=n[0].point),i<s/2&&(e.lastSegment.point=n[0].point)}})};if(s){const n=h.height-t;if(n>=s)if(e)i(h.centerY);else for(let t=s;t<n;t+=s)i(t)}}return!1}})}draw_jalousie(e){const{l_visualization:i,project:r}=this;!1!==r.builder_props.jalousie&&r.ox.inserts.find_rows({cnstr:-e.elm},({inset:o,clr:a})=>{if(o.insert_type==t.enm.inserts_types.Жалюзи){let c,l,_,h,p;r.ox.params.find_rows({inset:o,cnstr:-e.elm},({param:t,value:e})=>{e.css&&["tb_jalousie_horizontal","tb_jalousie_vertical","tb_jalousie_roller"].includes(e.css)&&(l=e.css.replace("tb_jalousie_","")),e.css&&["tb_jalousie_control-side-left","tb_jalousie_control-side-right"].includes(e.css)&&(c=e.css.replace("tb_jalousie_control-side-",""))}),l||(l="horizontal"),c||(c="left");const d={parent:new n.Group({parent:i._by_insets}),fillColor:b.clr_by_clr(a),shadowColor:"lightgray",shadowBlur:20,shadowOffset:[13,13],opacity:.3,strokeScaling:!1,closed:!0,guide:!0},u=e.bounds_light();switch(o.specification.forEach(({count_calc_method:e,sz:n,offsets:s})=>{if(e==t.enm.count_calculating_ways.ПоПлощади&&n&&s)return u.height+=s,u.width+=n,u.left-=.6*n,u.top-=.6*s,!1}),l){case"roller":new n.Path(Object.assign({segments:[u.topLeft,u.topRight,u.bottomRight,u.bottomLeft]},d));break;case"horizontal":for(h=Math.floor(u.height/60),_=u.height/h-.01,p=u.top;p<u.bottom-_;)new n.Path(Object.assign({segments:[[u.left,p],[u.right,p],[u.right,p+_-20],[u.left,p+_-20]]},d)),p+=_;break;case"vertical":for(h=Math.floor(u.width/60),_=u.width/h-.01,p=u.left;p<u.right-_;)new n.Path(Object.assign({segments:[[p,u.top],[p+_-20,u.top],[p+_-20,u.bottom],[p,u.bottom]]},d)),p+=_}p="left"===c?u.left-10:u.right+10,new n.Path(Object.assign({segments:[[p,u.top],[p+10,u.top],[p+10,u.bottom-80],[p+20,u.bottom-40],[p-10,u.bottom-40],[p,u.bottom-80]]},d,{strokeColor:"lightgray",strokeOpacity:.5,strokeWidth:1,fillColor:"gray",opacity:.6})),new n.Path(Object.assign({segments:[u.topLeft.add([0,-10]),u.topRight.add([0,-10]),u.topRight.add([0,20]),u.topLeft.add([0,20])]},d,{strokeColor:"lightgray",strokeOpacity:.5,strokeWidth:1,fillColor:"lightgray",opacity:.6}));const{elm_font_size:f}=s;return new n.PointText({parent:d.parent,fillColor:"black",fontFamily:s.font_family,fontSize:s.elm_font_size,guide:!0,content:o.presentation,point:u.topLeft.add([f/3,0])}),!1}})}draw_sill(){const{l_visualization:e,project:s,cnstr:i}=this,{ox:r}=s,{properties:o}=t.job_prm;if(!o)return;const{length:a,width:c}=o;r.inserts.find_rows({cnstr:i},s=>{if(s.inset.insert_type==t.enm.inserts_types.Подоконник){const t=this.profiles_by_side("bottom");let o,l;r.params.find_rows({cnstr:i,inset:s.inset},t=>{t.param==a&&(o=t.value),t.param==c&&(l=t.value)}),o||(o=t.length+160),l?l*=.7:l=200;const _=(o-t.length)/2;return new n.Path({parent:new n.Group({parent:e._by_insets}),strokeColor:"grey",fillColor:b.clr_by_clr(s.clr),shadowColor:"grey",shadowBlur:20,shadowOffset:[10,20],opacity:.7,strokeWidth:1,strokeScaling:!1,closed:!0,segments:[t.b.add([_,0]),t.e.add([-_,0]),t.e.add([-_-l,l]),t.b.add([_-l,l])]}),!1}})}draw_opening(){const e=this,{l_visualization:s,furn:i}=this;if(!this.parent||!t.enm.open_types.is_opening(i.open_type))return void(s._opening&&s._opening.visible&&(s._opening.visible=!1));const r={profiles:this.outer_nodes,bottom:this.profiles_by_side("bottom")};return s._opening?s._opening.removeChildren():s._opening=new n.CompoundPath({parent:e.l_visualization,strokeColor:"black"}),i.is_sliding?function(){const{center:n}=e.bounds,{_opening:i}=s;e.direction==t.enm.open_directions.Правое?(i.moveTo(n.add([-100,0])),i.lineTo(n.add([100,0])),i.moveTo(n.add([30,30])),i.lineTo(n.add([100,0])),i.lineTo(n.add([30,-30]))):(i.moveTo(n.add([100,0])),i.lineTo(n.add([-100,0])),i.moveTo(n.add([-30,30])),i.lineTo(n.add([-100,0])),i.lineTo(n.add([-30,-30])))}():function(){const{_opening:t}=s,{side_count:n}=e;i.open_tunes.forEach(s=>{if(s.rotation_axis){const i=e.profile_by_furn_side(s.side,r),o=e.profile_by_furn_side(s.side+2<=n?s.side+2:s.side-2,r);t.moveTo(i.corns(3)),t.lineTo(o.rays.inner.getPointAt(o.rays.inner.length/2)),t.lineTo(i.corns(4))}})}()}draw_visualization(t){const{profiles:e,l_visualization:n,contours:s}=this,i=this.glasses(!1,!0).filter(({visible:t})=>t);function r(t){if(this.elm===t.elm&&t.visible)return this.nom.visualization.draw(t,n,1e3*this.len),!0}n._by_spec.removeChildren(),t||(t=[],this.project.ox.specification.find_rows({dop:-1},e=>t.push(e))),this.draw_mosquito(),this.draw_sill(),i.forEach(this.draw_jalousie.bind(this));for(const s of t)e.some(r.bind(s))||i.some(t=>s.elm===t.elm?(s.nom.visualization.draw(t,n,[1e3*s.len,1e3*s.width]),!0):t.imposts.some(r.bind(s)));for(const e of s)e.draw_visualization(t)}get hidden(){return!!this._hidden}set hidden(t){if(this.hidden!=t){this._hidden=t;const e=!this._hidden;this.children.forEach(t=>{t instanceof b&&(t.visible=e)}),this.l_visualization.visible=e,this.l_dimensions.visible=e}}hide_generatrix(){this.profiles.forEach(t=>{t.generatrix.visible=!1})}get imposts(){return this.getItems({class:S}).filter(t=>{const{b:e,e:n}=t.rays;return e.is_tt||n.is_tt||e.is_i||n.is_i})}get params(){return this.project.ox.params}get path(){return this.bounds}set path(t){if(!Array.isArray(t))return;const e={type:s.move_points,profiles:[],points:[]},{outer_nodes:n}=this;let i,r,o=t.length,a=n.length;function c(t){r[t].is_nearest(i[t],0)||(i.rays.clear(!0),i[t]=r[t],-1==e.profiles.indexOf(i)&&e.profiles.push(i),e.points.some(e=>e.is_nearest(i[t],0))||e.points.push(i[t]))}if(o)for(let e=0;e<t.length;e++){r=t[e];for(let t=0;t<n.length;t++)if(i=n[t],!i._attr.binded&&r.profile.is_nearest(i)){i._attr.binded=!0,r.binded=!0,o--,a--,c("b"),c("e");break}}if(o)for(let e=0;e<t.length;e++)if(r=t[e],!r.binded)for(let t=0;t<n.length;t++)if(i=n[t],!i._attr.binded&&(r.b.is_nearest(i.b,!0)||r.e.is_nearest(i.e,!0))){i._attr.binded=!0,r.binded=!0,o--,a--,c("b"),c("e");break}if(o&&a)for(let e=0;e<t.length;e++)if(r=t[e],!r.binded)for(let t=0;t<n.length;t++)if(i=n[t],!i._attr.binded){i._attr.binded=!0,r.binded=!0,o--,a--,c("b"),c("e");break}if(o){const s=this instanceof h?N:S;for(let a=0;a<t.length;a++)r=t[a],r.binded||(i=new s({generatrix:r.profile.generatrix.get_subpath(r.b,r.e),proto:n.length?n[0]:{parent:this,clr:r.profile.clr},_nearest:r.profile}),r.profile=i,delete r.outer,r.binded=!0,e.profiles.push(i),e.points.push(i.b),e.points.push(i.e),o--)}a&&n.forEach(t=>{t._attr.binded||(t.rays.clear(!0),t.remove(),a--)}),this.profiles.forEach(t=>t.default_inset()),e.points.length&&(this.profiles.forEach(t=>t._attr._rays&&t._attr._rays.clear()),this.notify(e)),this._attr._bounds=null}get perimeter(){const t=[];return this.outer_profiles.forEach(e=>{const n=e.sub_path?{len:e.sub_path.length,angle:e.e.subtract(e.b).angle}:{len:e.elm.length,angle:e.elm.angle_hor};t.push(n),n.angle<0&&(n.angle+=360),n.angle_hor=n.angle,n.profile=e.profile||e.elm}),t}perimeter_inner(t){const{center:e}=this.bounds,n=this.outer_profiles.map(t=>{const n=t.profile||t.elm,{inner:s,outer:i}=n.rays,r=s.getNearestPoint(e).getDistance(e,!0)<i.getNearestPoint(e).getDistance(e,!0)?s.get_subpath(s.getNearestPoint(t.b),s.getNearestPoint(t.e)):i.get_subpath(i.getNearestPoint(t.b),i.getNearestPoint(t.e));let o=t.e.subtract(t.b).angle.round(1);return o<0&&(o+=360),{profile:n,sub_path:r,angle:o,b:t.b,e:t.e}}),s=n.length-1;return n.map((e,i)=>{let r=e.sub_path.equidistant(t);const o=i?n[i-1]:n[s],a=i==s?n[0]:n[i+1],c=r.intersect_point(o.sub_path.equidistant(t),e.b,!0),l=r.intersect_point(a.sub_path.equidistant(t),e.e,!0);return c&&l&&(r=r.get_subpath(c,l)),{profile:e.profile,angle:e.angle,len:r.length,sub_path:r}})}bounds_inner(t){const e=new n.Path({insert:!1});for(let n of this.perimeter_inner(t))e.addSegments(n.sub_path.segments);return e.segments.length&&!e.closed&&e.closePath(!0),e.reduce(),e.bounds}get pos(){}get profiles(){return this.children.filter(t=>t instanceof S)}get sectionals(){return this.children.filter(t=>t instanceof M)}get onlays(){const t=[];return this.fillings.forEach(e=>{e.children.forEach(e=>e instanceof A&&t.push(e))}),t}redraw(){if(!this.visible)return;this._attr._bounds=null;const{_by_insets:t,_by_spec:e}=this.l_visualization;t.removeChildren(),!this.project._attr._saving&&e.removeChildren();for(const t of this.profiles)t.redraw();this.glass_recalc(),this.draw_opening();for(const t of this.contours)t.redraw();this.draw_cnn_errors();for(const t of this.sectionals)t.redraw();this.notify(this,"contour_redrawed",this._attr._bounds)}refresh_prm_links(e){const n=e?0:this.cnstr||-9999;let s;if(this.params.find_rows({cnstr:n,inset:t.utils.blank.guid},t=>{const{param:e}=t,i=e.params_links({grid:{selection:{cnstr:n}},obj:t});let r=!e.show_calculated&&e.is_calculated;r||(r=i.length?i.some(t=>t.hide):t.hide),i.length&&e.linked_values(i,t)&&(s=!0),t.hide!==r&&(t.hide=r,s=!0)}),s&&(this.notify(this,"refresh_prm_links"),e)){const{_dp:t}=this.project;t._manager.emit_async("rows",t,{extra_fields:!0})}}save_coordinates(t){if(!t){this.hidden||this.glasses(!1,!0).forEach(t=>!t.visible&&t.remove());const{l_text:t,l_dimensions:e}=this;for(let n of this.children)n.save_coordinates?n.save_coordinates():n!==t&&n!==e||n.children.forEach(t=>t.save_coordinates&&t.save_coordinates())}const{bounds:e}=this;this._row.x=e?e.width.round(4):0,this._row.y=e?e.height.round(4):0,this._row.is_rectangular=this.is_rectangular,this.parent?(this._row.w=this.w.round(4),this._row.h=this.h.round(4)):(this._row.w=0,this._row.h=0)}sort_nodes(t){if(!t.length)return t;let e=t[0];const n=[e];let s=t.length+1;for(;n.length<t.length&&s;){s--;for(let s=0;s<t.length;s++){const i=t[s];if(-1==n.indexOf(i)&&e.node2==i.node1){n.push(i),e=i;break}}}if(s){t.length=0;for(let e=0;e<n.length;e++)t.push(n[e]);n.length=0}}get furn_cache(){return{profiles:this.outer_nodes,bottom:this.profiles_by_side("bottom"),ox:this.project.ox,w:this.w,h:this.h}}handle_line(t){const{bounds:e,h_ruch:s}=this,i=this.profiles_by_side();return t==i.top||t==i.bottom?new n.Path({insert:!1,segments:[[e.left+s,e.top-200],[e.left+s,e.bottom+200]]}):new n.Path({insert:!1,segments:[[e.left-200,e.bottom-s],[e.right+200,e.bottom-s]]})}update_handle_height(t,e){const{furn:n,_row:s,project:i}=this,{furn_set:r,handle_side:o}=n;if(!o||r.empty())return;t||((t=this.furn_cache).ignore_formulas=!0);const a=this.profile_by_furn_side(o,t);if(!a)return;const{len:c}=a._row;let l;function _(t){const{handle_height_base:e,fix_ruch:n}=t;if(e<0){if(n||-3!=s.fix_ruch)return s.fix_ruch=n?-2:-1,l=(c/2).round()}else if(e>0&&(n||-3!=s.fix_ruch))return s.fix_ruch=n?-2:-1,l=e}return n.furn_set.specification.find_rows({dop:0},e=>{if(!e.quantity||!e.check_restrictions(this,t))return;if(_(e))return!1;const{nom:n}=e;if(n&&e.is_set_row){let e=!1;if(n.get_spec(this,t,!0).each(t=>{if(_(t))return!(e=!0)}),e)return!1}}),l&&!e&&s.h_ruch!=l&&(s.h_ruch=l,i._dp._manager.emit("update",this,{h_ruch:!0})),l}get h_ruch(){const{layer:t,_row:e}=this;return t?e.h_ruch:0}set h_ruch(t){const{layer:e,_row:n,project:s}=this;if(e){const e=n.fix_ruch;-3==e&&(n.fix_ruch=-1);const i=this.update_handle_height(null,!0);!i||-3==e&&0!=t||(n.h_ruch=i),0!=t&&-1!=[0,-1,-3].indexOf(n.fix_ruch)&&(n.h_ruch=t,-1==n.fix_ruch&&t!=i&&(n.fix_ruch=-3)),s.register_change()}else n.h_ruch=0;s._dp._manager.emit("update",this,{h_ruch:!0})}get side_count(){const{Импост:e}=t.enm.elm_types;let n=0;return this.profiles.forEach(t=>t.elm_type!=e&&n++),n}get w(){const{is_rectangular:t,bounds:e}=this,{left:n,right:s}=this.profiles_by_side();return e&&n&&s?e.width-n.nom.sizefurn-s.nom.sizefurn:0}get h(){const{is_rectangular:t,bounds:e}=this,{top:n,bottom:s}=this.profiles_by_side();return e&&n&&s?e.height-n.nom.sizefurn-s.nom.sizefurn:0}get l_text(){const{_attr:t}=this;return t._txt||(t._txt=new n.Group({parent:this}))}get l_visualization(){const{_attr:t}=this;return t._visl||(t._visl=new n.Group({parent:this,guide:!0}),t._visl._by_insets=new n.Group({parent:t._visl}),t._visl._by_spec=new n.Group({parent:t._visl})),t._visl}get opacity(){return this.children.length?this.children[0].opacity:1}set opacity(t){this.children.forEach(e=>{e instanceof b&&(e.opacity=t)})}on_remove_elm(t){this.parent&&this.parent.on_remove_elm(t),t instanceof S&&!this.project._attr._loading&&this.l_dimensions.clear()}on_insert_elm(t){this.parent&&this.parent.on_remove_elm(t),t instanceof S&&!this.project._attr._loading&&this.l_dimensions.clear()}on_sys_changed(){this.profiles.forEach(t=>t.default_inset(!0)),this.glasses().forEach(e=>{e instanceof l?e.on_sys_changed():((e.thickness<e.project._dp.sys.tmin||e.thickness>e.project._dp.sys.tmax)&&(e._row.inset=e.project.default_inset({elm_type:[t.enm.elm_types.Стекло,t.enm.elm_types.Заполнение]})),e.profiles.forEach(n=>{n.cnn&&n.cnn.check_nom2(n.profile)||(n.cnn=t.cat.cnns.elm_cnn(e,n.profile,t.enm.cnn_types.acn.ii))}))})}}a.fn_sort=function(t,e){const n=this.getOffsetOf(t.point),s=this.getOffsetOf(e.point);return n<s?-1:n>s?1:0},a.next=function(t,e,n){if(!t.anext){t.anext=[];for(const s of n)if(s!==t&&s.profile!==t.profile&&t.has_cnn(s,e,n)){const e=t.e.subtract(t.b).getDirectedAngle(s.e.subtract(s.b));(n.length<3||e>=0||Math.abs(e+180)<1)&&t.anext.push(s)}}return t.anext},i.Contour=l,i.GlassSegment=a;class _ extends l{constructor(t){super(t),this._row.kind||(this._row.kind=2)}remove(){super.remove()}}i.ContourNested=_;class h extends l{constructor(t){super(t),this._row.kind||(this._row.kind=1)}save_coordinates(t){if(!t){const{l_text:t,l_dimensions:e}=this;for(let n of this.children)n===t||n===e?n.children.forEach(t=>t.save_coordinates&&t.save_coordinates()):!n.save_coordinates||n instanceof N||n.save_coordinates()}super.save_coordinates(!0)}}i.ContourVirtual=h;class p{clear(){for(let t in this)this[t].removeChildren(),this[t].remove(),delete this[t]}has_size(t){for(let e in this){const{path:n}=this[e];if(n&&Math.abs(n.length-t)<1)return!0}}}class d extends n.Layer{get bounds(){return this.project.bounds}get owner_bounds(){return this.bounds}get dimension_bounds(){return this.project.dimension_bounds}}class u extends n.Group{constructor(t){super(t),this.bringToFront()}clear(){this.ihor&&this.ihor.clear(),this.ivert&&this.ivert.clear();for(let t of["bottom","top","right","left"])this[t]&&(this[t].removeChildren(),this[t].remove(),this[t]=null);this.layer&&this.layer.parent&&this.layer.parent.l_dimensions.clear()}redraw(t){const{parent:e,project:{builder_props:n}}=this;!t&&n.auto_lines||this.clear();for(let t of e.contours)t.l_dimensions.redraw();if(n.auto_lines&&(!e.parent||t)){const{ihor:n,ivert:s,by_side:i}=this.imposts();if(!Object.keys(i).length)return this.clear();const r=new Set(e.profiles);e.imposts.forEach(t=>t.visible&&r.add(t));for(let t of r){const i=!t.parent||t.parent===e,r=i?t instanceof a?t._sub.b:t.b:t.rays.b.npoint,o=i?t instanceof a?t._sub.e:t.e:t.rays.e.npoint;this.push_by_point({ihor:n,ivert:s,eb:r,ee:o,elm:t})}n.length>2?(n.sort((t,e)=>e.point-t.point),e.is_pos("right")?this.by_imposts(n,this.ihor,"right"):e.is_pos("left")&&this.by_imposts(n,this.ihor,"left")):n.length=0,s.length>2?(s.sort((t,e)=>t.point-e.point),e.is_pos("bottom")?this.by_imposts(s,this.ivert,"bottom"):e.is_pos("top")&&this.by_imposts(s,this.ivert,"top")):s.length=0,this.by_contour(n,s,t,i)}for(let t of this.children)t.redraw&&t.redraw()}push_by_point({ihor:t,ivert:e,eb:n,ee:s,elm:i}){n&&t.every(t=>t.point!=n.y.round())&&t.push({point:n.y.round(),elm:i,p:"b"}),s&&t.every(t=>t.point!=s.y.round())&&t.push({point:s.y.round(),elm:i,p:"e"}),n&&e.every(t=>t.point!=n.x.round())&&e.push({point:n.x.round(),elm:i,p:"b"}),s&&e.every(t=>t.point!=s.x.round())&&e.push({point:s.x.round(),elm:i,p:"e"})}draw_by_imposts(){const{parent:t}=this;this.clear();let e=0;for(let n of t.profiles){const{inner:t,outer:s}=n.joined_imposts(),{generatrix:i,angle_hor:r}=n;i.visible=!1;const o=t.concat(s);if(!o.length)continue;n.mark_direction();let a=r>135&&r<315;for(const t of o){const{point:r,profile:{rays:o,nom:c}}=t,l=i.intersect_point(o.inner,r),_=i.intersect_point(o.outer,r),h=i.getOffsetOf(r),p=i.getOffsetOf(l),d=i.getOffsetOf(_);let u,f;h>p?(u=p+c.sizefaltz,f=d-c.sizefaltz):(u=d+c.sizefaltz,f=p-c.sizefaltz),this.ihor["i"+ ++e]=new g({elm1:n,elm2:n,p1:a?h:"b",p2:a?"b":h,dx1:u,dx2:f,parent:this,offset:a?-150:150,outer:s.includes(t)})}}this.by_contour([],[],!0);for(let t of this.children)t.redraw&&t.redraw()}draw_by_falsebinding(){const{parent:t}=this;this.clear();const{ihor:e,ivert:n,by_side:s}=this.imposts();for(const s of t.fillings){if(!s.visible)continue;const{path:t}=s;for(const i of s.imposts){let{b:s,e:r}=i;t.is_nearest(s)&&(s=null),t.is_nearest(r)&&(r=null),(s||r)&&this.push_by_point({ihor:e,ivert:n,eb:s,ee:r,elm:i})}}this.by_contour([],[],!0,s),e.length>2?(e.sort((t,e)=>e.point-t.point),this.by_base(e,this.ihor,"left")):e.length=0,n.length>2?(n.sort((t,e)=>t.point-e.point),this.by_base(n,this.ivert,"top")):n.length=0;for(let t of this.children)t.redraw&&t.redraw()}by_imposts(t,e,n){const s="right"==n||"bottom"==n?-130:90;for(let i=0;i<t.length-1;i++)if(!e[i]){let r=Math.abs(t[i].point-t[i+1].point)<60?70:0;r&&e[i-1]&&e[i-1].offset!==s&&(r+=70),e[i]=new f({pos:n,elm1:t[i].elm instanceof a?t[i].elm._sub:t[i].elm,p1:t[i].p,elm2:t[i+1].elm instanceof a?t[i+1].elm._sub:t[i+1].elm,p2:t[i+1].p,parent:this,offset:s-r,impost:!0})}}by_base(t,e,n){let s="right"==n||"bottom"==n?-130:90;for(let i=1;i<t.length-1;i++)e[i-1]||(e[i-1]=new f({pos:n,elm1:t[0].elm instanceof a?t[0].elm._sub:t[0].elm,p1:t[0].p,elm2:t[i].elm instanceof a?t[i].elm._sub:t[i].elm,p2:t[i].p,parent:this,offset:s,impost:!0}),s+=90)}by_contour(t,e,n,s){const{project:i,parent:r}=this,{bounds:o}=r;(i.contours.length>1||n)&&(r.is_pos("left")&&!r.is_pos("right")&&i.bounds.height!=o.height?this.ihor.has_size(o.height)||(this.left?this.left.offset=t.length>2?220:90:this.left=new f({pos:"left",parent:this,offset:t.length>2?220:90,contour:!0})):this.left&&(this.left.remove(),this.left=null),r.is_pos("right")&&(i.bounds.height!=o.height||n)?this.ihor.has_size(o.height)||(this.right?this.right.offset=t.length>2?-260:-130:this.right=new f({pos:"right",parent:this,offset:t.length>2?-260:-130,contour:!0})):this.right&&(this.right.remove(),this.right=null),r.is_pos("top")&&!r.is_pos("bottom")&&i.bounds.width!=o.width?this.ivert.has_size(o.width)||(this.top?this.top.offset=e.length>2?220:90:this.top=new f({pos:"top",parent:this,offset:e.length>2?220:90,contour:!0})):this.top&&(this.top.remove(),this.top=null),r.is_pos("bottom")&&(i.bounds.width!=o.width||n)?this.ivert.has_size(o.width)||(this.bottom?this.bottom.offset=e.length>2?-260:-130:this.bottom=new f({pos:"bottom",parent:this,offset:e.length>2?-260:-130,contour:!0})):this.bottom&&(this.bottom.remove(),this.bottom=null)),"faltz"===n&&this.by_faltz(t,e,s)}by_faltz(t,e,n){this.left||(this.left=new f({pos:"left",parent:this,offset:90,contour:!0,faltz:(n.top.nom.sizefurn+n.bottom.nom.sizefurn)/2})),this.top||(this.top=new f({pos:"top",parent:this,offset:90,contour:!0,faltz:(n.left.nom.sizefurn+n.right.nom.sizefurn)/2}))}imposts(){const{parent:t}=this,{bounds:e}=t,n=t.profiles_by_side();return Object.keys(n).length?{ihor:[{point:e.top.round(),elm:n.top,p:n.top.b.y<n.top.e.y?"b":"e"},{point:e.bottom.round(),elm:n.bottom,p:n.bottom.b.y>n.bottom.e.y?"b":"e"}],ivert:[{point:e.left.round(),elm:n.left,p:n.left.b.x<n.left.e.x?"b":"e"},{point:e.right.round(),elm:n.right,p:n.right.b.x>n.right.e.x?"b":"e"}],by_side:n}:{ihor:[],ivert:[],by_side:{}}}get owner_bounds(){return this.parent.bounds}get dimension_bounds(){return this.parent.dimension_bounds}get ihor(){return this._ihor||(this._ihor=new p)}get ivert(){return this._ivert||(this._ivert=new p)}}i.DimensionDrawer=u,i.DimensionLayer=d;class f extends n.Group{constructor(t){super({parent:t.parent});const e=this._attr={};this._row=t.row,this._row&&this._row.path_data&&(t._mixin(JSON.parse(this._row.path_data)),t.elm1&&(t.elm1=this.project.getItem({elm:t.elm1})),t.elm2&&(t.elm2=this.project.getItem({elm:t.elm2}))),t.elm2||(t.elm2=t.elm1),t.p1||(t.p1="b"),t.p2||(t.p2="e"),Object.assign(e,t),t.contour&&(e.contour=!0),e.pos||e.elm1&&e.elm2?(new n.Path({parent:this,name:"callout1",strokeColor:"black",guide:!0}),new n.Path({parent:this,name:"callout2",strokeColor:"black",guide:!0}),new n.Path({parent:this,name:"scale",strokeColor:"black",guide:!0}),new n.PointText({parent:this,name:"text",justification:"center",fillColor:"black",fontFamily:s.font_family,fontSize:this._font_size()}),!this.project._attr._from_service&&this.on({mouseenter:this._mouseenter,click:this._click})):this.remove()}_font_size(){const{width:t,height:e}=this.project.bounds,{cutoff:n,font_size:i}=s,r=Math.max(t-n,e-n)/60;return i+(r>0?r:0)}_metadata(e){return t.dp.builder_size.metadata(e)}get _manager(){return t.dp.builder_size}_mouseenter(){this.project._scope.canvas_cursor("cursor-arrow-ruler")}_click(t){t.stop(),"function"===typeof i.RulerWnd&&(this.wnd=new i.RulerWnd(null,this),this.wnd.size=this.size)}_move_points(t,e){let s,i;const{_attr:r}=this;if(r.elm1){s={};const e=(r.elm1._sub||r.elm1)[r.p1],o=(r.elm2._sub||r.elm2)[r.p2];if("top"==this.pos||"bottom"==this.pos){const r=Math.abs(e.x-o.x);"right"==t.name?(i=new n.Point(t.size-r,0),s[t.name]=Math.max(e.x,o.x)):(i=new n.Point(r-t.size,0),s[t.name]=Math.min(e.x,o.x))}else{const r=Math.abs(e.y-o.y);"bottom"==t.name?(i=new n.Point(0,t.size-r),s[t.name]=Math.max(e.y,o.y)):(i=new n.Point(0,r-t.size),s[t.name]=Math.min(e.y,o.y))}}else s=this.layer.bounds,i="top"==this.pos||"bottom"==this.pos?"right"==t.name?new n.Point(t.size-s.width,0):new n.Point(s.width-t.size,0):"bottom"==t.name?new n.Point(0,t.size-s.height):new n.Point(0,s.height-t.size);if(i.length){const{project:n}=this;n.deselect_all_points(),n.getItems({class:z}).forEach(({b:n,e:i,generatrix:r,width:o})=>{o/=2,Math.abs(n[e]-s[t.name])<o&&Math.abs(i[e]-s[t.name])<o?r.segments.forEach(t=>t.selected=!0):Math.abs(n[e]-s[t.name])<o?r.firstSegment.selected=!0:Math.abs(i[e]-s[t.name])<o&&(r.lastSegment.selected=!0)}),n.move_points(i,!1),n.deselect_all_points(!0),n.register_update()}}sizes_wnd(t){if(this.wnd&&t.wnd==this.wnd.wnd)switch(t.name){case"close":this.children.text&&(this.children.text.selected=!1),this.wnd=null;break;case"left":case"right":"top"!=this.pos&&"bottom"!=this.pos||this._move_points(t,"x");break;case"top":case"bottom":"left"!=this.pos&&"right"!=this.pos||this._move_points(t,"y")}}redraw(){const{children:e,path:n,align:s,project:{builder_props:i}}=this;if(!e.length)return;if(!n)return void(this.visible=!1);const r=n.length;if(r<1)return void(this.visible=!1);this.visible=!0;const o=n.firstSegment.point,a=n.lastSegment.point,c=n.getNormalAt(0).multiply(this.offset+n.offset),l=c.length,_=l>30?c.normalize(l-20):c,h=o.add(_),p=a.add(_);e.callout1.segments.length?(e.callout1.firstSegment.point=o,e.callout1.lastSegment.point=o.add(c)):e.callout1.addSegments([o,o.add(c)]),e.callout2.segments.length?(e.callout2.firstSegment.point=a,e.callout2.lastSegment.point=a.add(c)):e.callout2.addSegments([a,a.add(c)]),e.scale.segments.length?(e.scale.firstSegment.point=h,e.scale.lastSegment.point=p):e.scale.addSegments([h,p]),e.callout1.visible=!this.hide_c1,e.callout2.visible=!this.hide_c2,e.scale.visible=!this.hide_line,e.text.content=r.round(i.rounding).toString(),e.text.rotation=a.subtract(o).angle,e.text.justification=s.ref;const d=this._font_size(),{isNode:u}=t.wsql.alasql.utils;e.text.fontSize=d,s==t.enm.text_aligns.left?e.text.position=h.add(n.getTangentAt(0).multiply(d)).add(n.getNormalAt(0).multiply(d/(u?1.9:2))):s==t.enm.text_aligns.right?e.text.position=p.add(n.getTangentAt(0).multiply(-d)).add(n.getNormalAt(0).multiply(d/(u?1.9:2))):(e.text.position=h.add(p).divide(2).add(n.getNormalAt(0).multiply(d/(u?1.9:2))),r<20&&(e.text.position=e.text.position.add(n.getTangentAt(0).multiply(d/3))))}get path(){const{parent:t,children:e,_attr:s,pos:i}=this;if(!e.length)return;const{owner_bounds:r,dimension_bounds:o}=t;let a,c,l=0;if(i?"top"==i?(a=r.topLeft,c=r.topRight,l=r[i]-o[i]):"left"==i?(a=r.bottomLeft,c=r.topLeft,l=r[i]-o[i]):"bottom"==i?(a=r.bottomLeft,c=r.bottomRight,l=r[i]-o[i]):"right"==i&&(a=r.bottomRight,c=r.topRight,l=r[i]-o[i]):(a="number"==typeof s.p1?s.elm1.corns(s.p1):s.elm1[s.p1],c="number"==typeof s.p2?s.elm2.corns(s.p2):s.elm2[s.p2]),!a||!c)return;const _=new n.Path({insert:!1,segments:[a,c]});return s.elm1&&i&&(a=_.getNearestPoint(s.elm1[s.p1]),c=_.getNearestPoint(s.elm2[s.p2]),_.getOffsetOf(a)>_.getOffsetOf(c)&&([a,c]=[c,a]),_.firstSegment.point=a,_.lastSegment.point=c),s.faltz&&(a=_.getPointAt(s.faltz),c=_.getPointAt(_.length-s.faltz),_.firstSegment.point=a,_.lastSegment.point=c),_.offset=l,_}get eve(){return this.project._scope.eve}get size(){return this.children.text&&parseFloat(this.children.text.content)||0}set size(t){this.children.text.content=parseFloat(t).round(1)}get pos(){return this._attr.pos||""}set pos(t){this._attr.pos=t,this.redraw()}get offset(){return this._attr.offset||90}set offset(t){const e=(parseInt(t)||90).round();this._attr.offset!=e&&(this._attr.offset=e,this.project.register_change(!0))}get align(){return this._attr.align&&"_"!=this._attr.align?this._attr.align:t.enm.text_aligns.center}set align(t){this._attr.align=t,this.redraw()}get hide_c1(){return!!this._attr.hide_c1}set hide_c1(t){const{children:e,_attr:n}=this;n.hide_c1=t,t&&e.callout1.setSelection(!1),this.redraw()}get hide_c2(){return!!this._attr.hide_c2}set hide_c2(t){const{children:e,_attr:n}=this;n.hide_c2=t,t&&e.callout2.setSelection(!1),this.redraw()}get hide_line(){return!!this._attr.hide_line}set hide_line(t){const{children:e,_attr:n}=this;n.hide_line=t,t&&e.scale.setSelection(!1),this.redraw()}remove(){this._row&&(this._row._owner.del(this._row),this._row=null,this.project.register_change()),super.remove()}}class m extends f{constructor(t){t.row||(t.row=t.parent.project.ox.coordinates.add()),t.row.cnstr||(t.row.cnstr=t.parent.layer.cnstr),t.row.elm||(t.row.elm=t.parent.project.ox.coordinates.aggregate([],["elm"],"max")+1),super(t)}get elm_type(){return t.enm.elm_types.Размер}save_coordinates(){const{_row:e,_attr:n,elm_type:s,pos:i,offset:r,size:o,align:a}=this;e.len=o,e.elm_type=s;const c={pos:i,elm1:n.elm1.elm,elm2:n.elm2.elm,p1:n.p1,p2:n.p2,offset:r};n.fix_angle&&(c.fix_angle=!0,c.angle=n.angle),a!=t.enm.text_aligns.left&&a!=t.enm.text_aligns.right||(c.align=a.ref||a),n.hide_c1&&(c.hide_c1=!0),n.hide_c2&&(c.hide_c2=!0),n.hide_line&&(c.hide_line=!0),n.by_curve&&(c.by_curve=!0),e.path_data=JSON.stringify(c)}get is_ruler(){const{ToolRuler:t}=i;return"function"===typeof t&&this.project._scope.tool instanceof t}setSelection(t){super.setSelection(t);const{project:e,children:n,hide_c1:s,hide_c2:i,hide_line:r,is_ruler:o}=this,{tool:a}=e._scope;t&&(s&&n.callout1.setSelection(!1),i&&n.callout2.setSelection(!1),r&&n.scale.setSelection(!1)),o&&a.wnd.attach(this)}_click(t){t.stop(),this.is_ruler&&(this.selected=!0)}_mouseenter(){const{project:{_scope:t},is_ruler:e}=this;e?t.canvas_cursor("cursor-arrow-ruler"):t.canvas_cursor("cursor-arrow-ruler-dis")}get angle(){if(this.fix_angle)return this._attr.angle||0;const{firstSegment:t,lastSegment:e}=this.path;return e.point.subtract(t.point).angle.round(1)}set angle(t){this._attr.angle=parseFloat(t).round(1),this.project.register_change(!0)}get fix_angle(){return!!this._attr.fix_angle}set fix_angle(t){this._attr.fix_angle=t,this.project.register_change(!0)}get path(){if(this.fix_angle){const{children:t,_attr:e}=this;if(!t.length)return;let s="number"==typeof e.p1?e.elm1.corns(e.p1):e.elm1[e.p1],i="number"==typeof e.p2?e.elm2.corns(e.p2):e.elm2[e.p2];if(!s||!i)return;const r=i.subtract(s).clone();r.angle=this.angle;const o=new n.Path({insert:!1,segments:[s,s.add(r)]});return o.lastSegment.point.add(r.multiply(1e4)),o.lastSegment.point=o.getNearestPoint(i),o.offset=0,o}return super.path}}i.DimensionLine=f,i.DimensionLineCustom=m;class g extends m{constructor(t){t.row={cnstr:1,elm:1,_owner:{del(){}}},super(t),new n.PointText({parent:this,name:"dx1",justification:"center",fontFamily:s.font_family,fillColor:"black",fontSize:s.font_size}),new n.PointText({parent:this,name:"dx2",justification:"center",fontFamily:s.font_family,fillColor:"black",fontSize:s.font_size})}get path(){const{children:t,_attr:{elm1:{generatrix:e},p1:s,p2:i,dx1:r,dx2:o}}=this;if(!t.length)return;let a=e.getPointAt("number"==typeof s?o:r),c=e.getPointAt("number"==typeof s?r:o);if(!a||!c)return;const l=new n.Path({insert:!1,segments:[a,c]});return l.offset=0,l}redraw(){const{children:t,path:e,offset:n,_attr:{elm1:i,p1:r,p2:o,dx1:a,dx2:c,outer:l}}=this;if(!t.length)return;if(!e)return void(this.visible=!1);this.visible=!0;const _=e.firstSegment.point,h=e.lastSegment.point,p=e.getNormalAt(0).multiply((l?-1:1)*(n+e.offset)),d=e.getTangentAt(0),u=p.normalize(p.length-20),f=_.add(u),m=h.add(u);let g=0;const y=i.cnn_point("b").profile;if(y){const t=i.generatrix.clone({insert:!1}).elongation(200),e=y.rays.outer.intersect_point(t,i.b),n=y.rays.inner.intersect_point(t,i.b);if(e&&n){const s=t.getOffsetOf(i.b),r=t.getOffsetOf(e),o=t.getOffsetOf(n);g=Math.min(r-s,o-s)}}t.callout1.segments.length?(t.callout1.firstSegment.point=_,t.callout1.lastSegment.point=_.add(p)):t.callout1.addSegments([_,_.add(p)]),t.callout2.segments.length?(t.callout2.firstSegment.point=h,t.callout2.lastSegment.point=h.add(p)):t.callout2.addSegments([h,h.add(p)]),t.scale.segments.length?(t.scale.firstSegment.point=f,t.scale.lastSegment.point=m):t.scale.addSegments([f,m]),t.scale.elongation(200),t.text.rotation=t.dx1.rotation=t.dx2.rotation=0,t.text.content=(("number"==typeof r?r:o)-g).toFixed(0),t.dx1.content=(a-g).toFixed(0),t.dx2.content=(c-g).toFixed(0);const b=t.dx1.bounds;t.dx2.bounds;n>0?(t.dx1.justification="left",t.dx2.justification="right",t.dx1.position=f.add(d.normalize(-Math.sign(n)*((s.font_size+b.width)/2))).add(p.normalize(.6*-s.font_size)),t.dx2.position=m.add(d.normalize(Math.sign(n)*((s.font_size+b.width)/2))).add(p.normalize(.6*-s.font_size))):(t.dx1.justification="right",t.dx2.justification="left",t.dx1.position=m.add(d.normalize(-Math.sign(n)*((s.font_size+b.width)/2))).add(p.normalize(.6*-s.font_size)),t.dx2.position=f.add(d.normalize(Math.sign(n)*((s.font_size+b.width)/2))).add(p.normalize(.6*-s.font_size))),t.text.rotation=t.dx1.rotation=t.dx2.rotation=h.subtract(_).angle,t.text.position=f.add(m).divide(2).add(p.normalize(.8*s.font_size))}}i.DimensionLineImpost=g;class y extends m{get elm_type(){return t.enm.elm_types.Радиус}get path(){const{children:t,_attr:e}=this;if(!t.length)return;const{path:s}=e.elm1;if(!s)return;let i=s.getPointAt(e.p1);const r=s.getNormalAt(e.p1).normalize(100),o=new n.Path({insert:!1,segments:[i,i.add(r)]});return o.offset=0,o}redraw(){const{children:t,_attr:e,path:n,align:i}=this;if(!n)return void(this.visible=!1);this.visible=!0;const r=n.firstSegment.point,o=n.lastSegment.point,a=n.getPointAt(50),c=n.getNormalAt(0).multiply(10),l=a.add(c),_=a.subtract(c);if(t.callout1.segments.length?(t.callout1.firstSegment.point=r,t.callout1.lastSegment.point=l):t.callout1.addSegments([r,l]),t.callout2.segments.length?(t.callout2.firstSegment.point=r,t.callout2.lastSegment.point=_):t.callout2.addSegments([r,_]),t.scale.segments.length?(t.scale.firstSegment.point=r,t.scale.lastSegment.point=o):t.scale.addSegments([r,o]),t.text.rotation=o.subtract(r).angle,t.text.justification="left",e.by_curve){const n=Math.abs(e.elm1.path.getCurvatureAt(e.p1));n&&(t.text.content="R"+(1/n).round(0))}else{const{path:n,_attr:{_corns:s}}=e.elm1,i=e.p1>e.elm1.length?n.get_subpath(s[3],s[4]):n.get_subpath(s[1],s[2]);t.text.content="R"+i.ravg().round(0)}t.text.position=o.add(n.getTangentAt(0).multiply(1.4*s.font_size))}}i.DimensionRadius=y;class b extends n.Group{constructor(e){super(e),e.row||(e.row=this.project.ox.coordinates.add()),this._row=e.row,this._attr={},this._row.elm||(this._row.elm=this.project.ox.coordinates.aggregate([],["elm"],"max")+1),e._nearest&&(this._attr._nearest=e._nearest,this._attr.binded=!0,this._attr.simulated=!0,this._row.elm_type=t.enm.elm_types.Створка),e.proto?(e.proto.inset&&(this.inset=e.proto.inset),e.parent?this.parent=e.parent:e.proto.parent&&(this.parent=e.proto.parent),e.proto instanceof S&&this.insertBelow(e.proto),this.clr=e.proto.clr):e.parent&&(this.parent=e.parent),!this._row.cnstr&&this.layer.cnstr&&(this._row.cnstr=this.layer.cnstr),this._row.elm_type.empty()&&!this.inset.empty()&&(this._row.elm_type=this.nom.elm_type),this.project.register_change(),this.on("doubleclick",this.elm_dblclick)}get owner(){return this._attr.owner}set owner(t){this._attr.owner=t}get generatrix(){return this._attr.generatrix}set generatrix(t){const{_attr:e}=this,{generatrix:s}=e;if(s.removeSegments(),this.rays&&this.rays.clear(),t instanceof n.Path&&s.addSegments(t.segments),Array.isArray(t))s.addSegments(t);else if(t.proto&&t.p1&&t.p2){let n=t.proto;n.getDirectedAngle(t.ipoint)<0&&n.reverse();let i,r=n.getOffsetOf(t.p1),o=n.getOffsetOf(t.p2);r>o&&(i=o,o=r,r=i),r>0&&(n=n.split(r),o=n.getOffsetOf(t.p2)),o<n.length&&n.split(o),s.remove(),e.generatrix=n,e.generatrix.parent=this,this.layer.parent&&(e.generatrix.guide=!0)}}get path(){return this._attr.path}set path(t){if(t instanceof n.Path){const{_attr:e}=this;e.path.removeSegments(),e.path.addSegments(t.segments),e.path.closed||e.path.closePath(!0)}}get _metadata(){const{fields:e,tabular_sections:n}=this.project.ox._metadata(),s=this,i=n.coordinates.fields,r=Object.assign({},i.inset),o=Object.assign({},i.r,{synonym:"Высота дуги"}),a=Object.assign({},e.note,{synonym:"Элемент"}),c=Object.assign({},n.cnn_elmnts.fields.cnn),l=Object.assign({},c),_=Object.assign({},c),{iface:h,utils:p,cat:{inserts:d,cnns:u,clrs:f},enm:m,cch:g}=t;function y(t,e){const n=u.nom_cnn(s,e.profile,e.cnn_types);if(!h||p.is_data_obj(t))return n.some(e=>t.ref==e);{let t="";return n.forEach(e=>{t&&(t+=", "),t+="'"+e.ref+"'"}),"_t_.ref in ("+t+")"}}const{_inserts_types_filling:b}=d;r.choice_links=[{name:["selection","ref"],path:[(t,e)=>{const{sys:n}=this.project._dp;let s;if(this instanceof w){if(!h||p.is_data_obj(t)){const{thickness:e,insert_type:s,insert_glass_type:i}=d.get(t);return-1!=b.indexOf(s)&&e>=n.tmin&&e<=n.tmax&&(i.empty()||i==m.inserts_glass_types.Заполнение)}{let t="";return d.by_thickness(n.tmin,n.tmax).forEach(e=>{(e.insert_glass_type.empty()||e.insert_glass_type==m.inserts_glass_types.Заполнение)&&(t&&(t+=", "),t+="'"+e.ref+"'")}),"_t_.ref in ("+t+")"}}if(s=this instanceof S?this.nearest()?{elm_type:{in:[m.elm_types.Створка,m.elm_types.Добор]}}:{elm_type:{in:[m.elm_types.Рама,m.elm_types.Импост,m.elm_types.Добор]}}:{elm_type:this.nom.elm_type},!h||p.is_data_obj(t)){let e=!1;return s.nom=d.get(t),n.elmnts.find_rows(s,t=>(e=!0,!1)),e}{let t="";return n.elmnts.find_rows(s,e=>{t&&(t+=", "),t+="'"+e.nom.ref+"'"}),"_t_.ref in ("+t+")"}}]}],c.choice_links=[{name:["selection","ref"],path:[(t,e)=>y(t,this.rays.b)]}],l.choice_links=[{name:["selection","ref"],path:[(t,e)=>y(t,this.rays.e)]}],_.choice_links=[{name:["selection","ref"],path:[t=>{const e=this.selected_cnn_ii();let n=[p.blank.guid];if(e&&(n=e.elm instanceof w||e.elm.elm_type==m.elm_types.Створка&&this.elm_type!=m.elm_types.Створка?u.nom_cnn(e.elm,this,m.cnn_types.acn.ii):u.nom_cnn(this,e.elm,m.cnn_types.acn.ii)),!h||p.is_data_obj(t))return n.some(e=>t.ref==e);{let t="";return n.forEach(e=>{t&&(t+=", "),t+="'"+e.ref+"'"}),"_t_.ref in ("+t+")"}}]}],f.selection_exclude_service(i.clr,this);const x={info:a,inset:r,clr:i.clr,x1:i.x1,x2:i.x2,y1:i.y1,y2:i.y2,cnn1:c,cnn2:l,cnn3:_,arc_h:o,r:i.r,arc_ccw:i.arc_ccw,a1:Object.assign({},i.x1,{synonym:"Угол1"}),a2:Object.assign({},i.x1,{synonym:"Угол2"}),offset:Object.assign({},i.x1,{synonym:"Смещение"}),region:i.region};return{fields:new Proxy(x,{get(t,e){if(t[e])return t[e];const n=g.properties.get(e);if(n){const t={type:n.type,synonym:n.name};return n.type.types.includes("cat.property_values")&&(t.choice_params=[{name:"owner",path:n.ref}]),t}}})}}get _manager(){return this.project._dp._manager}get nom(){return this.inset.nom(this)}get elm(){return this._row&&this._row._obj.elm||0}get info(){return"№"+this.elm}get ref(){const{nom:t}=this;return t&&!t.empty()?t.ref:this.inset.ref}get width(){return this.inset.width(this)}get thickness(){return this.inset.thickness}get sizeb(){return this.inset.sizeb||0}get sizefurn(){return this.nom.sizefurn||20}get cnn3(){const e=this.selected_cnn_ii();return e?e.row.cnn:t.cat.cnns.get()}set cnn3(t){const e=this.selected_cnn_ii();e&&e.row.cnn!=t&&(e.row.cnn=t,this._attr._nearest_cnn&&(this._attr._nearest_cnn=e.row.cnn),this.rays&&this.rays.clear(),this.project.register_change())}get inset(){return t.cat.inserts.get(this._row&&this._row._obj.inset)}set inset(t){this.set_inset(t)}get clr(){return this._row.clr}set clr(t){this.set_clr(t)}set_inset(t,e){const{_row:n,_attr:s,project:i}=this;n.inset!=t&&(n.inset=t,s&&s._rays&&s._rays.clear(!0),i.register_change())}set_clr(t,e){this._row.clr!=t&&(this._row.clr=t,this.project.register_change()),this.path instanceof n.Path&&(this.path.fillColor=b.clr_by_clr.call(this,this._row.clr,!1))}t_parent(t){return this}selected_cnn_ii(){const{project:t,elm:e}=this,n=t.getSelectedItems(),{cnns:s}=t,i=[];let r;if(n.forEach(t=>{t.parent instanceof z||t.parent instanceof w?i.push(t.parent):t instanceof w&&i.push(t)}),i.length>1&&i.some(t=>t==this)&&i.some(t=>{if(t!=this&&(s.forEach(n=>{if(!n.node1&&!n.node2&&(n.elm1==e&&n.elm2==t.elm||n.elm1==t.elm&&n.elm2==e))return r={elm:t,row:n},!1}),r))return!0}))return r}remove(){this.detache_wnd&&this.detache_wnd();const{parent:t,project:e,observer:n,_row:i}=this;t&&t.on_remove_elm&&t.on_remove_elm(this),n&&(e._scope.eve.off(s.move_points,n),delete this.observer),i&&i._owner&&e.ox===i._owner._owner&&i._owner.del(i),e.register_change(),super.remove()}err_spec_row(e,n){e||(e=t.job_prm.nom.info_error);const{ox:s}=this.project;s.specification.find_rows({elm:this.elm,nom:e}).length||t.ProductsBuilding.new_spec_row({elm:this,row_base:{clr:t.cat.clrs.get(),nom:e},spec:s.specification,ox:s})}elm_dblclick(t){this.project._scope.eve.emit("elm_dblclick",this,t)}static clr_by_clr(t,e){let{clr_str:s,clr_in:i,clr_out:r}=t;if(e?!r.empty()&&r.clr_str&&(s=r.clr_str):!i.empty()&&i.clr_str&&(s=i.clr_str),s||(s=this.default_clr_str?this.default_clr_str:"fff"),s)return 1==(t=s.split(",")).length?("#"!=s[0]&&(s="#"+s),(t=new n.Color(s)).alpha=.96):4==t.length?t=new n.Color(t[0],t[1],t[2],t[3]):3==t.length&&(t=this.path&&this.path.bounds?new n.Color({stops:[t[0],t[1],t[2]],origin:this.path.bounds.bottomLeft,destination:this.path.bounds.topRight}):new n.Color(t[0])),t}}i.BuilderElement=b;class w extends(r(b)){constructor(t){const{path:e}=t;e&&delete t.path,super(t),e&&(t.path=e),this.initialize(t)}initialize(e){const s=e.row,{_attr:i,project:r}=this,o=r.bounds.height+r.bounds.y;if(s.path_data?i.path=new n.Path(s.path_data):e.path?(i.path=new n.Path,this.path=e.path):i.path=new n.Path([[s.x1,o-s.y1],[s.x1,o-s.y2],[s.x2,o-s.y2],[s.x2,o-s.y1]]),i.path.closePath(!0),i.path.reduce(),i.path.strokeWidth=0,s.inset.empty()&&(s.inset=r.default_inset({elm_type:[t.enm.elm_types.Стекло,t.enm.elm_types.Заполнение]})),s.clr.empty()&&r._dp.sys.elmnts.find_rows({nom:s.inset},t=>(s.clr=t.clr,!1)),s.clr.empty()&&r._dp.sys.elmnts.find_rows({elm_type:{in:[t.enm.elm_types.Стекло,t.enm.elm_types.Заполнение]}},t=>(s.clr=t.clr,!1)),this.clr=s.clr,s.elm_type.empty()&&(s.elm_type=t.enm.elm_types.Стекло),i.path.visible=!1,this.addChild(i.path),r.ox.coordinates.find_rows({cnstr:this.layer.cnstr,parent:this.elm,elm_type:t.enm.elm_types.Раскладка},t=>new A({row:t,parent:this})),e.proto){const t=[];r.ox.glass_specification.find_rows({elm:e.proto.elm},e=>{t.push({clr:e.clr,elm:this.elm,gno:e.gno,inset:e.inset})}),t.forEach(t=>r.ox.glass_specification.add(t))}}save_coordinates(){const{_row:e,project:n,profiles:s,bounds:i,imposts:r,nom:o}=this,a=n.bounds.height+n.bounds.y,{cnns:c}=n,{length:l}=s;let _,h,p;n.ox.glasses.add({elm:e.elm,nom:o,formula:this.formula(),width:i.width,height:i.height,s:this.area,is_rectangular:this.is_rectangular,is_sandwich:o.elm_type==t.enm.elm_types.Заполнение,thickness:this.thickness}),e.x1=(i.bottomLeft.x-n.bounds.x).round(3),e.y1=(a-i.bottomLeft.y).round(3),e.x2=(i.topRight.x-n.bounds.x).round(3),e.y2=(a-i.topRight.y).round(3),e.path_data=this.path.pathData;for(let e=0;e<l;e++){if(_=s[e],!_.profile||!_.profile._row||!_.cnn){if(t.job_prm.debug)throw new ReferenceError("Не найдено ребро заполнения");return}_.aperture_path=_.profile.generatrix.get_subpath(_.b,_.e)._reversed?_.profile.rays.outer:_.profile.rays.inner}for(let n=0;n<l;n++){h=0===n?s[l-1]:s[n-1],_=s[n],p=n===l-1?s[0]:s[n+1];const i=_.aperture_path.intersect_point(h.aperture_path,_.b,!0),r=_.aperture_path.intersect_point(p.aperture_path,_.e,!0);if(!i||!r){if(t.job_prm.debug)throw"Filling:path";return}c.add({elm1:e.elm,elm2:_.profile._row.elm,node1:"",node2:"",cnn:_.cnn.ref,aperture_len:_.aperture_path.get_subpath(i,r).length.round(1)})}for(let t=0;t<l;t++)delete s[t].aperture_path;r.forEach(t=>t.save_coordinates())}create_leaf(t,e){const{project:n,_row:s}=this;n.cnns.clear({elm1:this.elm});const i=new("virtual"===t?h:"nested"===t?_:l)({parent:this.parent});return i.path=this.profiles,"nested"===t?this.remove():(this.parent=i,s.cnstr=i.cnstr),e&&(i.direction=e),"string"!==typeof t&&(i.furn=t||n.default_furn),n.notify(i,"rows",{constructions:!0}),i.activate(),i}cnn_side(){return t.enm.cnn_sides.Изнутри}nearest(){return null}select_node(t){let e,n,s=1/0;e="b"===t?this.bounds.bottomLeft:this.bounds.topRight,this._attr.path.segments.forEach(t=>{t.selected=!1,e.getDistance(t.point)<s&&(s=e.getDistance(t.point),n=t)}),n&&(n.selected=!0,this.view.update())}setSelection(t){if(super.setSelection(t),t){const{path:t}=this;for(let e of this.children)e!=t&&(e.selected=!1)}}redraw(){this.sendToBack();const{path:t,imposts:e,_attr:i,is_rectangular:r}=this,{elm_font_size:o,font_family:a}=s,c=o*(2/3);t.visible=!0,e.forEach(t=>t.redraw()),this.purge_paths(),i._text||(i._text=new n.PointText({parent:this,fillColor:"black",fontFamily:a,fontSize:c,guide:!0,visible:!0}));const{bounds:l}=t;i._text.content=this.formula();const _=l.scale(.88);if(_.width=_.width>600?600:_.width,_.height=_.height>600?600:_.height,r){const t=1.5*_.width<_.height;t?(_.width=o,i._text.rotation=270):(_.height=o,i._text.rotation=0),i._text.fitBounds(_),i._text.point=t?l.bottomRight.add([-c,.6*-c]):l.bottomLeft.add([.6*c,-c])}else{_.height=o,i._text.rotation=0,i._text.fitBounds(_);const e=t.curves.reduce((t,e)=>e.length>t.length?e:t,t.curves[0]),{angle:s,angleInRadians:r}=e.line.vector,{PI:a}=Math;i._text.rotation=s;const c=new n.Point(Math.cos(r+a/4),Math.sin(r+a/4)).multiply(3*o);i._text.point=e.point1.add(c),Math.abs(s)>=85&&Math.abs(s)<=185&&(i._text.point=i._text.bounds.rightCenter,i._text.rotation+=180)}}draw_fragment(){const{l_dimensions:t,layer:e,path:n}=this;this.visible=!0,n.set({strokeColor:"black",strokeWidth:1,strokeScaling:!1,opacity:.6}),t.redraw(!0),e.draw_visualization();const{l_visualization:s}=e;s._by_insets&&s._by_insets.removeChildren(),s._cnn&&s._cnn.removeChildren(),s._opening&&s._opening.removeChildren(),s.visible=!0,e.zoom_fit()}set_inset(e,n){const s=t.cat.inserts.get(e);if(!n){const{project:t,elm:e}=this,{glass_specification:n}=t.ox;s.clr_group.default_clr(this),n.clear({elm:e}),t.selected_glasses().forEach(t=>{t!==this&&(t.set_inset(s,!0),n.clear({elm:t.elm}),t.clr=this.clr)})}super.set_inset(s)}set_clr(t,e){!e&&this.project.selectedItems.length>1&&this.project.selected_glasses().forEach(e=>{e!==this&&e.set_clr(t,!0)}),super.set_clr(t)}purge_paths(){const t=this.children.filter(t=>t instanceof n.Path),{path:e}=this;t.forEach(t=>t!==e&&t.remove())}fill_error(){const{path:t}=this;t.fillColor=new n.Color({stops:["#fee","#fcc","#fdd"],origin:t.bounds.bottomLeft,destination:t.bounds.topRight})}formula(e){let n;return this.project.ox.glass_specification.find_rows({elm:this.elm,inset:{not:t.utils.blank.guid}},({inset:t})=>{let{name:s,article:i}=t;const r=s.split(" ");e&&i?s=i:r.length&&(s=r[0]),n?n+=(e?"*":"x")+s:n=s}),n||e&&this.inset.article||this.inset.name}deselect_onlay_points(){for(const{generatrix:t}of this.imposts)t.segments.forEach(t=>{t.selected&&(t.selected=!1)}),t.selected&&(t.selected=!1)}get imposts(){return this.getItems({class:A})}get profiles(){return this._attr._profiles||[]}remove_onlays(){for(let t of this.imposts)t.remove()}remove(){this.remove_onlays(),super.remove()}get area(){return(this.bounds.area/1e6).round(5)}get form_area(){return(this.path.area/1e6).round(5)}interiorPoint(){return this.path.interiorPoint}get is_rectangular(){const{profiles:t,path:e}=this;return 4===t.length&&!e.hasHandles()&&!t.some(({profile:t})=>!(Math.abs(t.angle_hor%90)<.2))}get generatrix(){return this.path}get path(){return this._attr.path}set path(e){let{_attr:i,path:r}=this;if(r?r.removeSegments():r=i.path=new n.Path({parent:this}),Array.isArray(i._profiles)?i._profiles.length=0:i._profiles=[],e instanceof n.Path)r.addSegments(e.segments);else if(Array.isArray(e)){let n,o,a,c,{length:l}=e;for(let n=0;n<l;n++)o=e[n],a=n===l-1?e[0]:e[n+1],c=o.profile.generatrix.get_subpath(o.b,o.e),o.cnn=t.cat.cnns.elm_cnn(this,o.profile,t.enm.cnn_types.acn.ii,o.cnn||this.project.elm_cnn(this,o.profile),!1,o.outer),o.sub_path=c.equidistant((c._reversed?-o.profile.d1:o.profile.d2)+(o.cnn?o.cnn.size(this):20),s.sticking);for(let s=0;s<l;s++)if(n=0===s?e[l-1]:e[s-1],o=e[s],a=s===l-1?e[0]:e[s+1],o.pb||(o.pb=n.pe=o.sub_path.intersect_point(n.sub_path,o.b,!0)),o.pe||(o.pe=a.pb=o.sub_path.intersect_point(a.sub_path,o.e,!0)),o.pb&&o.pe)o.sub_path=o.sub_path.get_subpath(o.pb,o.pe);else if(t.job_prm.debug)throw"Filling:path";const _=[];for(let t=0;t<l;t++){n=0===t?e[l-1]:e[t-1],a=t===l-1?e[0]:e[t+1];const s=n.sub_path.getCrossings(a.sub_path);if(s.length&&(n.e.getDistance(s[0].point)<2*n.profile.width||a.b.getDistance(s[0].point)<2*a.profile.width)){_.push(e[t]),n.sub_path.splitAt(s[0]);const i=a.sub_path.getLocationOf(s[0].point);a.sub_path=a.sub_path.splitAt(i)}}for(const t of _)e.splice(e.indexOf(t),1),l--;for(let t=0;t<l;t++)o=e[t],r.addSegments(o.sub_path.segments),["anext","pb","pe"].forEach(t=>{delete o[t]}),i._profiles.push(o)}r.segments.length&&!r.closed&&r.closePath(!0);const o=r.self_intersections();if(o.length){const{curves:t,segments:n}=r,s=new Set;for(const{point:t}of o)for(const n of e)n._sub.b.is_nearest(t,!0)&&n._sub.e.is_nearest(t,!0)&&s.add(n);if(s.size)return s.forEach(t=>{const n=e.indexOf(t);e.splice(n,1)}),this.path=e}r.reduce()}get nodes(){let t=this.profiles.map(t=>t.b);if(!t.length){const{path:e,parent:n}=this;e&&(t=n.glass_nodes(e))}return t}get outer_profiles(){return this.profiles}get perimeter(){const t=[];return this.profiles.forEach(e=>{const n={len:e.sub_path.length,angle:e.e.subtract(e.b).angle,profile:e.profile};t.push(n),n.angle<0&&(n.angle+=360)}),t}get bounds(){const{path:t}=this;return t?t.bounds:new n.Rectangle}perimeter_inner(t=0){const{center:e}=this.bounds,n=this.outer_profiles.map(t=>{const n=t.profile||t.elm,{inner:s,outer:i}=n.rays,r=s.getNearestPoint(e).getDistance(e,!0)<i.getNearestPoint(e).getDistance(e,!0)?s.get_subpath(s.getNearestPoint(t.b),s.getNearestPoint(t.e)):i.get_subpath(i.getNearestPoint(t.b),i.getNearestPoint(t.e));let o=t.e.subtract(t.b).angle.round(1);return o<0&&(o+=360),{profile:n,sub_path:r,angle:o,b:t.b,e:t.e}}),s=n.length-1;return n.map((e,i)=>{let r=e.sub_path.equidistant(t);const o=i?n[i-1]:n[s],a=i==s?n[0]:n[i+1],c=r.intersect_point(o.sub_path.equidistant(t),e.b,!0),l=r.intersect_point(a.sub_path.equidistant(t),e.e,!0);return c&&l&&(r=r.get_subpath(c,l)),{profile:e.profile,angle:e.angle,len:r.length,sub_path:r}})}bounds_light(t=0){const e=new n.Path({insert:!1});for(const{sub_path:n}of this.perimeter_inner(t))e.addSegments(n.segments);return e.segments.length&&!e.closed&&e.closePath(!0),e.reduce(),e.bounds}get x1(){return(this.bounds.left-this.project.bounds.x).round(1)}get x2(){return(this.bounds.right-this.project.bounds.x).round(1)}get y1(){return(this.project.bounds.height+this.project.bounds.y-this.bounds.bottom).round(1)}get y2(){return(this.project.bounds.height+this.project.bounds.y-this.bounds.top).round(1)}get info(){const{elm:t,bounds:e,thickness:n}=this;return"№"+t+" w:"+e.width.toFixed(0)+" h:"+e.height.toFixed(0)+" z:"+n.toFixed(0)}get oxml(){const t={" ":[{id:"info",path:"o.info",type:"ro"},"inset","clr"],Начало:[{id:"x1",path:"o.x1",synonym:"X1",type:"ro"},{id:"y1",path:"o.y1",synonym:"Y1",type:"ro"}],Конец:[{id:"x2",path:"o.x2",synonym:"X2",type:"ro"},{id:"y2",path:"o.y2",synonym:"Y2",type:"ro"}]};return this.selected_cnn_ii()&&(t["Примыкание"]=["cnn3"]),t}get default_clr_str(){return"#def,#d0ddff,#eff"}get ref(){return this.thickness.toFixed()}get inset(){const{_attr:t,_row:e}=this;return t._ins_proxy&&t._ins_proxy.ref==e.inset||(t._ins_proxy=new Proxy(e.inset,{get:(t,n)=>{switch(n){case"presentation":return this.formula();case"thickness":let s=0;return this.project.ox.glass_specification.find_rows({elm:this.elm},t=>{s+=t.inset.thickness}),s||e.inset.thickness;default:return t[n]}}})),t._ins_proxy}set inset(t){this.set_inset(t)}}i.Filling=w;class x extends n.PointText{constructor(t){if(!t.fontSize&&(t.fontSize=s.font_size,t.parent)){const{width:e,height:n}=t.parent.project.bounds,{cutoff:i,font_size:r}=s,o=Math.max(e-i,n-i)/60;t.fontSize+=(o>0?o:0).round()}t.fontFamily=s.font_family,super(t),t.row?this._row=t.row:this._row=t.row=this.project.ox.coordinates.add();const{_row:e}=this;if(e.cnstr||(e.cnstr=t.parent.layer.cnstr),e.elm||(e.elm=this.project.ox.coordinates.aggregate([],["elm"],"max")+1),t.point)t.point instanceof n.Point?this.point=t.point:this.point=new n.Point(t.point);else if(this.clr=e.clr,this.angle=e.angle_hor,e.path_data){var i=JSON.parse(e.path_data);this.x=e.x1+i.bounds_x||0,this.y=e.y1-i.bounds_y||0,this._mixin(i,null,["bounds_x","bounds_y"])}else this.x=e.x1,this.y=e.y1;this.bringToFront()}remove(){this._row._owner.del(this._row),this._row=null,n.PointText.prototype.remove.call(this)}save_coordinates(){const{_row:t}=this;t.x1=this.x,t.y1=this.y,t.angle_hor=this.angle,t.elm_type=this.elm_type,t.path_data=JSON.stringify({text:this.text,font_family:this.font_family,font_size:this.font_size,bold:this.bold,align:this.align.ref,bounds_x:this.project.bounds.x,bounds_y:this.project.bounds.y})}move_points(t){this.point=t,this.project.notify(this,"update",{x:!0,y:!0})}get elm_type(){return t.enm.elm_types.Текст}_metadata(e){return t.dp.builder_text.metadata(e)}get _manager(){return t.dp.builder_text}get clr(){return this._row?this._row.clr:t.cat.clrs.get()}set clr(t){this._row.clr=t,6==this._row.clr.clr_str.length&&(this.fillColor="#"+this._row.clr.clr_str),this.project.register_update()}get font_family(){return this.fontFamily||""}set font_family(t){this.fontFamily=t,this.project.register_update()}get font_size(){return this.fontSize||s.font_size}set font_size(t){this.fontSize=t,this.project.register_update()}get bold(){return"normal"!=this.fontWeight}set bold(t){this.fontWeight=t?"bold":"normal"}get x(){return(this.point.x-this.project.bounds.x).round(1)}set x(t){this.point.x=parseFloat(t)+this.project.bounds.x,this.project.register_update()}get y(){const{bounds:t}=this.project;return(t.height+t.y-this.point.y).round(1)}set y(t){const{bounds:e}=this.project;this.point.y=e.height+e.y-parseFloat(t)}get text(){return this.content}set text(t){const{project:e}=this;t?(this.content=t,e.register_update()):(e.notify(this,"unload"),setTimeout(this.remove.bind(this),50))}get angle(){return Math.round(this.rotation)}set angle(t){this.rotation=t,this.project.register_update()}get align(){return t.enm.text_aligns.get(this.justification)}set align(e){this.justification=t.utils.is_data_obj(e)?e.ref:e,this.project.register_update()}}i.FreeText=x;class v extends b{constructor(t={}){const{generatrix:e}=t;e&&delete t.generatrix,super(t),e&&(t.generatrix=e),this.initialize(t)}get b(){const{generatrix:t}=this._attr;return t&&t.firstSegment.point}set b(t){const{_rays:e,generatrix:n}=this._attr;e.clear(),n&&(n.firstSegment.point=t)}get e(){const{generatrix:t}=this._attr;return t&&t.lastSegment.point}set e(t){const{_rays:e,generatrix:n}=this._attr;e.clear(),n&&(n.lastSegment.point=t)}get x1(){const{bounds:t}=this.project;return t?(this.b.x-t.x).round(1):0}set x1(t){const{bounds:e}=this.project;e&&(t=parseFloat(t)+e.x-this.b.x)&&(this.select_node("b"),this.move_points(new n.Point(t,0)))}get y1(){const{bounds:t}=this.project;return t?(t.height+t.y-this.b.y).round(1):0}set y1(t){const{bounds:e}=this.project;e&&(t=e.height+e.y-parseFloat(t)-this.b.y)&&(this.select_node("b"),this.move_points(new n.Point(0,t)))}get x2(){const{bounds:t}=this.project;return t?(this.e.x-t.x).round(1):0}set x2(t){const{bounds:e}=this.project;e&&(t=parseFloat(t)+e.x-this.e.x)&&(this.select_node("e"),this.move_points(new n.Point(t,0)))}get y2(){const{bounds:t}=this.project;return t?(t.height+t.y-this.e.y).round(1):0}set y2(t){const{bounds:e}=this.project;e&&(t=e.height+e.y-parseFloat(t)-this.e.y)&&(this.select_node("e"),this.move_points(new n.Point(0,t)))}select_node(t){const{generatrix:e,project:n,_attr:s,view:i}=this;n.deselect_all_points(),s.path&&(s.path.selected=!1),"b"==t?e.firstSegment.selected=!0:e.lastSegment.selected=!0,i.update()}move_points(e,i,r){if(!e.length)return;const o=[],a={type:s.move_points,profiles:[this],points:[]};let c;i||(i=!this.generatrix.segments.some(t=>{if(t.selected)return!0}));const l=this.joined_imposts?this.joined_imposts():{inner:[],outer:[]},_=[];if(l.inner.concat(l.outer).forEach(({profile:t})=>{const{b:e,e:n}=t.rays;e.profile===this&&_.push({profile:t,node:"b"}),n.profile===this&&_.push({profile:t,node:"e"})}),this.generatrix.segments.forEach(l=>{let _;if(l.selected||i){const i={old:l.point.clone(),delta:e},h=l.point.add(e);l.point==this.b?(_=this.rays.b,_.profile_point&&!n.Key.isDown("control")||(_=this.cnn_point("b",h))):l.point==this.e&&(_=this.rays.e,_.profile_point&&!n.Key.isDown("control")||(_=this.cnn_point("e",h)));let{profile:p,profile_point:d}=_||{};if(!_||_.cnn_types!=t.enm.cnn_types.acn.t||l.point!=this.b&&l.point!=this.e)l.point=h,_&&!n.Key.isDown("control")&&p&&d&&!p[d].is_nearest(h)&&(this instanceof A?this.move_nodes(i.old,h):(o.push("b"==d?p.generatrix.firstSegment:p.generatrix.lastSegment),a.profiles.push(p),_.is_cut&&this.layer.profiles.some(t=>{if(t!==p&&t!==this){if(p[d].is_nearest(t.b))return t.b=h,o.push(t.generatrix.firstSegment),a.profiles.push(t),!0;if(p[d].is_nearest(t.e))return t.e=h,o.push(t.generatrix.lastSegment),a.profiles.push(t),!0}}),p[d]=h));else if(_.point.is_nearest(h,0))l.point=_.point;else{const t=(p.nearest(!0)?p.rays.outer:p.generatrix).clone({insert:!1}),{bounds:i}=t;if(Math.abs(e.y)<s.epsilon){const e=new n.Path({insert:!1,segments:[[h.x,i.top],[h.x,i.bottom]]});l.point=t.intersect_point(e,h,!0)||h}else if(Math.abs(e.x)<s.epsilon){const e=new n.Path({insert:!1,segments:[[i.left,h.y],[i.right,h.y]]});l.point=t.intersect_point(e,h,!0)||h}else l.point=h}i.new=l.point,r&&(i.start=r),a.points.push(i),c=!0}}),c){const{_attr:{_rays:t},layer:e,project:n}=this;t.clear(),_.forEach(({profile:t,node:e})=>{t.do_sub_bind(this,e),t.rays.clear(),o.push(t.generatrix["b"===e?"firstSegment":"lastSegment"]),!a.profiles.includes(t)&&a.profiles.push(t)}),t.clear(),e&&e.notify&&e.notify(a),n.notify(this,"update",{x1:!0,x2:!0,y1:!0,y2:!0})}return o}do_sub_bind(t,e){const n=(t.nearest(!0)?t.rays.outer:t.generatrix).clone({insert:!1});let s=n.getNearestPoint(this[e]);if(!s.is_nearest(this[e],0)){const t=this.generatrix.clone({insert:!1}).elongation(3e3);return s=n.intersect_point(t,s,!0),this[e]=s,!0}}}i.GeneratrixElement=v;class j extends n.Group{constructor(t){super(),this.parent=this.project.l_dimensions;const e=new n.Color(0,.7,0,.8),s=new n.Color(.1,.4,0,.9),i=new n.Color(0,0,.7,.8);this._attr={lines_color:i,points_color:e,sel_color:s,step:t.step,offset:t.offset,angle:t.angle,bind:t.bind,line:new n.Path({parent:this,strokeColor:new n.Color(0,0,.7),strokeWidth:2,strokeScaling:!1}),point:new n.Path.Circle({parent:this,guide:!0,radius:22,fillColor:e}),lines:new n.Group({parent:this,guide:!0,strokeColor:i,strokeScaling:!1})}}get path(){return this._attr.path}set path(t){this._attr.path=t,this._attr.angle=0,this.set_bind(),this.set_line()}set_line(){const{bind:t,offset:e,path:n,line:s,angle:i}=this._attr;let{firstSegment:{point:r},lastSegment:{point:o}}=n;"e"===t&&([r,o]=[o,r]),s.segments.length?(s.segments[0].point=r,s.segments[1].point=o):s.addSegments([r,o]);const a=o.subtract(r).angle.round(2);let c=1/0;if(i)for(const t of[i,i-180,i+180])Math.abs(t-a)<Math.abs(c)&&(c=t-a);else for(let t=-180;t<=180;t+=45)Math.abs(t-a)<Math.abs(c)&&(c=t-a);c&&(s.rotate(c),s.elongation(3e3),s.firstSegment.point=s.getNearestPoint(r),s.lastSegment.point=s.getNearestPoint(o));const l=s.getNormalAt(0).multiply(e);s.firstSegment.point=s.firstSegment.point.subtract(l),s.lastSegment.point=s.lastSegment.point.subtract(l)}set_bind(){const{point:t,path:e,bind:n}=this._attr;switch(n){case"b":t.position=e.firstSegment.point;break;case"e":t.position=e.lastSegment.point;break;case"product":t.position=this.project.bounds.bottomLeft;break;case"contour":t.position=e.layer.bounds.bottomLeft}}get bind(){return this._attr.bind}set bind(t){this._attr.bind=t,this.set_bind(),this.set_line()}get step(){return this._attr.step}set step(t){this._attr.step=t,this.set_line()}get angle(){return this._attr.angle}set angle(t){this._attr.angle!==t&&(this._attr.angle=t,this.set_line())}get offset(){return this._attr.offset}set offset(t){this._attr.offset=t,this.set_line()}grid_points(t){const{path:e,line:s,lines:i,lines_color:r,sel_color:o,step:a,bind:c,point:{position:l}}=this._attr,_=[],h=s.getNormalAt(0).multiply(1e4);let p,d;function u(e,s,a,c){let h;l.getDistance(c)>20&&(h=new n.Path.Circle({parent:i,guide:!0,radius:22,center:c,fillColor:r}));const p=new n.Path({parent:i,guide:!0,strokeColor:r,strokeScaling:!1,segments:[a,c]}),d=e.getOffsetOf(a),u=e.getOffsetOf(c);_.push({x:s.round(1),y:(u-d).round(1)}),Math.abs(s-t)<10&&(h&&(h.fillColor=o),p.strokeColor=o)}i.removeChildren();for(let t=0;t<s.length+a;t+=a){if(t>=s.length){if(p)break;p=!0,t=s.length}if(d&&t-d<a/4)break;d=t;const i=t<s.length?s.getPointAt(t):s.lastSegment.point,r=new n.Path({segments:[i.subtract(h),i.add(h)],insert:!1}),o=e.getIntersections(r);o.length?u(r,t,i,o[0].point):t<a/2?u(r,t,i,"e"===c?e.lastSegment.point:e.firstSegment.point):t>s.length-a/2&&u(r,t,i,"e"===c?e.firstSegment.point:e.lastSegment.point)}return _}}i.GridCoordinates=j,Object.defineProperties(n.Path.prototype,{getDirectedAngle:{value:function(t){t||(t=this.interiorPoint);const e=this.getNearestPoint(t),n=this.getOffsetOf(e);return this.getTangentAt(n).getDirectedAngle(t.add(e.negate()))}},self_intersections:{value:function(t){const{curves:e}=this,n=[];return e.some((s,i)=>e.some((e,r)=>{if(r<=i)return;const o=s.getIntersections(e);if(o.length){const{point:i}=o[0];if(o.length>1&&(n.push({crv1:s,crv2:e,point:i}),t))return!0;if(e.point1.is_nearest(s.point2,0)&&i.is_nearest(s.point2,0))return;if(s.point1.is_nearest(e.point2,0)&&i.is_nearest(s.point1,0))return;if(n.push({crv1:s,crv2:e,point:i}),t)return!0}})),n}},is_self_intersected:{value:function(){return this.self_intersections(!0).length>0}},angle_to:{value:function(t,e,n,s){const i=this.getNearestPoint(e),r=t.getNearestPoint(e),o=this.getTangentAt(this.getOffsetOf(i));let a=t.getTangentAt(t.getOffsetOf(r)).angle-o.angle;return a<0&&(a+=360),n&&a>180&&(a=180-(a-180)),s?a.round(s):a.round(1)}},is_linear:{value:function(){const{curves:t,firstCurve:e}=this;if(1===t.length&&(!e.hasHandles()||e.isLinear()))return!0;if(this.hasHandles())return!1;{const n=e.point1.getDirectedAngle(e.point2);for(let e=1;e<t.length;e++){const i=t[e].point1.getDirectedAngle(t[e].point2);if(Math.abs(i-n)>s.epsilon)return!1}}return!0}},is_nearest:{value:function(t,e){return t.is_nearest(this.getNearestPoint(t),e)}},get_subpath:{value:function(t,e){let s;if(!this.length||!t||!e||t.is_nearest(this.firstSegment.point)&&e.is_nearest(this.lastSegment.point))s=this.clone(!1);else if(e.is_nearest(this.firstSegment.point)&&t.is_nearest(this.lastSegment.point))s=this.clone(!1),s.reverse(),s._reversed=!0;else{const i=this.getLocationOf(t)||this.getNearestLocation(t),r=this.getLocationOf(e)||this.getNearestLocation(e),o=i.offset,a=r.offset;if(this.is_linear())s=new n.Path({segments:[i.point,r.point],insert:!1});else{const t=.02*(a-o);if(s=new n.Path({segments:[i.point],insert:!1}),t<0){s._reversed=!0;for(let e=o+t;e>a;e+=t)s.add(this.getPointAt(e))}else if(t>0)for(let e=o+t;e<a;e+=t)s.add(this.getPointAt(e));s.add(r.point),s.simplify(.8)}o>a&&(s._reversed=!0)}return s}},equidistant:{value:function(t,e){let s=this.getNormalAt(0);const i=new n.Path({segments:[this.firstSegment.point.add(s.multiply(t))],insert:!1});if(this.is_linear())i.add(this.lastSegment.point.add(s.multiply(t)));else{this.firstSegment.handleIn.length&&(i.firstSegment.handleIn=this.firstSegment.handleIn.clone()),this.firstSegment.handleOut.length&&(i.firstSegment.handleOut=this.firstSegment.handleOut.clone());let e,n=this.length,r=.02*n;for(let o=r;o<n;o+=r)e=this.getPointAt(o),e&&(s=this.getNormalAt(o),i.add(e.add(s.multiply(t))));s=this.getNormalAt(n),i.add(this.lastSegment.point.add(s.multiply(t))),this.lastSegment.handleIn.length&&(i.lastSegment.handleIn=this.lastSegment.handleIn.clone()),this.lastSegment.handleOut.length&&(i.lastSegment.handleOut=this.lastSegment.handleOut.clone()),i.simplify(.8)}return i.elongation(e)}},elongation:{value:function(t){if(t)if(this.is_linear()){let e=this.getTangentAt(0);this.firstSegment.point=this.firstSegment.point.add(e.multiply(-t)),this.lastSegment.point=this.lastSegment.point.add(e.multiply(t))}else{const{length:e}=this;let n=this.getTangentAt(.01*e);this.insert(0,this.firstSegment.point.add(n.multiply(-t))),n=this.getTangentAt(.99*e),this.add(this.lastSegment.point.add(n.multiply(t)))}return this}},intersect_point:{value:function(t,e,n,s){const i=this.getIntersections(t);let r,o,a=1/0;if(1===i.length)return i[0].point;if(i.length>1)return"string"===typeof e&&this.parent&&(e=this.parent[e]),e||(e=this.getPointAt(this.length/2)),i.forEach(t=>{if(r=t.point.getDistance(e,!0),s){if(t.point.getDistance(s,!0)<r)return}r<a&&(a=r,o=t.point)}),o;if("nearest"==n)return this.getNearestPoint(t.getNearestPoint(e));if(n){let i,r=this.getNearestPoint(e),o=t.getNearestPoint(e),a=this.firstSegment.point.getDistance(r,!0)>this.lastSegment.point.getDistance(r,!0),c=t.firstSegment.point.getDistance(o,!0)>t.lastSegment.point.getDistance(o,!0);return this.closed||(i=(a?this.getTangentAt(this.length):this.getTangentAt(0).negate()).multiply("number"===typeof n?n:100),this.is_linear&&(a?this.lastSegment.point=this.lastSegment.point.add(i):this.firstSegment.point=this.firstSegment.point.add(i))),t.closed||(i=(c?t.getTangentAt(t.length):t.getTangentAt(0).negate()).multiply("number"===typeof n?n:100),t.is_linear&&(c?t.lastSegment.point=t.lastSegment.point.add(i):t.firstSegment.point=t.firstSegment.point.add(i))),this.intersect_point(t,e,!1,s)}}},point_pos:{value:function(t,e){const s=this.getNearestPoint(e),i=this.getOffsetOf(s);return new n.Line(s,s.add(this.getTangentAt(i))).getSide(t,!0)}},rmin:{value(){if(!this.hasHandles())return 0;const{length:t}=this,e=t/9;let n=0;for(let s=0;s<t;s+=e){const t=Math.abs(this.getCurvatureAt(s));t>n&&(n=t)}return 0===n?0:1/n}},rmax:{value(){if(!this.hasHandles())return 0;const{length:t}=this,e=t/9;let n=1/0;for(let s=0;s<t;s+=e){const t=Math.abs(this.getCurvatureAt(s));t<n&&(n=t)}return 0===n?0:1/n}},ravg:{value(){if(!this.hasHandles())return 0;const t=this.firstSegment.point,e=this.lastSegment.point,n=t.add(e).divide(2),s=this.getPointAt(this.length/2);return n.arc_r(t.x,t.y,e.x,e.y,n.getDistance(s))}}}),Object.defineProperties(n.Point.prototype,{is_nearest:{value:function(t,e){return 0===e?Math.abs(this.x-t.x)<s.epsilon&&Math.abs(this.y-t.y)<s.epsilon:this.getDistance(t,!0)<(e?s.sticking2:16)}},point_pos:{value:function(t,e,n,s){return Math.abs(t-n)<.2?(this.x-t)*(e-s):Math.abs(e-s)<.2?(this.y-e)*(n-t):(this.y-e)*(n-t)-(s-e)*(this.x-t)}},arc_cntr:{value(t,e,s,i,r,o){let a,c,l,_,h,p,d,u,f;if(o){const n=t,r=e;t=s,e=i,s=n,i=r}return t!=s?(a=(t*t-s*s-i*i+e*e)/(2*(t-s)),c=(i-e)/(t-s),l=c*c+1,_=-2*((t-a)*c+e),h=(t-a)*(t-a)-r*r+e*e,p=(-_+Math.sqrt(_*_-4*l*h))/(2*l),d=a+c*p,u=(-_-Math.sqrt(_*_-4*l*h))/(2*l),f=a+c*u):(a=(e*e-i*i-s*s+t*t)/(2*(e-i)),c=(s-t)/(e-i),l=c*c+1,_=-2*((e-a)*c+t),h=(e-a)*(e-a)-r*r+t*t,d=(-_-Math.sqrt(_*_-4*l*h))/(2*l),p=a+c*d,f=(-_+Math.sqrt(_*_-4*l*h))/(2*l),u=a+c*f),new n.Point(d,p).point_pos(t,e,s,i)>0?{x:d,y:p}:{x:f,y:u}}},arc_point:{value(t,e,n,s,i,r,o){const a={x:(t+n)/2,y:(e+s)/2};if(i>0){let c,l,_=t-n,h=e-s,p=i*i-(_*_+h*h)/4;if(p>=0){const d=this.arc_cntr(t,e,n,s,i,r);_=a.x-d.x,h=a.y-d.y,c=Math.sqrt(_*_+h*h),l=o?i+Math.sqrt(p):i-Math.sqrt(p),a.x+=_*l/c,a.y+=h*l/c}}return a}},arc_r:{value(t,e,n,s,i){if(!i)return 0;const[r,o]=[t-n,e-s];return(i/2+(r*r+o*o)/(8*i)).round(3)}},snap_to_angle:{value:function(t){t||(t=2*Math.PI/8);let e=Math.atan2(this.y,this.x);e=Math.round(e/t)*t;const s=Math.cos(e),i=Math.sin(e),r=s*this.x+i*this.y;return new n.Point(10*(s*r/10).round(),10*(i*r/10).round())}},bind_to_nodes:{value:function(t,{activeLayer:e}){return e&&e.nodes.some(e=>{if(e.is_nearest(this,t))return this.x=e.x,this.y=e.y,!0})}}});class k{constructor(t,e){this._parent=t,this.node=e,this.initialize()}get is_t(){const{cnn:e,parent:n,profile:s,profile_point:i}=this,{cnn_types:r,orientations:o}=t.enm;return!(!s||i)||!(!e||e.cnn_type==r.ad)&&(e.cnn_type==r.t||(e.cnn_type==r.av&&n.orientation!=o.vert||e.cnn_type==r.ah&&n.orientation!=o.hor))}get is_tt(){return!(this.is_i||"b"==this.profile_point||"e"==this.profile_point||this.profile==this.parent)}get is_l(){const{cnn:e}=this,{cnn_types:n}=t.enm;return this.is_t||!(!e||e.cnn_type!==n.av&&e.cnn_type!==n.ah)}get is_i(){return!this.profile&&!this.is_cut}get is_x(){const{cnn:e}=this;return e&&e.cnn_type===t.enm.cnn_types.xx}get parent(){return this._parent}clear(){this.profile_point&&(this.profile_point=""),this.is_cut&&(this.is_cut=!1),this.profile=null,this.err=null,this.distance=1/0,this.cnn_types=t.enm.cnn_types.acn.i,this.cnn&&this.cnn.cnn_type!=t.enm.cnn_types.i&&(this.cnn=null);const{_corns:e}=this._parent._attr;e.length>5&&(e.length=5)}get err(){return this._err}set err(t){t?-1==this._err.indexOf(t)&&this._err.push(t):this._err.length=0}check_err(e){const{node:s,_parent:i}=this,{_corns:r,_rays:o}=i._attr,a="b"==s?r[1].getDistance(r[4]):r[2].getDistance(r[3]),c=i.angle_at(s),{cnn:l}=this;(!l||l.lmin&&l.lmin>a||l.lmax&&l.lmax<a||l.amin&&l.amin>c||l.amax&&l.amax<c)&&(e?Object.assign(new n.Path.Circle({center:"b"==s?r[4].add(r[1]).divide(2):r[2].add(r[3]).divide(2),radius:e.radius||70}),e):i.err_spec_row(t.job_prm.nom.critical_error,l?t.msg.err_seam_len:t.msg.err_no_cnn))}get profile(){return void 0===this._profile&&this._row&&this._row.elm2&&(this._profile=this.parent.layer.getItem({elm:this._row.elm2}),delete this._row),this._profile}set profile(t){this._profile=t}get npoint(){const t=this.point||this.parent[this.node];if(!this.is_tt)return t;const{profile:e}=this;return e&&e.nearest(!0)&&e.nearest(!0).generatrix.getNearestPoint(t)||t}len_angl(){const{is_t:e,cnn:n}=this,s=n&&n.cnn_type===t.enm.cnn_types.av;return{angle:90,art1:s?!e:e,art2:s?e:!e}}initialize(){const{_parent:e,node:n}=this;this._err=[],this._row=e.project.cnns.find({elm1:e.elm,node1:n}),this._profile,this._row?(this.cnn=this._row.cnn,-1!=t.enm.cnn_types.acn.a.indexOf(this.cnn.cnn_type)?this.cnn_types=t.enm.cnn_types.acn.a:-1!=t.enm.cnn_types.acn.t.indexOf(this.cnn.cnn_type)?this.cnn_types=t.enm.cnn_types.acn.t:this.cnn_types=t.enm.cnn_types.acn.i):(this.cnn=null,this.cnn_types=t.enm.cnn_types.acn.i),this.distance=1/0,this.point=null,this.profile_point=""}}class P{constructor(t){this.parent=t,this.b=new k(this.parent,"b"),this.e=new k(this.parent,"e"),this.inner=new n.Path({insert:!1}),this.outer=new n.Path({insert:!1})}clear_segments(){this.inner.segments.length&&this.inner.removeSegments(),this.outer.segments.length&&this.outer.removeSegments()}clear(t){this.clear_segments(),t&&(this.b.clear(),this.e.clear())}recalc(){const{parent:t}=this,e=t.generatrix,n=e.length;if(this.clear(),!n)return;const{d1:s,d2:i,width:r}=t,o=3*r,a=.02*n;let c,l,_=e.firstSegment.point,h=e.getTangentAt(0),p=e.getNormalAt(0),d=e.lastSegment.point;if(this.outer.add(_.add(p.multiply(s)).add(h.multiply(-o))),this.inner.add(_.add(p.multiply(i)).add(h.multiply(-o))),e.is_linear())this.outer.add(d.add(p.multiply(s)).add(h.multiply(o))),this.inner.add(d.add(p.multiply(i)).add(h.multiply(o)));else{this.outer.add(_.add(p.multiply(s))),this.inner.add(_.add(p.multiply(i)));for(let t=a;t<n;t+=a)_=e.getPointAt(t),p=e.getNormalAt(t),this.outer.add(_.add(p.normalize(s))),this.inner.add(_.add(p.normalize(i)));l=e.getNormalAt(n),this.outer.add(d.add(l.multiply(s))),this.inner.add(d.add(l.multiply(i))),c=e.getTangentAt(n),this.outer.add(d.add(l.multiply(s)).add(c.multiply(o))),this.inner.add(d.add(l.multiply(i)).add(c.multiply(o)))}this.inner.reverse()}}class z extends v{get d1(){return-(this.d0-this.sizeb)}get d2(){return this.d1-this.width}get offset(){const{_row:t}=this;return t&&t.offset||0}set offset(t){const{_row:e,_attr:n,selected:s}=this;if(t=parseFloat(t)||0,e&&e.offset!==t){e.offset=t,s&&(this.selected=!1);const i=this.joined_nearests?this.joined_nearests():[];if(this.joined_imposts){const t=this.joined_imposts();i.push.apply(i,t.inner.map(t=>t.profile).concat(t.outer.map(t=>t.profile)))}for(const t of i)t._attr._rays&&t._attr._rays.clear();n._rays&&n._rays.clear(),this.project.register_change(!0),s&&(this.selected=!0)}}hhpoint(t){const{layer:e,rays:n}=this,{h_ruch:s,furn:i}=e,{furn_set:r,handle_side:o}=i;if(s&&o&&!r.empty())return e.profile_by_furn_side(o)==this?n[t].intersect_point(e.handle_line(this)):void 0}get hhi(){return this.hhpoint("inner")}get hho(){return this.hhpoint("outer")}get cnn1(){return this.getcnnn("b")}set cnn1(t){this.setcnnn(t,"b")}get cnn2(){return this.getcnnn("e")}set cnn2(t){this.setcnnn(t,"e")}getcnnn(e){return this.cnn_point(e).cnn||t.cat.cnns.get()}setcnnn(e,n){const{rays:s}=this,i=t.cat.cnns.get(e);s[n].cnn!=i&&(s[n].cnn=i,this.project.register_change())}get gb(){return this.gn("b")}get ge(){return this.gn("e")}gn(t){if(this.layer.layer){const{profile:e,is_t:n}=this.cnn_point(t);if(n&&e)return e.generatrix.getNearestPoint(this[t])}return this[t]}angle_at(t){const{profile:e,point:s}=this.cnn_point(t);if(!e||!s)return 90;const i=this.generatrix,r=e.generatrix;let o=i.getOffsetOf(i.getNearestPoint(s)),a=r.getOffsetOf(r.getNearestPoint(s));o<10?o=10:Math.abs(o-i.length)<10&&(o=i.length-10),a<10?a=10:Math.abs(a-r.length)<10&&(a=r.length-10);const c=i.getTangentAt(o)||new n.Point,l=(r.getTangentAt(a)||new n.Point).negate().getDirectedAngle(c).round(1);return l>180?l-180:l<0?-l:l}get a1(){return this.angle_at("b")}get a2(){return this.angle_at("e")}get info(){return"№"+this.elm+" α:"+this.angle_hor.toFixed(0)+"° l:"+this.length.toFixed(0)}get r(){return this._row.r}set r(t){const{_row:e,_attr:n}=this;e.r!=t&&(n._rays.clear(),e.r=t,this.set_generatrix_radius(),this.project.notify(this,"update",{r:!0,arc_h:!0,arc_ccw:!0}))}get rmin(){return this.generatrix.rmin()}get rmax(){return this.generatrix.rmax()}get ravg(){return this.generatrix.ravg()}get arc_ccw(){return this._row.arc_ccw}set arc_ccw(t){const{_row:e,_attr:n}=this;e.arc_ccw!=t&&(n._rays.clear(),e.arc_ccw=t,this.set_generatrix_radius(),this.project.notify(this,"update",{r:!0,arc_h:!0,arc_ccw:!0}))}get arc_h(){const{_row:t,b:e,e:s,generatrix:i}=this;if(t.r){const t=i.getPointAt(i.length/2);return n.Line.getSignedDistance(e.x,e.y,s.x,s.y,t.x,t.y).round(1)}return 0}set arc_h(t){const{_row:e,_attr:n,b:s,e:i,arc_h:r}=this;r!=(t=parseFloat(t))&&(n._rays.clear(),t<0?(t=-t,e.arc_ccw=!0):e.arc_ccw=!1,e.r=s.arc_r(s.x,s.y,i.x,i.y,t),this.set_generatrix_radius(t),this.project.notify(this,"update",{r:!0,arc_h:!0,arc_ccw:!0}))}get angle_hor(){const{b:t,e}=this,s=new n.Point(e.x-t.x,t.y-e.y).angle.round(2);return s<0?s+360:s}get length(){const{b:e,e:n,outer:s}=this.rays,i=this.elm_type==t.enm.elm_types.Импост?this.generatrix:s,r={};for(let t=1;t<=4;t++)r[t]=i.getNearestPoint(this.corns(t));r.b=i.getOffsetOf(r[1])<i.getOffsetOf(r[4])?r[1]:r[4],r.e=i.getOffsetOf(r[2])>i.getOffsetOf(r[3])?r[2]:r[3];const o=i.get_subpath(r.b,r.e),a=o.length+(e.cnn?e.cnn.size(this):0)+(n.cnn?n.cnn.size(this):0);return o.remove(),a}get orientation(){let{angle_hor:e}=this;return e>180&&(e-=180),e>-s.orientation_delta&&e<s.orientation_delta||e>180-s.orientation_delta&&e<180+s.orientation_delta?t.enm.orientations.hor:e>90-s.orientation_delta&&e<90+s.orientation_delta||e>270-s.orientation_delta&&e<270+s.orientation_delta?t.enm.orientations.vert:t.enm.orientations.incline}get rays(){const{_rays:t}=this._attr;return t.inner.segments.length&&t.outer.segments.length||t.recalc(),t}get addls(){return this.children.filter(t=>t instanceof E)}elm_props(){const{_attr:e,_row:n,project:s}=this,{blank:i}=t.utils,r=[];return s._dp.sys.product_params.find_rows({elm:!0},({param:t})=>{r.push(t)}),e.props&&e.props.forEach(t=>{r.includes(t)||delete this[t.ref]}),e.props=r,r.forEach(t=>{this.hasOwnProperty(t.ref)||Object.defineProperty(this,t.ref,{get(){let e;return s.ox.params.find_rows({param:t,cnstr:{in:[0,-n.row]},inset:i.guid},t=>{e&&!t.cnstr||(e=t)}),e&&e.value},set(e){let r,o;s.ox.params.find_rows({param:t,cnstr:{in:[0,-n.row]},inset:i.guid},t=>{t.cnstr?r=t:o=t}),o&&o.value==e?r&&r._owner.del(r):r?r.value=e:s.ox.params.add({param:t,cnstr:-n.row,inset:i.guid,value:e})},configurable:!0})}),r}get oxml(){const t={" ":[{id:"info",path:"o.info",type:"ro"},"inset","clr",this instanceof A?"region":"offset"],Начало:["x1","y1","a1","cnn1"],Конец:["x2","y2","a2","cnn2"]};this.selected_cnn_ii()&&(t.Примыкание=["cnn3"]);const e=this.elm_props();return e.length&&(t.Свойства=e.map(({ref:t})=>t)),t}get default_clr_str(){return"FEFEFE"}get opacity(){return this.path?this.path.opacity:1}set opacity(t){this.path&&(this.path.opacity=t)}get dx0(){const{cnn:e}=this.rays.b,n=e&&e.main_row(this);return n&&n.angle_calc_method==t.enm.angle_calculating_ways.СварнойШов?-n.sz:0}setSelection(t){super.setSelection(t);const{generatrix:e,path:s}=this._attr;if(e.setSelection(t),this.ruler_line_select(!1),t){const{inner:t,outer:e}=this.rays;this._hatching?this._hatching.removeChildren():this._hatching=new n.CompoundPath({parent:this,guide:!0,strokeColor:"grey",strokeScaling:!1}),s.setSelection(0);for(let i=0;i<t.length;i+=50){const r=t.getPointAt(i),o=t.getNormalAt(i).multiply(400).rotate(-35).negate(),a=new n.Path({insert:!1,segments:[r,r.add(o)]}),c=a.intersect_point(e,r);if(r&&c){const t=s.getNearestPoint(r),e=s.getNearestPoint(c),n=t.is_nearest(r),i=e.is_nearest(c);if(n&&i)this._hatching.moveTo(t),this._hatching.lineTo(e);else if(n&&!i){const e=a.intersect_point(s,c);e&&(this._hatching.moveTo(t),this._hatching.lineTo(e))}else if(!n&&i){const t=a.intersect_point(s,r);t&&(this._hatching.moveTo(t),this._hatching.lineTo(e))}}}}else this._hatching&&(this._hatching.remove(),this._hatching=null)}ruler_line_select(t){const{_attr:e}=this;if(e.ruler_line_path&&(e.ruler_line_path.remove(),delete e.ruler_line_path),t)switch(e.ruler_line=t){case"inner":e.ruler_line_path=this.path.get_subpath(this.corns(3),this.corns(4)),e.ruler_line_path.parent=this,e.ruler_line_path.selected=!0;break;case"outer":e.ruler_line_path=this.path.get_subpath(this.corns(1),this.corns(2)),e.ruler_line_path.parent=this,e.ruler_line_path.selected=!0;break;default:this.generatrix.selected=!0}else e.ruler_line&&delete e.ruler_line}ruler_line_coordin(t){switch(this._attr.ruler_line){case"inner":return(this.corns(3)[t]+this.corns(4)[t])/2;case"outer":return(this.corns(1)[t]+this.corns(2)[t])/2;default:return(this.b[t]+this.e[t])/2}}save_coordinates(){const{_attr:t,_row:e,rays:n,generatrix:s,project:{cnns:i}}=this;if(!s)return;const r=n.b,o=n.e,a=i.add({elm1:e.elm,node1:"b",cnn:r.cnn,aperture_len:this.corns(1).getDistance(this.corns(4)).round(1)}),c=i.add({elm1:e.elm,node1:"e",cnn:o.cnn,aperture_len:this.corns(2).getDistance(this.corns(3)).round(1)});if(e.x1=this.x1,e.y1=this.y1,e.x2=this.x2,e.y2=this.y2,e.path_data=s.pathData,e.nom=this.nom,s.is_linear())e.r=0;else{const{path:n}=this,s=n.get_subpath(t._corns[1],t._corns[2]).ravg(),i=n.get_subpath(t._corns[3],t._corns[4]).ravg();e.r=Math.max(s,i)}e.len=this.length.round(1),r.profile&&(a.elm2=r.profile.elm,r.profile.e.is_nearest(r.point)?a.node2="e":r.profile.b.is_nearest(r.point)?a.node2="b":a.node2="t"),o.profile&&(c.elm2=o.profile.elm,o.profile.b.is_nearest(o.point)||o.profile.e.is_nearest(o.point)?c.node2="b":c.node2="t");const l=this.nearest();l&&i.add({elm1:e.elm,elm2:l.elm,cnn:t._nearest_cnn,aperture_len:e.len}),e.angle_hor=this.angle_hor,e.alp1=Math.round(10*(this.corns(4).subtract(this.corns(1)).angle-s.getTangentAt(0).angle))/10,e.alp1<0&&(e.alp1=e.alp1+360),e.alp2=Math.round(10*(s.getTangentAt(s.length).angle-this.corns(2).subtract(this.corns(3)).angle))/10,e.alp2<0&&(e.alp2=e.alp2+360),e.elm_type=this.elm_type,e.orientation=this.orientation,e.pos=this.pos,this.addls.forEach(t=>t.save_coordinates())}initialize(e){const{project:s,_attr:i,_row:r}=this,o=s.bounds.height+s.bounds.y,{job_prm:a,utils:c}=t;if(e.r&&(r.r=e.r),e.generatrix)i.generatrix=e.generatrix,i.generatrix._reversed&&delete i.generatrix._reversed;else if(r.path_data)i.generatrix=new n.Path(r.path_data);else{const t=new n.Point([r.x1,o-r.y1]);i.generatrix=new n.Path(t),r.r?i.generatrix.arcTo(t.arc_point(r.x1,o-r.y1,r.x2,o-r.y2,r.r+.001,r.arc_ccw,!1),[r.x2,o-r.y2]):i.generatrix.lineTo([r.x2,o-r.y2])}i._corns=[],i._rays=new P(this),i.generatrix.strokeColor="gray",i.path=new n.Path,i.path.strokeColor="black",i.path.strokeWidth=1,i.path.strokeScaling=!1,this.clr=r.clr.empty()?a.builder.base_clr:r.clr,this.addChild(i.path),this.addChild(i.generatrix)}observer(t){const{profiles:e}=t;if(e){let n;if(!e.includes(this)){for(const s of e)s instanceof A&&!(this instanceof A)||(n=!0,this.do_bind(s,this.cnn_point("b"),this.cnn_point("e"),t));n&&e.push(this)}}else(t instanceof S||t instanceof O)&&this.do_bind(t,this.cnn_point("b"),this.cnn_point("e"))}do_bind(e,i,r,o){const{acn:a,ad:c}=t.enm.cnn_types;let l;if(e instanceof O){const t=e.generatrix.clone({insert:!1}).elongation(3e3);this._attr._rays.clear();const n=t.getNearestPoint(this.b),i=t.getNearestPoint(this.e),r=n.subtract(this.b),o=i.subtract(this.e);if(r.length||o.length){const t=this.project.deselect_all_points(!0);r.subtract(o).length<s.epsilon?this.move_points(o,!0):(this.select_node("b"),this.move_points(r),this.project.deselectAll(),this.select_node("e"),this.move_points(o)),this.project.deselectAll();for(const e of t)e.selected=!0}}else{if(i.cnn&&i.profile==e)if(i.profile_point&&!i.is_x){const t=e[i.profile_point];this.b.is_nearest(t,0)||(i.is_t||i.cnn.cnn_type==c?n.Key.isDown("control")?console.log("control"):(this.b.getDistance(t,!0)<s.sticking2&&(this.b=t),l=!0):(i.clear(),this._attr._rays.clear()))}else-1!=a.t.indexOf(i.cnn.cnn_type)&&this.do_sub_bind(e,"b")&&(l=!0);if(r.cnn&&r.profile==e)if(r.profile_point&&!r.is_x){const t=e[r.profile_point];this.e.is_nearest(t,0)||(r.is_t||r.cnn.cnn_type==c?n.Key.isDown("control")?console.log("control"):(this.e.getDistance(t,!0)<s.sticking2&&(this.e=t),l=!0):(r.clear(),this._attr._rays.clear()))}else-1!=a.t.indexOf(r.cnn.cnn_type)&&this.do_sub_bind(e,"e")&&(l=!0)}if(o&&l){const t=this.joined_imposts();t.inner.concat(t.outer).forEach(t=>{-1==o.profiles.indexOf(t)&&t.profile.observer(this)})}}cnn_side(e,n,s){n||(n=e.interiorPoint()),s||(s=this.rays);const{Изнутри:i,Снаружи:r}=t.enm.cnn_sides;return s&&n&&s.inner.length&&s.outer.length?s.inner.getNearestPoint(n).getDistance(n,!0)<s.outer.getNearestPoint(n).getDistance(n,!0)?i:r:i}set_generatrix_radius(t){const{generatrix:e,_row:i,layer:r,selected:o}=this,a=e.firstSegment.point.clone(),c=e.lastSegment.point.clone(),l=a.getDistance(c)/2;let _;if(e.removeSegments(1),e.firstSegment.handleIn=null,e.firstSegment.handleOut=null,i.r&&i.r<=l&&(i.r=l+1e-4,_=!0),o&&(this.selected=!1),i.r){let s=new n.Point(a.arc_point(a.x,a.y,c.x,c.y,i.r,i.arc_ccw,!1));if((s.point_pos(a.x,a.y,c.x,c.y)>0&&!i.arc_ccw||s.point_pos(a.x,a.y,c.x,c.y)<0&&i.arc_ccw)&&(s=new n.Point(a.arc_point(a.x,a.y,c.x,c.y,i.r,!i.arc_ccw,!1))),_||t){const e=a.add(c).divide(2),n=s.subtract(e);n.length=t||l,s=e.add(n)}e.arcTo(s,c)}else e.lineTo(c);r.notify({type:s.move_points,profiles:[this],points:[]}),o&&setTimeout(()=>this.selected=o,100)}set_inset(t,e){const{_row:n,_attr:s,project:i}=this;if(!e&&i.selectedItems.length>1&&i.selected_profiles(!0).forEach(e=>{e!=this&&e.elm_type==this.elm_type&&e.set_inset(t,!0)}),n.inset!=t){if(n.inset=t,s&&s._rays){s._rays.clear(!0),delete s.d0;const t=this.cnn_point("b"),e=this.cnn_point("e"),{cnns:n}=i;if(t.profile&&"e"==t.profile_point){const{_rays:e}=t.profile._attr;e&&(e.clear(),e.e.cnn=null)}if(e.profile&&"b"==e.profile_point){const{_rays:t}=e.profile._attr;t&&(t.clear(),t.b.cnn=null)}const{inner:r,outer:o}=this.joined_imposts(),a=this.elm;for(const{profile:t}of r.concat(o)){const{b:e,e:n}=t.rays;e.profile==this&&e.clear(!0),n.profile==this&&n.clear(!0)}for(const{_attr:t,elm:e}of this.joined_nearests())t._rays&&t._rays.clear(!0),t._nearest_cnn=null,n.clear({elm1:e,elm2:a});this.layer.glasses(!1,!0).forEach(t=>{n.clear({elm1:t.elm,elm2:a})})}i.register_change()}}set_clr(t,e){!e&&this.project.selectedItems.length>1&&this.project.selected_profiles(!0).forEach(e=>{e!=this&&e.set_clr(t,!0)}),b.prototype.set_clr.call(this,t)}postcalc_cnn(e){const n=this.cnn_point(e);return n.cnn=t.cat.cnns.elm_cnn(this,n.profile,n.cnn_types,n.cnn),n.point||(n.point=this[e]),n}postcalc_inset(){return this.set_inset(this.project.check_inset({elm:this}),!0),this}default_inset(e){const{orientation:n,project:s,_attr:i,elm_type:r}=this,o=this.nearest(!0);if(o||e){let e=o&&s._dp.sys.flap_pos_by_impost&&r==t.enm.elm_types.Створка?o.pos:this.pos;e==t.enm.positions.Центр&&(n==t.enm.orientations.vert&&(e=[e,t.enm.positions.ЦентрВертикаль]),n==t.enm.orientations.hor&&(e=[e,t.enm.positions.ЦентрГоризонталь])),this.set_inset(this.project.default_inset({elm_type:r,pos:e,inset:this.inset}),!0)}o&&(i._nearest_cnn=t.cat.cnns.elm_cnn(this,i._nearest,t.enm.cnn_types.acn.ii,i._nearest_cnn))}path_points(e,s){const{_attr:i,rays:r,generatrix:o}=this;if(!o.curves.length)return e;const{_corns:a}=i;function c(t,n,s,i=e.point){const r=t.getIntersections(n);let o,c,l=1/0;if(1==r.length){if(!s)return r[0].point.getDistance(i,!0);a[s]=r[0].point}else if(r.length>1){if(r.forEach(t=>{o=t.point.getDistance(i,!0),o<l&&(l=o,c=t.point)}),!s)return l;a[s]=c}}const l=e.profile instanceof z?e.profile.rays:e.profile instanceof w?{inner:e.profile.path,outer:e.profile.path}:void 0,{cnn_type:_}=e.cnn||{},{cnn_types:h}=t.enm;if(e.is_t||_==h.xx&&!e.profile_point){if(!e.profile.path.segments.length){const{_attr:t,row:n}=e.profile;if(t.force_redraw)if(e.profile.generatrix&&e.profile.generatrix.segments.length)e.profile.path.addSegments(e.profile.generatrix.segments),t.force_redraw=!1;else{if(!e.profile.row||!e.profile.row.path_data)throw new Error("cycle redraw");e.profile.path.pathData=e.profile.row.path_data,t.force_redraw=!1}else t.force_redraw=!0,e.profile.redraw(),t.force_redraw=!1}const n=new Set;let i;e.point&&!(this instanceof A)&&this.layer.profiles.forEach(t=>{if(t!==this)if(e.point.is_nearest(t.b,!0)){const s=t.rays.b.profile;s!==this&&(s===e.profile&&e.profile.cnn_side(this)!==e.profile.cnn_side(t)||n.add(t))}else if(e.point.is_nearest(t.e,!0)){const s=t.rays.e.profile;s!==this&&(s===e.profile&&e.profile.cnn_side(this)!==e.profile.cnn_side(t)||n.add(t))}else t.generatrix.is_nearest(e.point,!0)&&n.add(t)}),n.forEach(t=>{t!==e.profile&&(i=t)});const _=e.profile.cnn_side(this,null,l)===t.enm.cnn_sides.Снаружи?"outer":"inner";if(i){const e=o.getPointAt(o.length/2),n=i&&i.rays,h=i.cnn_side(this,null,n)===t.enm.cnn_sides.Снаружи?"outer":"inner",p=c(l[_],r.outer,0,e),d=c(l[_],r.inner,0,e),u=c(n[h],r.outer,0,e),f=c(n[h],r.inner,0,e);"b"==s?(c(p<u?l[_]:n[h],r.outer,1),c(d<f?l[_]:n[h],r.inner,4),c(n[h],l[_],5),(r.inner.point_pos(a[5])>=0||r.outer.point_pos(a[5])>=0)&&delete a[5]):"e"==s&&(c(p<u?l[_]:n[h],r.outer,2),c(d<f?l[_]:n[h],r.inner,3),c(n[h],l[_],6),(r.inner.point_pos(a[6])>=0||r.outer.point_pos(a[6])>=0)&&delete a[6])}else"b"==s?(c(l[_],r.outer,1),c(l[_],r.inner,4),delete a[5]):"e"==s&&(c(l[_],r.outer,2),c(l[_],r.inner,3),delete a[6])}else if(_==h.xx)if(e.profile instanceof A){const t=.7*this.width,e="b"==s?t:o.length-t,i=o.getPointAt(e),a=o.getNormalAt(e).normalize(t),l=new n.Path({insert:!1,segments:[i.subtract(a),i.add(a)]});"b"==s?(c(l,r.outer,1),c(l,r.inner,4)):"e"==s&&(c(l,r.outer,2),c(l,r.inner,3))}else{const t=e.profile.cnn_point(e.profile_point),n=t&&t.profile;if(n){const t=n&&n.rays,e=c(l.inner,r.outer),i=c(l.inner,r.inner),o=c(t.inner,r.outer),a=c(t.inner,r.inner);"b"==s?(c(t.inner,l.inner,5),c(e>o?l.inner:t.inner,r.outer,1),c(i>a?l.inner:t.inner,r.inner,4)):"e"==s&&(c(e>o?l.inner:t.inner,r.outer,2),c(i>a?l.inner:t.inner,r.inner,3),c(t.inner,l.inner,6))}else"b"==s?(delete a[1],delete a[4]):"e"==s&&(delete a[2],delete a[3])}else e.profile_point&&e.cnn&&_!=h.i?_==h.ad?"b"==s?(c(l.outer,r.outer,1),c(l.inner,r.inner,4)):"e"==s&&(c(l.outer,r.outer,2),c(l.inner,r.inner,3)):_==h.av?this.orientation==t.enm.orientations.vert?"b"==s?(c(l.outer,r.outer,1),c(l.outer,r.inner,4)):"e"==s&&(c(l.outer,r.outer,2),c(l.outer,r.inner,3)):this.orientation==t.enm.orientations.hor?"b"==s?(c(l.inner,r.outer,1),c(l.inner,r.inner,4)):"e"==s&&(c(l.inner,r.outer,2),c(l.inner,r.inner,3)):e.err="orientation":_==h.ah&&(this.orientation==t.enm.orientations.vert?"b"==s?(c(l.inner,r.outer,1),c(l.inner,r.inner,4)):"e"==s&&(c(l.inner,r.outer,2),c(l.inner,r.inner,3)):this.orientation==t.enm.orientations.hor?"b"==s?(c(l.outer,r.outer,1),c(l.outer,r.inner,4)):"e"==s&&(c(l.outer,r.outer,2),c(l.outer,r.inner,3)):e.err="orientation"):"b"==s?(delete a[1],delete a[4]):"e"==s&&(delete a[2],delete a[3]);return"b"==s?(a[1]||(a[1]=this.b.add(this.generatrix.firstCurve.getNormalAt(0,!0).normalize(this.d1))),a[4]||(a[4]=this.b.add(this.generatrix.firstCurve.getNormalAt(0,!0).normalize(this.d2)))):"e"==s&&(a[2]||(a[2]=this.e.add(this.generatrix.lastCurve.getNormalAt(1,!0).normalize(this.d1))),a[3]||(a[3]=this.e.add(this.generatrix.lastCurve.getNormalAt(1,!0).normalize(this.d2)))),e}interiorPoint(){const{generatrix:t,d1:e,d2:n}=this,s=1==t.curves.length?t.firstCurve.getPointAt(.5,!0):2==t.curves.length?t.firstCurve.point2:t.curves[1].point2,i=t.getNormalAt(t.getOffsetOf(s));return s.add(i.multiply(e).add(i.multiply(n)).divide(2))}select_corn(t){const e=this.corns(t);return this.path.segments.forEach(t=>{t.point.is_nearest(e.point)&&(e.segm=t)}),e.segm||e.point!=this.b||(e.segm=this.generatrix.firstSegment),e.segm||e.point!=this.e||(e.segm=this.generatrix.lastSegment),e.segm&&e.dist<s.sticking0&&(this.project.deselectAll(),e.segm.selected=!0),e}is_linear(){return this.generatrix.is_linear()}is_nearest(t){return(this.b.is_nearest(t.b,!0)||this.generatrix.is_nearest(t.b))&&(this.e.is_nearest(t.e,!0)||this.generatrix.is_nearest(t.e))}is_collinear(t){let e=t.e.subtract(t.b).getDirectedAngle(this.e.subtract(this.b));return e<-180&&(e+=180),Math.abs(e)<s.orientation_delta}joined_nearests(){return[]}redraw(){const t=this.postcalc_cnn("b"),e=this.postcalc_cnn("e"),{path:s,generatrix:i,rays:r}=this;if(this.path_points(t,"b"),this.path_points(e,"e"),s.removeSegments(),this.corns(5)&&s.add(this.corns(5)),s.add(this.corns(1)),i.is_linear())s.add(this.corns(2)),this.corns(6)&&s.add(this.corns(6)),s.add(this.corns(3));else{let t=new n.Path({insert:!1}),e=r.outer.getNearestLocation(this.corns(1)).offset,i=r.outer.getNearestLocation(this.corns(2)).offset,o=(i-e)/50;for(let n=e+o;n<i;n+=o)t.add(r.outer.getPointAt(n));t.simplify(.8),s.join(t),s.add(this.corns(2)),this.corns(6)&&s.add(this.corns(6)),s.add(this.corns(3)),t=new n.Path({insert:!1}),e=r.inner.getNearestLocation(this.corns(3)).offset,i=r.inner.getNearestLocation(this.corns(4)).offset,o=(i-e)/50;for(let n=e+o;n<i;n+=o)t.add(r.inner.getPointAt(n));t.simplify(.8),s.join(t)}return s.add(this.corns(4)),s.closePath(),s.reduce(),this.children.forEach(t=>{t instanceof E&&(t.observer(t.parent),t.redraw())}),this}mark_direction(){const{generatrix:t,rays:{inner:e,outer:s}}=this,i=t.getPointAt(130),r=t.getPointAt(230),o=e.getNearestPoint(i),a=e.getNearestPoint(r),c=s.getNearestPoint(i),l=s.getNearestPoint(r),_=o.add(c).divide(2),h=a.add(l).divide(2),p=_.add(h).divide(2),d=h.subtract(_).rotate(90).normalize(10),u=p.add(d),f=p.subtract(d);new n.Path({parent:this,segments:[_,h,u,f,h],strokeColor:"darkblue",strokeCap:"round",strokeWidth:2,strokeScaling:!1})}corns(t){const{_corns:e}=this._attr;if("number"==typeof t)return t<10?e[t]:this.generatrix.getPointAt(t);if(t instanceof n.Point){const n={dist:1/0,profile:this};let s;for(let i=1;i<5;i++)s=e[i].getDistance(t),s<n.dist&&(n.dist=s,n.point=e[i],n.point_name=i);const{hhi:i}=this;if(i){s=i.getDistance(t),s<=n.dist&&(n.dist=i.getDistance(t),n.point=i,n.point_name="hhi");const{hho:e}=this;s=e.getDistance(t),s<=n.dist&&(n.dist=e.getDistance(t),n.point=e,n.point_name="hho")}return s=this.b.getDistance(t),s<=n.dist?(n.dist=this.b.getDistance(t),n.point=this.b,n.point_name="b"):(s=this.e.getDistance(t),s<=n.dist&&(n.dist=this.e.getDistance(t),n.point=this.e,n.point_name="e")),n}{const n=t.substr(t.length-1,1),s=t.substr(t.length-2,1);return e[n][s]}}has_cnn(t,e){let n=this;for(;n.parent instanceof z;)n=n.parent;for(;t.parent instanceof z;)t=t.parent;return!!(n.b.is_nearest(e,!0)&&n.cnn_point("b").profile==t||n.e.is_nearest(e,!0)&&n.cnn_point("e").profile==t||t.b.is_nearest(e,!0)&&t.cnn_point("b").profile==n||t.e.is_nearest(e,!0)&&t.cnn_point("e").profile==n)}check_distance(t,e,n,s){return this.project.check_distance(t,this,e,n,s)}max_right_angle(t){const{generatrix:e}=this;return t.forEach(t=>{t._angle=e.angle_to(t.profile.generatrix,t.point),t._angle>180&&(t._angle=360-t._angle)}),t.sort((t,e)=>Math.abs(t._angle-90)-Math.abs(e._angle-90)),!0}show_number(t=!0){let{elm_number:e}=this.children;if(!t)return e&&e.remove();e?e.position=this.path.interiorPoint:e=new n.PointText({parent:this,guide:!0,name:"elm_number",justification:"center",fillColor:"darkblue",fontFamily:s.font_family,fontSize:1.1*s.font_size,fontWeight:"bold",content:this.elm,position:this.interiorPoint().add(this.generatrix.getTangentAt(this.generatrix.length/1).multiply(2*s.font_size))})}}class S extends z{constructor(e){const n=!!e.row;if(super(e),this.parent){const{project:{_scope:i,ox:r},observer:o}=this;if(this.observer=o.bind(this),i.eve.on(s.move_points,this.observer),this.layer.on_insert_elm(this),n){const{cnstr:n,elm:s}=e.row;r.coordinates.find_rows({cnstr:n,parent:{in:[s,-s]},elm_type:t.enm.elm_types.Добор},t=>new E({row:t,parent:this}))}}}get d0(){const{_attr:t}=this;if(!t.hasOwnProperty("d0")){t.d0=this.offset;const e=this.nearest();e&&(t.d0-=e.d2+(t._nearest_cnn?t._nearest_cnn.size(this):20))}return t.d0}get elm_type(){const{_rays:e,_nearest:n}=this._attr;return e&&!n&&(e.b.is_tt||e.e.is_tt)?t.enm.elm_types.Импост:this.layer.parent instanceof l?t.enm.elm_types.Створка:t.enm.elm_types.Рама}get pos(){const e=this.layer.profiles_by_side();return e.top==this?t.enm.positions.Верх:e.bottom==this?t.enm.positions.Низ:e.left==this?t.enm.positions.Лев:e.right==this?t.enm.positions.Прав:t.enm.positions.Центр}nearest(e){const{b:n,e:s,_attr:i,layer:r,project:o}=this;let{_nearest:a,_nearest_cnn:c}=i;!e&&this.inset.empty()&&(e=!0);const l=r=>{if(!(r instanceof S||r instanceof O)||!r.isInserted())return;let{generatrix:a}=r;if(r.elm_type===t.enm.elm_types.Импост){const t=r.cnn_point("b").profile,e=r.cnn_point("e").profile;(t&&t.nearest(!0)||e&&e.nearest(!0))&&(a=a.clone({insert:!1}).elongation(100))}let l=[];if(a.is_nearest(n)&&l.push(n),a.is_nearest(s)&&l.push(s),l.length<2&&r instanceof O&&(this.generatrix.is_nearest(r.b)&&l.every(t=>!t.is_nearest(r.b))&&l.push(r.b),this.generatrix.is_nearest(r.e)&&l.every(t=>!t.is_nearest(r.e))&&l.push(r.e)),l.length>1){if(!e){let e;if(c||(c=o.elm_cnn(this,r)),r.is_linear())e=Math.abs(r.angle_hor-this.angle_hor)>60;else{e=a.getOffsetOf(a.getNearestPoint(n))>a.getOffsetOf(a.getNearestPoint(s))}i._nearest_cnn=t.cat.cnns.elm_cnn(this,r,t.enm.cnn_types.acn.ii,c,!1,e)}return i._nearest=r,!0}i._nearest=null,i._nearest_cnn=null},_=t=>t.some(t=>{if(a!=t&&t.generatrix)return!!l(t)||void(i._nearest=null)});return r&&!l(i._nearest)&&(r.parent?_(r.parent.profiles):_(o.l_connective.children)),i._nearest}joined_imposts(e){const{rays:n,generatrix:s,layer:i}=this,r=[],o=[],a={b:[],e:[]},{Снаружи:c}=t.enm.cnn_sides,l=(t,e,i)=>{const a={point:s.getNearestPoint(i),profile:e};this.cnn_side(e,t,n)===c?o.push(a):r.push(a)};return!!i.profiles.some(t=>{if(t!=this)for(const n of["b","e"]){const s=t.rays[n];if(s.profile==this&&s.cnn)if(s.profile_point)a[n].push(t.corns(1));else{if(e)return!0;l(t.corns(1),t,s.point)}}})||(["b","e"].forEach(t=>{a[t].length>1&&a[t].some(e=>{if(this.cnn_side(null,e,n)===c)return this.rays[t].is_cut=!0,!0})}),!e&&{inner:r,outer:o})}joined_nearests(){const t=[];return this.layer.contours.forEach(e=>{e.profiles.forEach(e=>{e.nearest(!0)==this&&t.push(e)})}),t}cnn_point(t,e){const{project:n,parent:i,rays:r}=this,o=r[t],{cnn:a,profile:c,profile_point:l}=o;if(e||(e=this[t]),c&&c.children.length){if(!n.has_changes())return o;if(!1===this.check_distance(c,o,e,!0)||o.distance<s.epsilon)return o}if(o.clear(),i){const{allow_open_cnn:t}=n._dp.sys,r=[];for(const t of i.profiles)(!1===this.check_distance(t,o,e,!1)||o.distance<(o.is_t||!o.is_l?s.sticking:s.sticking_l))&&(r.push({profile_point:o.profile_point,profile:t,cnn_types:o.cnn_types,point:o.point}),o.clear());1===r.length?o._mixin(r[0]):r.length>=2&&(this.max_right_angle(r)?(o._mixin(r[0]),a&&o.cnn_types&&-1!=o.cnn_types.indexOf(a.cnn_type)&&(o.cnn=a)):o.clear(),o.is_cut=!0)}return o}t_parent(e){if(this.elm_type!=t.enm.elm_types.Импост)return this;const{_rays:n}=this._attr;return"b"===e?n&&n.b.profile:"e"===e?n&&n.e.profile:n&&(n.b.profile||n.e.profile)}}i.Profile=S,i.ProfileItem=z,i.ProfileRays=P,i.CnnPoint=k;class E extends z{constructor(e){const n=!!e.row;super(e);const{project:s,_attr:i,_row:r}=this;if(i.generatrix.strokeWidth=0,!e.side&&r.parent<0&&(e.side="outer"),i.side=e.side||"inner",r.parent||(r.parent=this.parent.elm,this.outer&&(r.parent=-r.parent)),n){const{cnstr:n,elm:i}=e.row;s.ox.coordinates.find_rows({cnstr:n,parent:{in:[i,-i]},elm_type:t.enm.elm_types.Добор},t=>new E({row:t,parent:this}))}}get d0(){return this.nearest(),this._attr._nearest_cnn?-this._attr._nearest_cnn.size(this):0}get outer(){return"outer"==this._attr.side}get elm_type(){return t.enm.elm_types.Добор}nearest(){const{_attr:e,parent:n,project:s}=this,i=e._nearest_cnn||s.elm_cnn(this,n);return e._nearest_cnn=t.cat.cnns.elm_cnn(this,n,t.enm.cnn_types.acn.ii,i,!0),n}cnn_point(e,n){const i=this.rays[e],r=(t,e)=>{if(t==this||t==this.parent)return;const o=t.generatrix.getNearestPoint(n);let a;o&&(a=o.getDistance(n))<s.sticking&&a<=i.distance&&(i.point=o,i.distance=a,i.profile=t),e&&t.getItems({class:E,parent:t}).forEach(t=>{r(t,e)})};return n||(n=this[e]),i.profile&&i.profile.children.length&&(r(i.profile),i.distance<s.sticking)||(i.clear(),i.cnn_types=t.enm.cnn_types.acn.t,this.layer.profiles.forEach(t=>r(t,!0))),i}path_points(e,n){const{generatrix:s,rays:i}=this,r=s.getPointAt(s.length/2),o=this._attr._corns;if(!s.curves.length)return e;function a(t,n,s){var i,r,a=t.getIntersections(n),c=1/0;if(1==a.length){if(!s)return a[0].point.getDistance(e.point,!0);o[s]=a[0].point}else if(a.length>1){if(a.forEach(t=>{(i=t.point.getDistance(e.point,!0))<c&&(c=i,r=t.point)}),!s)return c;o[s]=r}}const{profile:c}=e;if(c){const e=c.rays;c.path.segments.length||c.redraw(),"b"==n?c.cnn_side(this,r,e)==t.enm.cnn_sides.Снаружи?(a(e.outer,i.outer,1),a(e.outer,i.inner,4)):(a(e.inner,i.outer,1),a(e.inner,i.inner,4)):"e"==n&&(c.cnn_side(this,r,e)==t.enm.cnn_sides.Снаружи?(a(e.outer,i.outer,2),a(e.outer,i.inner,3)):(a(e.inner,i.outer,2),a(e.inner,i.inner,3)))}return"b"==n?(o[1]||(o[1]=this.b.add(s.firstCurve.getNormalAt(0,!0).normalize(this.d1))),o[4]||(o[4]=this.b.add(s.firstCurve.getNormalAt(0,!0).normalize(this.d2)))):"e"==n&&(o[2]||(o[2]=this.e.add(s.lastCurve.getNormalAt(1,!0).normalize(this.d1))),o[3]||(o[3]=this.e.add(s.lastCurve.getNormalAt(1,!0).normalize(this.d2)))),e}do_bind(t,e,n,s){let i;const r=(t,e)=>{if(!e.profile)return;const n=this.outer?this.parent.rays.outer:this.parent.rays.inner,s=e.profile.generatrix.intersect_point(n,e.point,"nearest");s.is_nearest(this[t])||(this[t]=s,i=!0)};this.parent==t&&(r("b",e),r("e",n)),e.cnn&&e.profile==t&&r("b",e),n.cnn&&n.profile==t&&r("e",n)}glass_segment(){}}i.ProfileAddl=E;class O extends z{get d0(){return 0}get elm_type(){return t.enm.elm_types.Соединитель}cnn_point(t){return this.rays[t]}move_points(t,e,s){const i=this.joined_nearests(),r={profiles:[]};super.move_points(t,e,s),!1===e||n.Key.isDown("control")||i.forEach(t=>{t.do_bind(this,null,null,r),["b","e"].forEach(e=>{const n=t.cnn_point(e);n.profile&&n.profile.do_bind(t,n.profile.cnn_point("b"),n.profile.cnn_point("e"),r)})}),this.project.register_change()}joined_nearests(){const t=[];return this.project.contours.forEach(e=>{e.profiles.forEach(e=>{e.nearest(!0)===this&&t.push(e)})}),t}nearest(){return null}save_coordinates(){if(!this._attr.generatrix)return;const{_row:t,generatrix:e}=this;t.x1=this.x1,t.y1=this.y1,t.x2=this.x2,t.y2=this.y2,t.nom=this.nom,t.path_data=e.pathData,t.parent=0,t.len=this.length,t.angle_hor=this.angle_hor,t.alp1=Math.round(10*(this.corns(4).subtract(this.corns(1)).angle-e.getTangentAt(0).angle))/10,t.alp1<0&&(t.alp1=t.alp1+360),t.alp2=Math.round(10*(e.getTangentAt(e.length).angle-this.corns(2).subtract(this.corns(3)).angle))/10,t.alp2<0&&(t.alp2=t.alp2+360),t.elm_type=this.elm_type}remove(){this.joined_nearests().forEach(t=>{const{inner:e,outer:n}=t.joined_imposts();for(const{profile:t}of e.concat(n))t.rays.clear();for(const{_attr:e,elm:n}of t.joined_nearests())e._rays&&e._rays.clear();const{_attr:i,layer:r}=t;i._rays&&i._rays.clear(),i._nearest&&(i._nearest=null),i._nearest_cnn&&(i._nearest_cnn=null),r&&r.notify&&r.notify({profiles:[t],points:[]},s.move_points)}),super.remove()}}class C extends n.Layer{redraw(){this.children.forEach(t=>t.redraw())}save_coordinates(){this.children.forEach(t=>t.save_coordinates&&t.save_coordinates())}glasses(){return[]}get profiles(){return this.children.filter(t=>t instanceof S)}notify(t,e="update"){}}i.ProfileConnective=O,i.ConnectiveLayer=C;class q extends z{constructor(t){super(t),this.parent=this.project.l_connective,Object.assign(this.generatrix,{strokeColor:"brown",fillColor:new n.Color(1,.1),strokeScaling:!1,strokeWidth:2,dashOffset:4,dashArray:[4,4]})}get d0(){return 0}get d1(){return 0}get d2(){return 0}get path(){return this.generatrix}set path(t){}setSelection(t){n.Item.prototype.setSelection.call(this,t)}get oxml(){return q.oxml}get elm_type(){return t.enm.elm_types.Линия}get length(){return this.generatrix.length}nearest(){return null}joined_nearests(){const t=[];return this.project.contours.forEach(e=>{e.profiles.forEach(e=>{e.nearest(!0)===this&&t.push(e)})}),t}joined_imposts(t){return!t&&{inner:[],outer:[]}}save_coordinates(){if(!this._attr.generatrix)return;const{_row:t}=this;t.x1=this.x1,t.y1=this.y1,t.x2=this.x2,t.y2=this.y2,t.path_data=this.generatrix.pathData,t.parent=this.parent.elm,t.len=this.length,t.angle_hor=this.angle_hor,t.elm_type=this.elm_type}cnn_point(t){return this.rays[t]}redraw(){}}q.oxml={" ":[{id:"info",path:"o.info",type:"ro"}],Начало:["x1","y1"],Конец:["x2","y2"]},i.BaseLine=q;class A extends z{constructor(t){if(super(t),this.parent){const{project:{_scope:t},observer:e}=this;this.observer=e.bind(this),t.eve.on(s.move_points,this.observer)}t.region&&(this.region=t.region)}get d0(){return 0}get elm_type(){return t.enm.elm_types.Раскладка}get region(){const{_row:e,parent:n}=this;let s=e&&e.region;return s&&!s.empty()?s:t.enm.lay_regions.r2}set region(t){this.set_region(t)}set_region(t,e){if(!e){const{selectedItems:e}=this.project;e.length>1&&e.forEach(e=>{e instanceof A&&e!=this&&e.set_region(t,!0)})}const{_row:n}=this;n&&n.region!==t&&(n.region=t)}nearest(){}joined_imposts(e){const{rays:n,generatrix:s,parent:i}=this,r=[],o=[],a={b:[],e:[]},c=(e,i,a)=>{const c={point:s.getNearestPoint(a),profile:i};this.cnn_side(i,e,n)===t.enm.cnn_sides.Снаружи?o.push(c):r.push(c)};return!!i.imposts.some(n=>{if(n!=this)for(const s of["b","e"]){const i=n.cnn_point(s);if(i.profile==this&&i.cnn)if(i.cnn.cnn_type==t.enm.cnn_types.t){if(e)return!0;c(n.corns(1),n,i.point)}else a[s].push(n.corns(1))}})||(["b","e"].forEach(e=>{a[e].length>1&&a[e].some(s=>{if(this.cnn_side(null,s,n)==t.enm.cnn_sides.Снаружи)return this.cnn_point(e).is_cut=!0,!0})}),!e&&{inner:r,outer:o})}save_coordinates(){if(!this._attr.generatrix)return;const{_row:t,project:e,rays:n,generatrix:s}=this,{cnns:i}=e,{b:r,e:o}=n,a=i.add({elm1:t.elm,node1:"b",cnn:r.cnn?r.cnn.ref:"",aperture_len:this.corns(1).getDistance(this.corns(4))}),c=i.add({elm1:t.elm,node1:"e",cnn:o.cnn?o.cnn.ref:"",aperture_len:this.corns(2).getDistance(this.corns(3))});t.x1=this.x1,t.y1=this.y1,t.x2=this.x2,t.y2=this.y2,t.path_data=s.pathData,t.nom=this.nom,t.parent=this.parent.elm,t.len=this.length,r.profile&&(a.elm2=r.profile.elm,r.profile instanceof w?a.node2="t":r.profile.e.is_nearest(r.point)?a.node2="e":r.profile.b.is_nearest(r.point)?a.node2="b":a.node2="t"),o.profile&&(c.elm2=o.profile.elm,o.profile instanceof w?c.node2="t":o.profile.b.is_nearest(o.point)||o.profile.e.is_nearest(o.point)?c.node2="b":c.node2="t"),t.angle_hor=this.angle_hor,t.alp1=Math.round(10*(this.corns(4).subtract(this.corns(1)).angle-s.getTangentAt(0).angle))/10,t.alp1<0&&(t.alp1=t.alp1+360),t.alp2=Math.round(10*(s.getTangentAt(s.length).angle-this.corns(2).subtract(this.corns(3)).angle))/10,t.alp2<0&&(t.alp2=t.alp2+360),t.elm_type=this.elm_type}cnn_point(t,e){const n=this.rays[t];if(e||(e=this[t]),n.profile&&n.profile.children.length)if(n.profile instanceof w){const t=n.profile.path.getNearestPoint(e);if(t.getDistance(e)<s.sticking_l)return n.point=t,n}else if(!1===this.check_distance(n.profile,n,e,!0)||n.distance<s.epsilon)return n;if(n.clear(),this.parent){const t=this.bind_node(e);t.binded&&(n._mixin(t,["point","profile","cnn_types","profile_point"]),this[n.node].is_nearest(n.point,0)||(this[n.node]=n.point))}return n}bind_node(e,n){n||(n=[this.parent]);let i={distance:1/0,is_l:!0};return n.some(n=>{const r=n.path.getNearestPoint(e);let o=r.getDistance(e);if(o<i.distance&&(i.distance=o,i.point=r,i.profile=n,i.cnn_types=t.enm.cnn_types.acn.t),o<s.sticking_l)return i.binded=!0,!0;i.cnn_types=t.enm.cnn_types.acn.t;const a=[];for(let t of n.imposts)t!==this&&!1===t.project.check_distance(t,null,i,e,"node_generatrix")&&a.push({profile_point:i.profile_point,profile:i.profile,cnn_types:i.cnn_types,point:i.point});1==a.length?i._mixin(a[0]):a.length>=2&&(this.max_right_angle(a)&&i._mixin(a[0]),i.is_cut=!0)}),!i.binded&&i.point&&i.distance<s.sticking&&(i.binded=!0),i}move_nodes(t,e){for(let n of this.parent.imposts)n!=this&&(n.b.is_nearest(t)&&(n.b=e),n.e.is_nearest(t)&&(n.e=e))}}i.Onlay=A;class N extends S{constructor(t){super(t),Object.defineProperty(this._attr,"_nearest_cnn",{get:()=>N.nearest_cnn,set(t){}}),this.path.strokeColor="darkgreen",this.path.dashArray=[8,4,2,4]}nearest(){return this._attr._nearest}default_inset(t){}get inset(){return this.nearest().inset}set inset(t){}get clr(){return this.nearest(!0).clr}set clr(t){}get sizeb(){return 0}path_points(t,e){const{_attr:{_corns:n},generatrix:s,layer:{bounds:i}}=this;if(!s.curves.length)return t;const{rays:r}=this.nearest(),o=t.profile.nearest().rays;function a(e,s,i,r=t.point){const o=e.getIntersections(s);let a,c,l=1/0;if(1==o.length){if(!i)return o[0].point.getDistance(r,!0);n[i]=o[0].point}else if(o.length>1){if(o.forEach(t=>{a=t.point.getDistance(r,!0),a<l&&(l=a,c=t.point)}),!i)return l;n[i]=c}}const c=o.inner.getNearestPoint(i.center).getDistance(i.center,!0)>o.outer.getNearestPoint(i.center).getDistance(i.center,!0)?o.outer:o.inner,l=r.inner.getNearestPoint(i.center).getDistance(i.center,!0)>r.outer.getNearestPoint(i.center).getDistance(i.center,!0)?r.outer:r.inner;return"b"==e?(a(c.equidistant(-2),l.equidistant(-2),1),a(c,l,4)):"e"==e&&(a(c.equidistant(-2),l.equidistant(-2),2),a(c,l,3)),t}redraw(){const t=this.cnn_point("b"),e=this.cnn_point("e"),{rays:n}=this.nearest(),{path:s,generatrix:i}=this;return this.path_points(t,"b"),this.path_points(e,"e"),s.removeSegments(),s.add(this.corns(1)),s.add(this.corns(2)),s.add(this.corns(3)),s.add(this.corns(4)),s.closePath(),s.reduce(),this.children.forEach(t=>{t instanceof E&&(t.observer(t.parent),t.redraw())}),this}}N.nearest_cnn={size:t=>t.nearest().width,empty:()=>!1,get cnn_type(){return t.enm.cnn_types.ii},specification:[],selection_params:[]},i.ProfileVirtual=N;class D extends n.Project{constructor(e,n,s){super(e),n.project=this;const i=this._attr={_silent:s,_bounds:null,_calc_order_row:null,_update_timer:0,_vis_timer:0};this._ch=[],this._dp=t.dp.buyers_order.create();const r="function"===typeof requestAnimationFrame;this.redraw=()=>{i._opened&&!i._silent&&this._scope&&r&&requestAnimationFrame(this.redraw);const{length:t}=this._ch;if(!i._opened||i._saving||!t)return;const{contours:e}=this;if(e.length){this.l_connective.redraw(),r&&!i._silent&&e[0].refresh_prm_links(!0);for(let n of e)if(n.redraw(),this._ch.length>t)return;i._bounds=null,e.forEach(t=>{const{contours:e,l_dimensions:n}=t;e.forEach(t=>{t.save_coordinates(!0),r&&t.refresh_prm_links()}),n.redraw()}),this.draw_sizes(),this.view.update()}else this.draw_sizes();this._ch.length=0},i._silent||(this._dp_listener=this._dp_listener.bind(this),this._dp._manager.on("update",this._dp_listener)),n.eve.on("contour_redrawed",()=>{clearTimeout(i._vis_timer),i._vis_timer=setTimeout(this.draw_visualization.bind(this),300)})}_dp_listener(e,n){const{_attr:s,ox:i}=this;if(s._loading||s._snapshot||e!=this._dp)return;const r=["quantity","discount_percent","discount_percent_internal"];if((n.hasOwnProperty("clr")||n.hasOwnProperty("sys"))&&this.notify(this,"scheme_changed"),n.hasOwnProperty("clr")&&(i.clr=e.clr,this.getItems({class:b}).forEach(t=>{t instanceof A||t instanceof w||(t.clr=e.clr)})),n.hasOwnProperty("sys")&&!e.sys.empty()){e.sys.refill_prm(i,0,!0),e._manager.emit_async("rows",e,{extra_fields:!0});for(const t of this.contours)t.on_sys_changed();e.sys!=t.wsql.get_user_param("editor_last_sys")&&t.wsql.set_user_param("editor_last_sys",e.sys.ref),i.clr.empty()&&(i.clr=e.sys.default_clr),this.register_change(!0)}for(const t of r)s._calc_order_row&&n.hasOwnProperty(t)&&(s._calc_order_row[t]=e[t],this.register_change(!0))}set_sys(t){const{_dp:e,ox:n}=this;if(e.sys!==t){e.sys=t,n.sys=t,e.sys.refill_prm(n,0,!0);for(const t of this.contours)t.on_sys_changed();n.clr.empty()&&(n.clr=e.sys.default_clr)}}set_glasses(t){for(const e of this.getItems({class:w}))e.set_inset(t,!0)}set_furn(t){for(const e of this.contours)for(const n of e.contours)n.furn.empty()||(n.furn=t)}_papam_listener(t,e){const{_attr:n,ox:s}=this;n._loading||n._snapshot||(t._owner===s.params||t===s&&e.hasOwnProperty("params"))&&this.register_change()}elm_cnn(t,e){t=t.elm,e=e.elm;const n=this.cnns._obj.find(n=>n.elm1===t&&n.elm2===e);return n&&n._row.cnn}get cnns(){return this.ox.cnn_elmnts}get ox(){return this._dp.characteristic}set ox(e){const{_dp:n,_attr:s,_scope:i}=this;let r;s._silent||(this.hasOwnProperty("_papam_listener")||(this._papam_listener=this._papam_listener.bind(this)),n.characteristic._manager.off("update",this._papam_listener),n.characteristic._manager.off("rows",this._papam_listener)),n.characteristic=e;const o=n.characteristic;n.len=o.x,n.height=o.y,n.s=o.s,n.sys=o.sys,n.clr=o.clr,s._calc_order_row=o.calc_order_row,s._calc_order_row&&"quantity,price_internal,discount_percent_internal,discount_percent,price,amount,note".split(",").forEach(t=>n[t]=s._calc_order_row[t]),n.sys.empty()&&(o.owner.empty()?(n.sys=t.wsql.get_user_param("editor_last_sys"),r=!n.sys.empty()):t.cat.production_params.find_rows({is_folder:!1},t=>{if(r)return!1;t.production.find_rows({nom:o.owner},()=>(n.sys=t,r=!0,!1))})),r&&n.sys.refill_prm(o,0,!0),n.clr.empty()&&(n.clr=n.sys.default_clr),s._silent||(i.eve.emit_async("rows",o,{constructions:!0}),n._manager.emit_async("rows",n,{extra_fields:!0}),n.characteristic._manager.on({update:this._papam_listener,rows:this._papam_listener}))}get builder_props(){const{ox:t,_attr:e}=this;return e._builder_props||t.builder_props}load_dimension_lines(){const{Размер:e,Радиус:n}=t.enm.elm_types;this.ox.coordinates.find_rows({elm_type:{in:[e,n]}},t=>{const n=this.getItem({cnstr:t.cnstr}),s=t.elm_type===e?m:y;n&&new s({parent:n.l_dimensions,row:t})})}load_contour(t){this.ox.constructions.find_rows({parent:t?t.cnstr:0},e=>{this.load_contour(new l({parent:t,row:e}))})}load(e,s){const{_attr:i}=this,r=this;function o(e){return r._scope?(r.ox=e,i._opened=!0,i._bounds=new n.Rectangle({point:[0,0],size:[e.x,e.y]}),e.coordinates.forEach(e=>{e.elm_type===t.enm.elm_types.Соединитель?new O({row:e,parent:r.l_connective}):e.elm_type===t.enm.elm_types.Линия&&new q({row:e})}),"object"===typeof s?i._builder_props=Object.assign({},e.constructor.builder_props_defaults,s):delete i._builder_props,e=null,r.load_contour(null),r.redraw(s),new Promise((e,n)=>{i._bounds=null,r.load_dimension_lines(),setTimeout(()=>{i._bounds=null,r.zoom_fit();const{_scope:n}=r;i._snapshot||(n._undo.clear(),n._undo.save_snapshot(r),n.set_text()),r.register_change(!0),r.contours.length&&r.notify(r.contours[0],"layer_activated",!0),delete i._loading,(r.ox.base_block.empty()||!r.ox.base_block.is_new()?Promise.resolve():r.ox.base_block.load()).then(()=>{r.ox.coordinates.count()?r.ox.specification.count()||s?Promise.resolve().then(()=>{s?(r.draw_visualization(),r.zoom_fit(),e()):setTimeout(r.draw_visualization.bind(r),100)}):t.products_building.recalc(r,{}):s?e():n.load_stamp&&n.load_stamp(),delete i._snapshot,(!s||!r.ox.specification.count())&&e()})})}).then(()=>{r.ox._data.refill_props&&(r._dp.sys.refill_prm(r.ox,0,!0,r),r._scope._acc&&r._scope._acc.props.reload(),delete r.ox._data.refill_props)})):Promise.resolve()}return i._loading=!0,s&&(i._from_service=!0),this.ox=null,this.clear(),t.utils.is_data_obj(e)&&e.calc_order&&!e.calc_order.is_new()?o(e):t.utils.is_guid(e)||t.utils.is_data_obj(e)?t.cat.characteristics.get(e,!0,!0).then(e=>t.doc.calc_order.get(e.calc_order,!0,!0).then(()=>o(e))):void 0}draw_fragment(t){const{l_dimensions:e,l_connective:n}=this,s=this.getItems({class:l});let i;if(s.forEach(t=>t.hidden=!0),e.visible=!1,n.visible=!1,t.elm>0)i=this.getItem({class:b,elm:t.elm}),i&&i.draw_fragment&&i.draw_fragment();else if(t.elm<0){const e=-t.elm;s.some(n=>{if(n.cnstr==e)return n.hidden=!1,n.hide_generatrix(),n.l_dimensions.redraw(t.faltz||!0),n.zoom_fit(),!0})}return this.view.update(),i}has_changes(){return this._ch.length>0}register_update(){const{_attr:t}=this;t._update_timer&&clearTimeout(t._update_timer),t._update_timer=setTimeout(()=>{this.view&&this.view.update(),t._update_timer=0},100)}register_change(t){const{_attr:e,_ch:n}=this;e._loading||(e._bounds=null,this.getItems({class:S}).forEach(t=>{delete t._attr.d0}),this.ox._data._modified=!0,this.notify(this,"scheme_changed")),n.push(Date.now()),t&&this.register_update()}get bounds(){const{_attr:t}=this;return t._bounds||this.contours.forEach(e=>{t._bounds?t._bounds=t._bounds.unite(e.bounds):t._bounds=e.bounds}),t._bounds}get dimension_bounds(){let{bounds:t}=this;return this.getItems({class:f}).forEach(e=>{(e instanceof m||e._attr.impost||e._attr.contour)&&(t=t.unite(e.bounds))}),this.contours.forEach(({l_visualization:e})=>{const s=e._by_insets.bounds;if(s.height&&s.bottom>t.bottom){const e=s.bottom-t.bottom+10;t=t.unite(new n.Rectangle(t.bottomLeft,t.bottomRight.add([0,e<250?1.1*e:1.2*e])))}}),t}get strokeBounds(){let t=this.l_dimensions.strokeBounds;return this.contours.forEach(e=>t=t.unite(e.strokeBounds)),t}get _calc_order_row(){const{_attr:t,ox:e}=this;return t._calc_order_row||e.empty()||(t._calc_order_row=e.calc_order_row),t._calc_order_row}notify(t,e="update",n){t.type&&(e=t.type),this._scope.eve.emit_async(e,t,n)}clear(){const{_attr:t}=this;for(let e in t)"_bounds,_update_timer,_loading,_snapshot,_silent,_from_service".match(e)||delete t[e];super.clear(),new n.Layer}unload(){const{_dp:t,_attr:e,_calc_order_row:n}=this;for(let t in e)"_loading,_saving".match(t)?e[t]=!0:delete e[t];this.hasOwnProperty("_dp_listener")&&(t._manager.off("update",this._dp_listener),this._dp_listener=null);const s=t.characteristic;this.hasOwnProperty("_papam_listener")&&(s._manager.off("update",this._papam_listener),s._manager.off("rows",this._papam_listener),this._papam_listener=null),s&&s._modified&&(s.is_new()?(n&&s.calc_order.production.del(n),s.unload()):setTimeout(s.load.bind(s),100)),this.remove()}move_points(e,s){const i=[],r=[],o=new Set,{auto_align:a,_dp:c}=this;for(const c of this.selectedItems){const{parent:l,layer:_}=c;if(c instanceof n.Path&&l instanceof v&&!o.has(l)){if(o.add(l),l._hatching&&(l._hatching.remove(),l._hatching=null),_ instanceof C)i.push.apply(i,l.move_points(e,s));else if(!l.nearest||!l.nearest()){if(a&&l.elm_type===t.enm.elm_types.Импост&&!l.layer.layer&&Math.abs(e.x)>1)continue;let n;if(c.segments.forEach(t=>{t.selected&&-1!=i.indexOf(t)&&(n=!(t.selected=!1))}),n&&!c.segments.some(t=>t.selected))continue;i.push.apply(i,l.move_points(e,s)),-1==r.indexOf(_)&&(r.push(_),_.l_dimensions.clear())}}else c instanceof w&&c.purge_paths()}i.length&&Math.abs(e.x)>1?this.do_align(a,o):this._attr._from_service||this.register_change(!0),c._manager.emit_async("update",{},{x1:!0,x2:!0,y1:!0,y2:!0,a1:!0,a2:!0,cnn1:!0,cnn2:!0,info:!0})}save_coordinates(e){try{const{_attr:n,bounds:s,ox:i}=this;if(!s)return;return n._saving=!0,i._data._loading=!0,i.x=s.width.round(1),i.y=s.height.round(1),i.s=this.area,i.cnn_elmnts.clear(),i.glasses.clear(),this.contours.forEach(t=>t.save_coordinates()),this.l_connective.save_coordinates(),t.products_building.recalc(this,e)}catch(e){const{msg:n,ui:s}=t;throw s&&s.dialogs.alert({text:e.message,title:n.bld_title}),e}}zoom_fit(e,n){if(e||(e=this.strokeBounds),e){n||(n=t.wsql.alasql.utils.isNode);const s=n?160:320,i=900;let{width:r,height:o,center:a}=e;r<i&&(r=i),o<i&&(o=i),r+=s,o+=s;const{view:c}=this;c.zoom=Math.min(c.viewSize.height/o,c.viewSize.width/r);const l=c.viewSize.width-r*c.zoom;if(n){const t=c.viewSize.height-o*c.zoom;c.center=a.add([l,-t])}else c.center=a.add([l/2,50])}}get_svg(t={}){this.deselectAll();const e=t.export_options||{};e.precision||(e.precision=1);const s=new Set;if("Шаблон"==this.ox.calc_order.obj_delivery_state){for(const t of this.getItems({class:f}))t.visible=!1,s.add(t);for(const t of this.getItems({class:n.PointText}))t.visible=!1,s.add(t);for(const t of this.getItems({class:l}))t.l_visualization._opening&&(t.l_visualization._opening.strokeScaling=!1,t.l_visualization._opening.opacity=.8,t.l_visualization._by_spec.opacity=.5);this.zoom_fit();const{ownerDocument:t}=this.view.element;t&&(e.onExport=function(e,n,s){if(!e.visible)return t.createElement("g")})}const i=this.exportSVG(e),r=this.strokeBounds.unite(this.l_dimensions.strokeBounds);if(i.setAttribute("x",r.x),i.setAttribute("y",r.y),i.setAttribute("width",r.width+40),i.setAttribute("height",r.height),i.querySelector("g").removeAttribute("transform"),e.onExport=null,s.size){for(const t of s)t.visible=!0;for(const t of this.getItems({class:l}))t.l_visualization._opening&&(t.l_visualization._opening.strokeScaling=!0,t.l_visualization._opening.opacity=1,t.l_visualization._by_spec.opacity=1);this.zoom_fit()}return i.outerHTML}load_stamp(e,n){const s=e=>{const{ox:s}=this;this.clear();const i=Object.assign({_not_set_loaded:!0},n?e:e._obj);return s._mixin(i,null,"ref,name,calc_order,product,leading_product,leading_elm,origin,base_block,note,partner,_not_set_loaded,_rev".split(","),!0),n||(s.base_block=e.base_block.empty()||e.base_block.obj_delivery_state===t.enm.obj_delivery_states.Шаблон?e:e.base_block,e.calc_order.refill_props&&(s._data.refill_props=!0)),this.load(s).then(()=>s._data._modified=!0)};return this._attr._loading=!0,n?(this._attr._snapshot=!0,s(e)):t.cat.characteristics.get(e,!0,!0).then(s)}get auto_align(){const{calc_order:e,base_block:n}=this.ox,{Шаблон:s}=t.enm.obj_delivery_states;if(n.empty()||e.obj_delivery_state==s||n.calc_order.obj_delivery_state!=s)return!1;const{auto_align:i}=t.job_prm.properties;let r;return i?(n.params.find_rows({param:i},t=>(r=t.value,!1)),r&&"_"!=r&&r):void 0}do_align(t,e){if(!t||!e.size)return;const n=new Set;for(const t of e)t.layer.fillings&&n.add(t.layer);this._attr._align_timer&&clearTimeout(this._attr._align_timer),this._attr._align_timer=setTimeout(()=>{this._attr._align_timer=0;const t=[];for(const e of n)for(const n of e.fillings)-1==t.indexOf(n)&&t.push(n);this._scope.glass_align("width",t)},100)}resize_canvas(t,e){const{viewSize:n}=this.view;n.width=t,n.height=e}get contours(){return this.layers.filter(t=>t instanceof l)}get area(){return this.contours.reduce((t,{area:e})=>t+e,0).round(3)}get form_area(){return this.contours.reduce((t,{form_area:e})=>t+e,0).round(3)}get clr(){return this.ox.clr}set clr(t){this.ox.clr=t}get l_dimensions(){const{activeLayer:t,_attr:e}=this;return e.l_dimensions||(e.l_dimensions=new d),e.l_dimensions.isInserted()||this.addLayer(e.l_dimensions),t&&(this._activeLayer=t),e.l_dimensions}get l_connective(){const{activeLayer:t,_attr:e}=this;return e.l_connective||(e.l_connective=new C),e.l_connective.isInserted()||this.addLayer(e.l_connective),t&&(this._activeLayer=t),e.l_connective}draw_sizes(){const{bounds:t,l_dimensions:e,builder_props:n}=this;t&&n.auto_lines?(e.bottom?e.bottom.offset=-120:e.bottom=new f({pos:"bottom",parent:e,offset:-120}),e.right?e.right.offset=-120:e.right=new f({pos:"right",parent:e,offset:-120}),this.contours.some(e=>e.l_dimensions.children.some(e=>"right"==e.pos&&Math.abs(e.size-t.height)<s.sticking_l))?e.right.visible=!1:e.right.redraw(),this.contours.some(e=>e.l_dimensions.children.some(e=>"bottom"==e.pos&&Math.abs(e.size-t.width)<s.sticking_l))?e.bottom.visible=!1:e.bottom.redraw()):(e.bottom&&(e.bottom.visible=!1),e.right&&(e.right.visible=!1))}draw_visualization(){if(this.view){for(let t of this.contours)t.draw_visualization();this.view.update()}}default_inset(e){let n;if(!e.pos)return n=this._dp.sys.inserts(e.elm_type,!0),e.inset&&n.some(t=>e.inset==t)?e.inset:n[0];if(n=this._dp.sys.inserts(e.elm_type,"rows"),1==n.length)return n[0].nom;const s=Array.isArray(e.pos);function i(t){return s?e.pos.some(e=>e==t):e.pos==t}if(e.inset&&n.some(n=>e.inset==n.nom&&(i(n.pos)||n.pos==t.enm.positions.Любое)))return e.inset;let r;return n.some(t=>{if(i(t.pos)&&t.by_default)return r=t.nom}),r||n.some(t=>{if(i(t.pos))return r=t.nom}),r||n.some(e=>{if(e.pos==t.enm.positions.Любое&&e.by_default)return r=e.nom}),r||n.some(e=>{if(e.pos==t.enm.positions.Любое)return r=e.nom}),r}check_inset(t){const e=t.inset?t.inset:t.elm.inset,n=t.elm?t.elm.elm_type:t.elm_type,s=[];let i;return this._dp.sys.elmnts.forEach(t=>{if(!n||t.elm_type==n){if(t.nom===e)return i=!0,!1;s.push(t)}}),i?e:s.length?s[0].nom:void 0}check_distance(e,n,i,r,o){const{elm_types:a,cnn_types:{acn:c}}=t.enm;let l,_,h,p="string"==typeof o&&-1!=o.indexOf("node"),d="string"==typeof o?-1!=o.indexOf("generatrix"):o;function u(a){if(l=e[a].getDistance(r),l<parseFloat(s.sticking_l)){if("number"==typeof i.distance&&i.distance<l)return i.profile=e,i.profile_point=a,1;if(!0===o&&i.profile===e&&i.cnn&&c.a.includes(i.cnn.cnn_type))return i.distance>l&&(i.distance=l),i.profile_point=a,i.point=r,2;if(!n||i.cnn&&!i.cnn.empty()){if(i.cnn&&c.t.includes(i.cnn.cnn_type))return 1}else if(_=t.cat.cnns.nom_cnn(e,n,c.a),!_||!_.length)return 1;return i.point=p?e[a]:r,i.distance=l,i.profile=e,i.profile_point=a,i.cnn_types=c.a,_&&_.length&&!i.cnn&&(i.cnn=_[0]),2}}const f="b"===i.profile_point?"b":"e",m="b"===f?"e":"b";if(e===n)return void n.is_linear();if((h=u(f))||(h=u(m)))return i.cnn_types!==c.a&&i.profile_point&&(i.cnn_types=c.a,i.distance=l),2!=h&&void 0;i.profile_point="";const g=!e._attr._nearest||n&&n._attr._nearest?e.generatrix.getNearestPoint(r):e.rays.outer.getNearestPoint(r);return l=g.getDistance(r),!(l<(i.is_t||!i.is_l?s.sticking:s.sticking_l)&&((l<i.distance||d)&&(0!=e.d0&&e.rays.outer?(i.point=e.rays.outer.getNearestPoint(r),i.distance=0):(i.point=g,i.distance=l),i.profile=e,i.cnn_types=c.t),d))&&void 0}default_clr(t){return this.ox.clr}get default_furn(){for(var e,n=this._dp.sys;!(e=t.job_prm.builder.base_furn[n.ref])&&!n.empty();)n=n.parent;return e||(e=t.job_prm.builder.base_furn.null),e||t.cat.furns.find_rows({is_folder:!1,is_set:!1,id:{not:""}},t=>(e=t,!1)),e}selected_profiles(t){const e=[],n=this.selectedItems.length;return this.selectedItems.forEach(s=>{const i=s.parent;if(i instanceof z&&(t||!s.layer.parent||!i.nearest||!i.nearest(!0))){if(-1!=e.indexOf(i))return;!(n<2)&&i._attr.generatrix.firstSegment.selected^i._attr.generatrix.lastSegment.selected||e.push(i)}}),e}selected_glasses(){const t=[];return this.selectedItems.forEach(e=>{e instanceof w&&-1==t.indexOf(e)?t.push(e):e.parent instanceof w&&-1==t.indexOf(e.parent)&&t.push(e.parent)}),t}get selected_elm(){let t;return this.selectedItems.some(e=>e instanceof b?t=e:e.parent instanceof b?t=e.parent:void 0),t}hitPoints(t,e,n,i){let r,o=1/0;function a(e){const n=e.corns(t);n.dist<o&&(o=n.dist,n.dist<s.sticking&&(r={item:e.generatrix,point:n.point}))}if(n)this.selectedItems.some(n=>r=n.hitTest(t,{segments:!0,tolerance:e||8})),r||(r=this.hitTest(t,{segments:!0,tolerance:e||6}));else{for(let t of this.activeLayer.profiles){a(t);for(let e of t.addls)a(e)}if(i)for(let t of this.activeLayer.onlays)a(t)}return r}rootLayer(t){for(t||(t=this.activeLayer);t.parent;)t=t.parent;return t}deselect_all_points(t){const e=[];return this.getItems({class:n.Path}).forEach(n=>{n.segments.forEach(t=>{t.selected&&(t.selected=!1,e.push(t))}),t&&n.selected&&(n.selected=!1,e.push(n))}),e}get perimeter(){let t=this.contours;return 1==t.length?t[0].perimeter:[]}get glasses(){return this.getItems({class:w})}get skeleton(){return this._skeleton}set skeleton(t){const{_skeleton:e}=this;e.skeleton=!!t}}i.Scheme=D;class T extends n.PointText{constructor(t){t.justification="center",t.fontFamily=s.font_family,super(t),this._edit=null,this._owner=t._owner,!this.project._attr._from_service&&this.on({mouseenter:this.mouseenter,mouseleave:this.mouseleave,click:this.click})}mouseenter(t){this.project._scope.canvas_cursor("cursor-arrow-ruler-light")}mouseleave(t){this.project._scope.canvas_cursor("cursor-arrow-white")}click(t){if(!this._edit){const{view:t,bounds:e}=this,n=t.projectToView(e.topLeft),s=this._edit=document.createElement("INPUT");t.element.parentNode.appendChild(s),s.style=`left: ${(n.x-4).toFixed()}px; top: ${n.y.toFixed()}px; width: 60px; border: none; position: absolute;`,s.onblur=()=>setTimeout(()=>this.edit_remove()),s.onkeydown=this.edit_keydown.bind(this),s.value=this.content.replace(/\D$/,""),setTimeout(()=>{s.focus(),s.select()})}}edit_keydown(t){switch(t.code){case"Escape":case"Tab":return this.edit_remove();case"Enter":case"NumpadEnter":return this.apply(parseFloat(this._edit.value)),this.edit_remove();case"Digit0":case"Digit1":case"Digit2":case"Digit3":case"Digit4":case"Digit5":case"Digit6":case"Digit7":case"Digit8":case"Digit9":case"Numpad0":case"Numpad1":case"Numpad2":case"Numpad3":case"Numpad4":case"Numpad5":case"Numpad6":case"Numpad7":case"Numpad8":case"Numpad9":case".":case"Period":case"NumpadDecimal":case"ArrowRight":case"ArrowLeft":case"Delete":case"Backspace":break;case"Comma":case",":t.code=".";break;default:return t.preventDefault(),t.stopPropagation(),!1}}edit_remove(){this._edit&&(this._edit.parentNode&&this._edit.parentNode.removeChild(this._edit),this._edit=null)}remove(){this.edit_remove(),super.remove()}}class L extends T{constructor(t){t.fillColor="blue",super(t),this._ind=t._ind}apply(t){const{project:e,generatrix:s,_attr:i}=this._owner,{zoom:r}=i,{curves:o,segments:a}=s,c=o[this._ind-1],l=o[this._ind],_=c.getLocationAtTime(.9),h=l.getLocationAtTime(.1);c.point2;let p=h.tangent.angle-_.tangent.negate().angle;p<0&&(p+=360);const d=p>180;d&&(p=360-p);const u=new n.Point([l.point2.x-l.point1.x,l.point2.y-l.point1.y]),f=u.clone();f.angle+=d?p-t:t-p;const m=f.subtract(u);let g;for(const t of a)t.point.equals(l.point2)&&(g=!0),g&&(t.point=t.point.add(m));e.register_change(!0)}}class I extends T{constructor(t){t.fillColor="black",super(t)}apply(t){const{path:e,segment1:n,segment2:s,length:i}=this._owner,{parent:{_attr:r,project:o},segments:a}=e,{zoom:c}=r,l=n.curve.getTangentAtTime(1).multiply(t*c-i);let _;for(const t of a)t===s&&(_=!0),_&&(t.point=t.point.add(l));o.register_change(!0)}}class M extends v{initialize(e){const{project:s,_attr:i,_row:r}=this,o=s.bounds.height+s.bounds.y;if(i._rays={b:{},e:{},clear(){}},i.children=[],i.zoom=5,i.radius=50,e.generatrix)i.generatrix=e.generatrix;else if(r.path_data)i.generatrix=new n.Path(r.path_data);else{const t=new n.Point([r.x1,o-r.y1]);i.generatrix=new n.Path(t),r.r?i.generatrix.arcTo(t.arc_point(r.x1,o-r.y1,r.x2,o-r.y2,r.r+.001,r.arc_ccw,!1),[r.x2,o-r.y2]):i.generatrix.lineTo([r.x2,o-r.y2])}i.generatrix.strokeColor="black",i.generatrix.strokeWidth=1,i.generatrix.strokeScaling=!1,this.clr=r.clr.empty()?t.job_prm.builder.base_clr:r.clr,this.addChild(i.generatrix)}redraw(){const{layer:t,generatrix:e,_attr:n,radius:s}=this,{children:i,zoom:r}=n,{segments:o,curves:a}=e;for(let t of i)t.remove();for(let t=1;t<o.length-1;t++)this.draw_angle(t);for(let e of a){const n=e.getLocationAtTime(.5),o=n.normal.normalize(s);i.push(new I({point:n.point.add(o).add([0,o.y<0?0:o.y/2]),content:(e.length/r).toFixed(0),fontSize:1.4*s,parent:t,_owner:e}))}return this}draw_angle(t){const{layer:e,generatrix:s,_attr:i,radius:r}=this;let{children:o,zoom:a}=i;const{curves:c}=s,l=c[t-1],_=c[t],h=l.getLocationAtTime(.9),p=_.getLocationAtTime(.1),d=l.point2;let u=p.tangent.angle-h.tangent.negate().angle;if(u<0&&(u+=360),u>180&&(u=360-u),l.length<r||_.length<r||180-u<1)return;const f=l.getLocationAt(l.length-r).point,m=_.getLocationAt(r).point,g=d.subtract(f.add(m).divide(2)).normalize(r).negate();o.push(new n.Path.Arc({from:f,through:d.add(g),to:m,strokeColor:"grey",guide:!0,parent:e})),o.push(new L({point:d.add(g.multiply(-2.2)),content:u.toFixed(0)+"°",fontSize:1.4*r,parent:e,_owner:this,_ind:t}))}save_coordinates(){const{_row:t,generatrix:e}=this;e&&(t.x1=this.x1,t.y1=this.y1,t.x2=this.x2,t.y2=this.y2,t.path_data=e.pathData,t.nom=this.nom,t.len=this.length.round(1),t.elm_type=this.elm_type)}cnn_point(){}get length(){const{generatrix:t,zoom:e}=this._attr;return t.length/e}get rays(){return this._attr._rays}get elm_type(){return t.enm.elm_types.Водоотлив}get radius(){let{generatrix:t,radius:e}=this._attr;const{height:n,width:i}=t.bounds,r=Math.max(i-s.cutoff,n-s.cutoff);return r>0&&(e+=r/60),e}}i.Sectional=M,i.EditableText=T,i.AngleText=L;t.pricing=new class{constructor({md:t,adapters:e}){t.once("predefined_elmnts_inited",()=>{const{pouch:t}=e;t.local.templates||t.props.user_node?this.load_prices():t.once("on_log_in",()=>this.load_prices())})}load_prices(){const{adapters:{pouch:e},job_prm:n}=t;return!1===n.use_ram?Promise.resolve():this.by_local().then(t=>!t&&this.by_range()).then(()=>{const{doc:{calc_order:n},wsql:s}=t;e.emit("pouch_complete_loaded"),e.local.doc===e.remote.doc&&e.local.doc.changes({since:"now",live:!0,include_docs:!0,selector:{class_name:{$in:["doc.nom_prices_setup",n.class_name]}}}).on("change",t=>{if("doc.nom_prices_setup"==t.doc.class_name)setTimeout(()=>this.by_doc(t.doc),500);else if(t.doc.class_name==n.class_name){if(e.props.user_node)return n.emit("change",t.doc);const i=n.by_ref[t.id.substr(15)],r=e.authorized||s.get_user_param("user_name");if(!i||r===t.doc.timestamp.user)return;e.load_changes({docs:[t.doc],update_only:!0})}})})}build_cache(e){const{nom:n,currencies:s}=t.cat,i="Индекс цен номенклатуры";for(const{key:r,value:o}of e){if(!Array.isArray(o))return setTimeout(()=>t.iface.do_reload("",i),1e3);const e=n.get(r[0],!1,!0);if(!e||!e._data){t.record_log({class:"error",note:i,obj:{nom:r[0],value:o}});continue}e._data._price||(e._data._price={});const{_price:a}=e._data;a[r[1]]||(a[r[1]]={}),a[r[1]][r[2]]=o.map(t=>({date:new Date(t.date),currency:s.get(t.currency),price:t.price}))}}build_cache_local(e){const{nom:n,currencies:s}=t.cat,i=new Date("2010-01-01");for(const t in e){if("_"===t[0]||"remote_rev"===t)continue;const r=n.get(t,!1,!0),o=e[t];if(r&&r._data){r._data._price=o;for(const t in o)for(const e in o[t]){const n=o[t][e][0];n.date=i,n.currency=s.get(n.currency)}}}}sync_local(e,n=0){const{utils:s}=t;return e.remote.templates.get("_local/price_"+n).then(t=>e.remote.templates===e.local.templates?(this.build_cache_local(t),this.sync_local(e,++n)):e.local.templates.get("_local/price_"+n).catch(()=>({})).then(i=>(i.remote_rev!==t._rev&&(t.remote_rev=t._rev,i._rev?t._rev=i._rev:delete t._rev,e.local.templates.put(s._clone(t))),this.build_cache_local(t),this.sync_local(e,++n)))).catch(t=>{if(0!==n)return e.remote.templates!==e.local.templates&&e.local.templates.get("_local/price_"+n).then(t=>e.local.templates.remove(t)).catch(()=>null),!0})}by_local(e=0){const{adapters:{pouch:n},job_prm:s}=t;return n.local.templates?(0===e&&("http"!==n.local.templates.adapter||s.user_node&&s.user_node.templates)&&n.authorized?n.remote.templates.info().then(()=>this.sync_local(n)).catch(t=>null):Promise.resolve()).then(t=>t||n.local.templates.get("_local/price_"+e)).then(t=>!0===t?t:(this.build_cache_local(t),n.emit("nom_prices",++e),this.by_local(e))).catch(t=>0!==e):Promise.resolve(!1)}by_range(e,n=0){const{pouch:s}=t.adapters,{templates:i,doc:r}=s.local;return(i||r).query("doc/doc_nom_prices_setup_slice_last",{limit:600,include_docs:!1,startkey:e||[""],endkey:["￰"],reduce:!0,group:!0}).then(t=>{if(this.build_cache(t.rows),s.emit("nom_prices",++n),600===t.rows.length)return this.by_range(t.rows[t.rows.length-1].key,n)}).catch(e=>{t.record_log(e)})}by_doc({goods:e}){const n=e.map(({nom:t,nom_characteristic:e,price_type:n})=>[t,e,n]),{templates:s,doc:i}=t.adapters.pouch.local;return(s||i).query("doc/doc_nom_prices_setup_slice_last",{include_docs:!1,keys:n,reduce:!0,group:!0}).then(t=>{this.build_cache(t.rows)})}nom_price(t,e,n,s,i){if(i&&s){const{_owner:r}=s.calc_order_row._owner,o={price_type:n,characteristic:e,date:r.date,currency:r.doc_currency};return n!=s.price_type.price_type_first_cost||s.price_type.formula.empty()?n!=s.price_type.price_type_sale||s.price_type.sale_formula.empty()||(o.formula=s.price_type.sale_formula):o.formula=s.price_type.formula,e.clr.empty()||(o.clr=e.clr),i.price=t._price(o),i.price}}price_type(e){const{utils:n,job_prm:s,enm:i,ireg:r,cat:o}=t,a=o.formulas.get(),c=o.nom_prices_types.get();e.price_type={marginality:1.9,marginality_min:1.2,marginality_internal:1.5,discount:0,discount_external:10,extra_charge_external:0,price_type_first_cost:c,price_type_sale:c,price_type_internal:c,formula:a,sale_formula:a,internal_formula:a,external_formula:a};const{calc_order_row:l}=e,{nom:_,characteristic:h}=l,{partner:p}=l._owner._owner,d=_.price_group.empty()?{price_group:_.price_group}:{price_group:{in:[_.price_group,o.price_groups.get()]}},u=[];return r.margin_coefficients.find_rows(d,t=>{let e=!0;t.key.empty()||t.key.params.forEach(t=>{const{property:s}=t;if(s.is_calculated)e=n.check_compare(s.calculated_value({calc_order_row:l}),s.extract_value(t),t.comparison_type,i.comparison_types);else if(s.empty()){const n=o.partners.get(t._obj.value);n&&!n.empty()&&(e=n==p)}else{let r;h.params.find_rows({cnstr:0,param:s},t=>(r=t,!1)),e=!!r&&n.check_compare(r.value,s.extract_value(t),t.comparison_type,i.comparison_types)}if(!e)return!1}),e&&u.push(t)}),u.length&&(u.sort((t,e)=>!t.key.empty()&&e.key.empty()||t.key.priority>e.key.priority?-1:t.key.empty()&&!e.key.empty()||t.key.priority<e.key.priority?1:t.price_group.ref>e.price_group.ref?-1:t.price_group.ref<e.price_group.ref?1:0),Object.keys(e.price_type).forEach(t=>{e.price_type[t]=u[0][t]})),p.extra_fields.find_rows({property:s.pricing.dealer_surcharge},t=>{const n=parseFloat(t.value);return n&&(e.price_type.extra_charge_external=n),!1}),e.price_type}calc_first_cost(e){const{marginality_in_spec:n}=t.job_prm.pricing,s={},{calc_order_row:i,spec:r}=e;r&&(r.count()?(r.forEach(t=>{const{_obj:i,nom:r,characteristic:o}=t;if(this.nom_price(r,o,e.price_type.price_type_first_cost,e,i),i.amount=i.price*i.totqty1,n){s.nom=r;const t=this.nom_price(r,o,e.price_type.price_type_sale,e,s);i.amount_marged=t*i.totqty1}}),i.first_cost=r.aggregate([],["amount"]).round(2)):(s.nom=i.nom,s.characteristic=i.characteristic,i.first_cost=this.nom_price(s.nom,s.characteristic,e.price_type.price_type_first_cost,e,s)),e.order_rows&&e.order_rows.forEach(t=>{const e={spec:t.characteristic.specification,calc_order_row:t};this.price_type(e),this.calc_first_cost(e)}))}calc_amount(e){const{calc_order_row:n,price_type:s,first_cost:i}=e,{marginality_in_spec:r,not_update:o}=t.job_prm.pricing,{rounding:a}=n._owner._owner;if(n.price&&o&&(o.includes(n.nom)||o.includes(n.nom.parent)));else{const t=r&&e.spec.count()?e.spec.aggregate([],["amount_marged"]):this.nom_price(n.nom,n.characteristic,s.price_type_sale,e,{});n.price=t?t.round(a):r&&!i?this.nom_price(n.nom,n.characteristic,s.price_type_sale,e,{}):(n.first_cost*s.marginality).round(a)}n.marginality=n.first_cost?n.price*((100-n.discount_percent)/100)/n.first_cost:0;let c=t.wsql.get_user_param("surcharge_internal","number");t.current_user.partners_uids.length&&c||(c=s.extra_charge_external||0),n.price_internal=(n.price*(100-n.discount_percent)/100*(100+c)/100).round(a),!e.hand_start&&n.value_change("price",{},n.price,!0),e.order_rows&&e.order_rows.forEach(t=>{const e={spec:t.characteristic.specification,calc_order_row:t};this.price_type(e),this.calc_amount(e)})}from_currency_to_currency(e,n,s,i){const{main_currency:r}=t.job_prm.pricing;if(i&&!i.empty()||(i=r),s&&!s.empty()||(s=r),s==i)return e;n||(n=new Date),this.cource_sql||(this.cource_sql=t.wsql.alasql.compile("select top 1 * from `ireg_currency_courses` where `currency` = ? and `period` <= ? order by `period` desc"));let o={course:1,multiplicity:1},a={course:1,multiplicity:1};if(s!=r){const t=this.cource_sql([s.ref,n]);t.length&&(o=t[0])}if(i!=r){const t=this.cource_sql([i.ref,n]);t.length&&(a=t[0])}return e*o.course/o.multiplicity*a.multiplicity/a.course}cut_upload(){if(!t.current_user.role_available("СогласованиеРасчетовЗаказов")&&!t.current_user.role_available("ИзменениеТехнологическойНСИ"))return t.msg.show_msg({type:"alert-error",text:t.msg.error_low_acl,title:t.msg.error_rights}),!0;function e(){const e=["cat.units","cat.nom","cat.nom_groups","cat.nom_units","cat.nom_kinds","cat.elm_visualization","cat.destinations","cat.property_values","cat.property_values_hierarchy","cat.inserts","cat.insert_bind","cat.color_price_groups","cat.clrs","cat.furns","cat.cnns","cat.production_params","cat.parameters_keys","cat.formulas","cch.properties","cch.predefined_elmnts"],{pouch:n}=t.adapters;n.local.ram.replicate.to(n.remote.ram,{filter:t=>-1!=e.indexOf(t._id.split("|")[0])}).on("change",t=>{}).on("paused",t=>{}).on("active",()=>{}).on("denied",e=>{t.msg.show_msg(e.reason),t.record_log(e)}).on("complete",e=>{t.msg.show_msg({type:"alert-info",text:t.msg.sync_complite,title:t.msg.sync_title})}).on("error",e=>{t.msg.show_msg(e.reason),t.record_log(e)})}t.current_user.role_available("СогласованиеРасчетовЗаказов")?function(){const n=["cat.users","cat.individuals","cat.organizations","cat.partners","cat.contracts","cat.currencies","cat.nom_prices_types","cat.price_groups","cat.cashboxes","cat.partner_bank_accounts","cat.organization_bank_accounts","cat.projects","cat.stores","cat.cash_flow_articles","cat.cost_items","cat.price_groups","cat.delivery_areas","ireg.currency_courses","ireg.margin_coefficients"],{pouch:s}=t.adapters;s.local.ram.replicate.to(s.remote.ram,{filter:t=>-1!=n.indexOf(t._id.split("|")[0])}).on("change",t=>{}).on("paused",t=>{}).on("active",()=>{}).on("denied",e=>{t.msg.show_msg(e.reason),t.record_log(e)}).on("complete",n=>{t.current_user.role_available("ИзменениеТехнологическойНСИ")?e():t.msg.show_msg({type:"alert-info",text:t.msg.sync_complite,title:t.msg.sync_title})}).on("error",e=>{t.msg.show_msg(e.reason),t.record_log(e)})}():e()}}(t);class F{constructor(e){let n,s,i,r,o,a,c,l;function _(t,e){let n=a.find_rows({elm1:t,elm2:e});return n.length?n[0].row:(n=a.find_rows({elm1:e,elm2:t}),n.length?n[0].row:0)}function h(e,s,i,r){if(e&&e.cnn_type==t.enm.cnn_types.xx){n.points||(n.points=[]);for(let t of n.points)if(t.is_nearest(r,!0))return!1;return n.points.push(r),!0}return!!(e&&s&&i&&n[s]!=i&&n[i]!=s)&&(n[s]=i,!0)}function p(e,n,r,o){if(!e)return;const{enm:a,CatInserts:c,utils:l}=t,_=e.cnn_type==a.cnn_types.ii?-1:1,{new_spec_row:h,calc_count_area_mass:p}=F;e.filtered_spec({elm:n,len_angl:r,ox:s}).forEach(t=>{const{nom:a}=t;if(a instanceof c)if(r&&(t.sz||t.coefficient)){const e=l._clone(r);e.len=(r.len-2*_*t.sz)*(t.coefficient||.001),a.calculate_spec({elm:n,len_angl:e,ox:s})}else a.calculate_spec({elm:n,len_angl:r,ox:s});else{const c=h({row_base:t,origin:r.origin||e,elm:n,nom:a,spec:i,ox:s});if(a.is_pieces)t.coefficient?c.qty=((r.len-2*_*t.sz)*t.coefficient*t.quantity-.5).round(a.rounding_quantity):c.qty=t.quantity;else if(c.qty=t.quantity,t.sz||t.coefficient){let e,n,s=t.sz;o&&o.specification.find_rows({nom:a},t=>(s+=t.sz,n=t.quantity,!(e=!0))),e||(s*=2),!c.qty&&e&&r.art1&&(c.qty=n),c.len=(r.len-_*s)*(t.coefficient||.001)}if(!t.formula.empty()){const e=t.formula.execute({ox:s,elm:n,len_angl:r,cnstr:0,inset:l.blank.guid,row_cnn:t,row_spec:c});t.formula.condition_formula&&!e&&(c.qty=0)}p(c,i,r,t.angle_calc_method)}})}function d(e){if(!e.parent)return!1;const{furn_cache:n,furn:r}=e,{new_spec_row:o,calc_count_area_mass:a}=F;if(!function(e,n){let r=!0;const{new_spec_row:o}=F,{side_count:a,furn:c,direction:l}=e;if(c.open_type!==t.enm.open_types.Глухое&&c.side_count&&a!==c.side_count){const n={clr:t.cat.clrs.get(),nom:t.job_prm.nom.furn_error};return e.profiles.forEach(t=>{o({elm:t,row_base:n,origin:c,spec:i,ox:s})}),r=!1}return c.open_tunes.forEach(_=>{const h=e.profile_by_furn_side(_.side,n),p=e.profile_by_furn_side(1===_.side?a:_.side-1,n),d=e.profile_by_furn_side(_.side===a?1:_.side+1,n),u=h._row.len-p.nom.sizefurn-d.nom.sizefurn,f=l==t.enm.open_directions.Правое?h.generatrix.angle_to(p.generatrix,h.e):p.generatrix.angle_to(h.generatrix,h.b),{lmin:m,lmax:g,amin:y,amax:b}=_;(u<m||u>g||f<y||f>b&&b>0||!h.is_linear()&&!_.arc_available)&&(o({elm:h,row_base:{clr:t.cat.clrs.get(),nom:t.job_prm.nom.furn_error},origin:c,spec:i,ox:s}),r=!1)}),r}(e,n))return;e.update_handle_height(n);const c=t.cat.clrs.get(),{cnstr:l}=e;if(r.furn_set.get_spec(e,n).forEach(t=>{const e=o({elm:{elm:-l,clr:c},row_base:t,origin:t.origin,specify:t.specify,spec:i,ox:s});t.is_procedure_row?(e.elm=t.handle_height_min,e.len=t.coefficient/1e3,e.qty=0,e.totqty=1,e.totqty1=1):(e.qty=t.quantity*(t.coefficient?t.coefficient:1),a(e,i))}),r.furn_set.flap_weight_max){const n=new Map;let a=0;if(i.forEach(t=>{if(t.elm>0){if(!n.get(t.elm)){const e=s.coordinates.find({elm:t.elm});n.set(t.elm,e?e.cnstr:1/0)}if(n.get(t.elm)!==l)return}else if(t.elm!==-l)return;a+=t.nom.density*t.totqty}),a>r.furn_set.flap_weight_max){const n={clr:c,nom:t.job_prm.nom.flap_weight_max};e.profiles.forEach(t=>{o({elm:t,row_base:n,origin:r,spec:i,ox:s})})}}}function u(e){const{_row:n,rays:r}=e;if(n.nom.empty()||n.nom.is_service||n.nom.is_procedure||n.clr==t.cat.clrs.predefined("НеВключатьВСпецификацию"))return;const{b:o,e:a}=r;if(!o.cnn||!a.cnn)return;o.check_err(),a.check_err();const c=o.profile,l=a.profile,d=o.cnn&&o.cnn.main_row(e),f=a.cnn&&a.cnn.main_row(e),{new_spec_row:m,calc_count_area_mass:g}=F;let y;const b=d||f;if(b){y=m({elm:e,row_base:b,nom:n.nom,origin:_(n.elm,c?c.elm:0),spec:i,ox:s}),y.qty=b.quantity;const r=t.enm.angle_calculating_ways.СварнойШов,h=Math.sin(Math.PI/4),p=d?d.angle_calc_method==r&&n.alp1>0?d.sz*h/Math.sin(n.alp1/180*Math.PI):d.sz:0,u=f?f.angle_calc_method==r&&n.alp2>0?f.sz*h/Math.sin(n.alp2/180*Math.PI):f.sz:0;y.len=(n.len-p-u)*((d?d.coefficient:.001)+(f?f.coefficient:.001))/2,e._attr._len=n.len,n.len=1e3*(n.len-(d&&d.angle_calc_method!=r?d.sz:0)-(f&&f.angle_calc_method!=r?f.sz:0))*((d?d.coefficient:.001)+(f?f.coefficient:.001))/2,e.is_linear()||(y.len=y.len+n.nom.arc_elongation/1e3),d&&!d.formula.empty()?d.formula.execute({ox:s,elm:e,cnstr:0,inset:t.utils.blank.guid,row_cnn:d,row_spec:y}):f&&!f.formula.empty()&&f.formula.execute({ox:s,elm:e,cnstr:0,inset:t.utils.blank.guid,row_cnn:f,row_spec:y});const w=d?d.angle_calc_method:null,x=f?f.angle_calc_method:null,{СоединениеПополам:v,Соединение:j}=t.enm.angle_calculating_ways;g(y,i,n,w,x,w==v||w==j?c.generatrix.angle_to(e.generatrix,o.point):0,x==v||x==j?e.generatrix.angle_to(l.generatrix,a.point):0)}const w={angle:0,alp1:c?c.generatrix.angle_to(e.generatrix,e.b,!0):90,alp2:l?e.generatrix.angle_to(l.generatrix,e.e,!0):90,len:y?1e3*y.len:n.len,art1:!1,art2:!0,node:"e"};h(o.cnn,n.elm,c?c.elm:0,o.point)&&(w.angle=w.alp2,o.cnn.cnn_type==t.enm.cnn_types.t||o.cnn.cnn_type==t.enm.cnn_types.i||o.cnn.cnn_type==t.enm.cnn_types.xx?h(a.cnn,l?l.elm:0,n.elm,a.point)&&p(a.cnn,e,w,o.cnn):p(a.cnn,e,w,o.cnn),w.angle=w.alp1,w.art2=!1,w.art1=!0,w.node="b",p(o.cnn,e,w,a.cnn)),e.inset.calculate_spec({elm:e,ox:s}),function(e){const n=e.nearest();n&&n._row.clr!=t.cat.clrs.predefined("НеВключатьВСпецификацию")&&e._attr._nearest_cnn&&p(e._attr._nearest_cnn,e,{angle:0,alp1:0,alp2:0,len:e._attr._len,origin:_(e.elm,n.elm)})}(e),e.addls.forEach(u);const x=i;s.inserts.find_rows({cnstr:-e.elm},({inset:n,clr:r})=>{if(n.is_order_row==t.enm.specification_order_row_types.Продукция){const t=Object.assign(s.find_create_cx(e.elm,n.ref),n.contour_attrs(e.layer));s._order_rows.push(t),i=t.specification.clear()}else i=x;w.origin=n,w.angle=e.angle_hor,w.cnstr=-e.elm,delete w.art1,delete w.art2,n.calculate_spec({elm:e,len_angl:w,ox:s,spec:i})}),i=x}function f(e){const{_row:n,_attr:r,inset:o,layer:a}=e;if(n.nom.empty()||n.nom.is_service||n.nom.is_procedure||n.clr==t.cat.clrs.predefined("НеВключатьВСпецификацию"))return;o.calculate_spec({elm:e,ox:s});const c=i;s.inserts.find_rows({cnstr:-e.elm},({inset:n,clr:r})=>{if(n.is_order_row==t.enm.specification_order_row_types.Продукция){const t=Object.assign(s.find_create_cx(e.elm,n.ref),n.contour_attrs(a));s._order_rows.push(t),i=t.specification.clear()}else i=c;const o={angle:0,alp1:0,alp2:0,len:0,origin:n,cnstr:-e.elm};n.calculate_spec({elm:e,len_angl:o,ox:s,spec:i})}),i=c}function m(e){const{profiles:n,imposts:r,_row:o}=e;if(o.clr==t.cat.clrs.predefined("НеВключатьВСпецификацию"))return;const c=n.length;for(let e=0;e<c;e++){const s=n[e];if(s.profile&&s.profile._row.clr==t.cat.clrs.predefined("НеВключатьВСпецификацию"))return;const i=(0==e?n[c-1]:n[e-1]).profile,r=(e==c-1?n[0]:n[e+1]).profile,l=a.find_rows({elm1:o.elm,elm2:s.profile.elm}),h={angle:0,alp1:i.generatrix.angle_to(s.profile.generatrix,s.b,!0),alp2:s.profile.generatrix.angle_to(r.generatrix,s.e,!0),len:l.length?l[0].aperture_len:0,origin:_(o.elm,s.profile.elm)};h.len>3&&p(s.cnn,s.profile,h)}e.inset.calculate_spec({elm:e,ox:s}),r.forEach(u);const l=i;s.inserts.find_rows({cnstr:-e.elm},({inset:n,clr:r})=>{const o={angle:0,alp1:0,alp2:0,len:0,origin:n,cnstr:-e.elm};if(n.is_order_row==t.enm.specification_order_row_types.Продукция){const t=Object.assign(s.find_create_cx(e.elm,n.ref),n.contour_attrs(e.layer));s._order_rows.push(t),i=t.specification.clear()}else i=l;n.calculate_spec({elm:e,len_angl:o,ox:s,spec:i})}),i=l}function g(e){const n=i;s.inserts.find_rows({cnstr:e.cnstr},({inset:r,clr:o})=>{if(r.is_order_row==t.enm.specification_order_row_types.Продукция){const t=Object.assign(s.find_create_cx(-e.cnstr,r.ref),r.contour_attrs(e));s._order_rows.push(t),i=t.specification.clear()}else i=n;const a={_row:{},elm:0,clr:o,layer:e},c={angle:0,alp1:0,alp2:0,len:0,origin:r,cnstr:e.cnstr};r.calculate_spec({elm:a,len_angl:c,ox:s,spec:i})}),i=n}this.recalc=function(e,_){function h(){delete e._attr._saving,s._data._loading=!1}return s=e.ox,i=s.specification,r=s.constructions,o=s.coordinates,a=s.cnn_elmnts,c=s.glass_specification,l=s.params,i.clear(),s._order_rows=[],function(e){const{Contour:s,Filling:i,Sectional:r,Profile:o,ProfileConnective:a}=t.Editor;n={};for(const t of e.getItems({class:s})){for(const e of t.children)e instanceof o&&u(e);for(const e of t.children)e instanceof i?m(e):e instanceof r&&f(e);d(t),g(t)}for(const t of e.l_connective.children)t instanceof a&&u(t);g({cnstr:0,project:e,get perimeter(){return this.project.perimeter}})}(e),i.group_by("nom,clr,characteristic,len,width,s,elm,alp1,alp2,origin,specify,dop","qty,totqty,totqty1"),e.draw_visualization(),Promise.resolve().then(()=>e._scope&&!_.silent&&e._scope.eve.emit("coordinates_calculated",e,_)),s.calc_order_row&&t.spec_building.specification_adjustment({scheme:e,calc_order_row:s.calc_order_row,spec:i,save:_.save},!0),_.snapshot&&e.notify(e,"scheme_snapshot",_),_.save?(!1!==_.svg&&(s.svg=e.get_svg()),s.save().then(()=>{!1!==_.svg&&t.msg.show_msg([s.name,"Спецификация рассчитана"]),h(),s.calc_order.characteristic_saved(e,_),e._scope&&!_.silent&&e._scope.eve.emit("characteristic_saved",e,_)}).then(()=>{if(!e._attr._from_service&&!_._from_service&&(e._scope||_.close))return new Promise((t,e)=>{setTimeout(()=>s.calc_order._modified?s.calc_order.save().then(t).catch(e):t(s),1e3)})}).catch(e=>{if(h(),e.msg&&e.msg._shown)return;let n=e.message||e;if(s._data&&s._data._err){if("object"===typeof s._data._err)return!_.silent&&t.md.emit("alert",Object.assign({obj:s},s._data._err)),void delete s._data._err;n+="\n"+s._data._err,delete s._data._err}!_.silent&&t.md.emit("alert",{type:"alert-error",obj:s,text:n})})):Promise.resolve(h())}}static check_params({params:t,row_spec:e,elm:n,cnstr:s,origin:i,ox:r}){let o=!0;return t.find_rows({elm:e.elm},t=>{if(o=t.param.check_condition({row_spec:e,prm_row:t,elm:n,cnstr:s,origin:i,ox:r}),!o)return!1}),o}static new_spec_row({row_spec:e,elm:n,row_base:s,nom:i,origin:r,specify:o,spec:a,ox:c}){return e||(e=a.add()),e.nom=i||s.nom,e.nom.visualization.empty()?e.nom.is_procedure&&(e.dop=-2):e.dop=-1,e.characteristic=s.nom_characteristic,e.characteristic.empty()||e.characteristic.owner==e.nom||(e.characteristic=t.utils.blank.guid),e.clr=t.cat.clrs.by_predefined(s?s.clr:n.clr,n.clr,c.clr,n,a),e.elm=n.elm,r&&(e.origin=r),o&&(e.specify=o),e}static calc_qty_len(e,n,s){const{nom:i}=e;i.cutting_optimization_type==t.enm.cutting_optimization_types.Нет||i.cutting_optimization_type.empty()||i.is_pieces?n.coefficient&&s?i.is_pieces?i.rounding_quantity?e.qty=((s-n.sz)*n.coefficient*n.quantity).round(i.rounding_quantity):e.qty=Math.round((s-n.sz)*n.coefficient*n.quantity-.5):(e.qty=n.quantity,e.len=(s-n.sz)*(n.coefficient||.001),i.rounding_quantity&&(e.qty=(e.qty*e.len).round(i.rounding_quantity),e.len=0)):e.qty=n.quantity:(e.qty=n.quantity,e.len=(s-n.sz)*(n.coefficient||.001))}static calc_count_area_mass(e,n,s,i,r,o,a){if(e.qty){if(!e.totqty1||!e.totqty){if(r||(r=i),i&&!e.nom.is_pieces){const{Основной:n,СварнойШов:c,СоединениеПополам:l,Соединение:_,_90:h}=t.enm.angle_calculating_ways;i==n||i==c?e.alp1=s.alp1:i==h?e.alp1=90:i==l?e.alp1=(o||s.alp1)/2:i==_&&(e.alp1=o||s.alp1),r==n||r==c?e.alp2=s.alp2:r==h?e.alp2=90:r==l?e.alp2=(a||s.alp2)/2:r==_&&(e.alp2=a||s.alp2)}e.len?e.width&&!e.s&&(e.s=e.len*e.width):e.s=0,e.s?e.totqty=e.qty*e.s:e.len?e.totqty=e.qty*e.len:e.totqty=e.qty,e.totqty1=e.totqty*e.nom.loss_factor,["len","width","s","qty","alp1","alp2"].forEach(t=>e[t]=e[t].round(4)),["totqty","totqty1"].forEach(t=>e[t]=e[t].round(6))}}else e.dop>=0&&n.del(e.row-1,!0)}}"undefined"!==typeof e&&(e.ProductsBuilding=F),t.ProductsBuilding=F,t.products_building=new F(!0);var R;t.spec_building=new class{constructor(t){}calc_row_spec(t,e){}specification_adjustment(e,n){const{cat:s,pricing:i}=t,{scheme:r,calc_order_row:o,spec:a,save:c}=e,l=o._owner._owner,_=new Map,h=[],p=o.characteristic;p.empty()?o.nom:o.nom=p.owner;i.price_type(e),a.find_rows({ch:{in:[-1,-2]}},t=>h.push(t)),h.forEach(t=>a.del(t,!0)),s.insert_bind.insets(p).forEach(({inset:t,elm_type:e})=>{const n={_row:{},elm:0,get perimeter(){return r?r.perimeter:[]},clr:p.clr,project:r},s={angle:0,alp1:0,alp2:0,len:0,cnstr:0,origin:t};t.calculate_spec({elm:n,len_angl:s,ox:p,spec:a})}),p.empty()||(h.length=0,l.production.forEach(t=>{t.ordn===p&&(-1===p._order_rows.indexOf(t.characteristic)?h.push(t):_.set(t.characteristic,t))}),h.forEach(t=>l.production.del(t.row-1)));const d=[];return p._order_rows&&p._order_rows.forEach(t=>{const e=_.get(t)||l.production.add({characteristic:t});e.nom=t.owner,e.unit=e.nom.storage_unit,e.ordn=p,e.len=t.x,e.width=t.y,e.s=t.s,e.qty=o.qty,e.quantity=o.quantity,c&&d.push(t.save()),_.set(t,e)}),_.size&&(e.order_rows=_),n&&(i.calc_first_cost(e),i.calc_amount(e)),c&&!e.scheme&&(p.is_new()||p._modified)&&d.push(p.save()),d}}(t),function({classes:{DataManager:e,CatObj:n},cat:s}){const{value_mgr:i}=e.prototype;e.prototype.value_mgr=function(e,n,s,r,o){const a=i.call(this,e,n,s,r,o);return a||("trans"==n?t.doc.calc_order:"partner"==n?t.cat.partners:void 0)}}(t),R=t.enm.cnn_types,Object.defineProperties(R,{ad:{get(){return this.УгловоеДиагональное}},av:{get(){return this.УгловоеКВертикальной}},ah:{get(){return this.УгловоеКГоризонтальной}},t:{get(){return this.ТОбразное}},ii:{get(){return this.Наложение}},i:{get(){return this.НезамкнутыйКонтур}},xt:{get(){return this.КрестПересечение}},xx:{get(){return this.КрестВСтык}},acn:{value:{ii:[R.Наложение],i:[R.НезамкнутыйКонтур],a:[R.УгловоеДиагональное,R.УгловоеКВертикальной,R.УгловоеКГоризонтальной,R.ТОбразное,R.КрестВСтык],t:[R.ТОбразное,R.КрестВСтык]}}}),function(t){const e={};t.__define({profiles:{get:()=>e.profiles||(e.profiles=[t.Рама,t.Створка,t.Импост,t.Штульп])},profile_items:{get:()=>e.profile_items||(e.profile_items=[t.Рама,t.Створка,t.Импост,t.Штульп,t.Добор,t.Соединитель,t.Раскладка])},rama_impost:{get:()=>e.rama_impost||(e.rama_impost=[t.Рама,t.Импост])},impost_lay:{get:()=>e.impost_lay||(e.impost_lay=[t.Импост,t.Раскладка])},stvs:{get:()=>e.stvs||(e.stvs=[t.Створка])},glasses:{get:()=>e.glasses||(e.glasses=[t.Стекло,t.Заполнение])}})}(t.enm.elm_types),function(t){t.additions_groups=[t.Подоконник,t.Водоотлив,t.МоскитнаяСетка,t.Жалюзи,t.Откос,t.Профиль,t.Монтаж,t.Доставка,t.Набор]}(t.enm.inserts_types),function({enm:t}){t.debit_credit_kinds.__define({debit:{get(){return this.Приход}},credit:{get(){return this.Расход}}}),t.open_types.__define({is_opening:{value(t){return!(!t||t.empty()||t==this.Глухое||t==this.Неподвижное)}}}),t.orientations.__define({hor:{get(){return this.Горизонтальная}},vert:{get(){return this.Вертикальная}},incline:{get(){return this.Наклонная}}}),t.positions.__define({left:{get(){return this.Лев}},right:{get(){return this.Прав}},top:{get(){return this.Верх}},bottom:{get(){return this.Низ}},hor:{get(){return this.ЦентрГоризонталь}},vert:{get(){return this.ЦентрВертикаль}}})}(t),function({cat:{characteristics:t,nom:e}}){const{value_mgr:n}=t.constructor.prototype;t.value_mgr=function(s,i,r,o,a){return"owner"===i?e:n.call(t,s,i,r,o,a)},t.extra_fields=function(){return[]},t._direct_ram=!0}(t),t.md.once("predefined_elmnts_inited",()=>{const e=t.cat.characteristics;(!1===t.job_prm.use_ram?Promise.resolve():e.adapter.load_view(e,"linked",{limit:1e4,include_docs:!0,startkey:[t.utils.blank.guid,"cat.characteristics"],endkey:[t.utils.blank.guid,"cat.characteristics࿿"]})).then(()=>{const{current_user:n}=t;if(n&&(n.role_available("СогласованиеРасчетовЗаказов")||n.role_available("ИзменениеТехнологическойНСИ")||n.role_available("РедактированиеЦен")))return;const{form:s}=e.metadata();s&&s.obj&&s.obj.tabular_sections&&(s.obj.tabular_sections.specification.widths="50,*,70,*,50,70,70,80,70,70,70,0,0,0")})}),t.CatCharacteristics=class extends t.CatCharacteristics{before_save(t){const{prod_nom:e,calc_order:n,_data:s}=this;if(n.is_read_only)return s._err={title:"Права доступа",type:"alert-error",text:"Запрещено изменять заказ в статусе "+n.obj_delivery_state},!1;const i=this.prod_name();i&&(this.name=i),this.partner=n.partner}add_inset_params(t,e,n){const s=this.params,i=[];s.find_rows({cnstr:e,inset:n||t},({param:t})=>{!i.includes(t)&&i.push(t)});const{product_params:r}=t;t.used_params().forEach(o=>{if((!o.is_calculated||o.show_calculated)&&!i.includes(o)){const a=r.find({param:o});s.add({cnstr:e,inset:n||t,param:o,value:a&&a.value||""}),i.push(o)}}),s.find_rows({cnstr:e,inset:n||t},t=>{const n=t.param.params_links({grid:{selection:{cnstr:e}},obj:t});t.hide=n.some(t=>t.hide)})}prod_name(e){const{calc_order_row:n,calc_order:s,leading_product:i,sys:r,clr:o,origin:a}=this;let c="";if(n){if(s.number_internal)c=s.number_internal.trim();else{let t=s.number_doc,e="";for(let e=0;e<t.length&&isNaN(parseInt(t[e]));e++)c+=t[e];for(let n=t.length-1;n>0&&!isNaN(parseInt(t[n]));n--)e=t[n]+e;c+=parseInt(e||0).toFixed(0)}if(c+="/"+n.row.pad(),i.empty()||i.calc_order.empty()||(c+=":"+i.calc_order_row.row.pad()),r.empty()?a&&!a.empty()&&(c+="/"+(a instanceof t.DocPurchase_order?this.note:a.name||a.number_doc)):c+="/"+r.name,!e){o.empty()||(c+="/"+this.clr.name),this.x&&this.y?c+="/"+this.x.toFixed(0)+"x"+this.y.toFixed(0):this.x?c+="/"+this.x.toFixed(0):this.y&&(c+="/"+this.y.toFixed(0)),this.z&&(this.x||this.y?c+="x"+this.z.toFixed(0):c+="/"+this.z.toFixed(0)),this.s&&(c+="/S:"+this.s.toFixed(3));let t="";this.params.find_rows({cnstr:0},({param:e,value:n})=>{e.include_to_name&&-1==t.indexOf(String(n))&&(t&&(t+=";"),t+=String(n))}),t&&(c+="|"+t)}}return c}open_origin(e){try{let{origin:n}=this.specification.get(e);if("number"==typeof n&&(n=this.cnn_elmnts.get(n-1).cnn),n.is_new())return t.msg.show_msg({type:"alert-warning",text:"Пустая ссылка на настройки в строке №"+(e+1),title:o.presentation});n.form_obj()}catch(e){t.record_log(e)}}find_create_cx(e,n){const{_manager:s,calc_order:i,params:r,inserts:o}=this;let a;s.find_rows({leading_product:this,leading_elm:e,origin:n},t=>{if(!t._deleted)return a=t,!1}),a||(a=t.cat.characteristics.create({calc_order:i,leading_product:this,leading_elm:e,origin:n},!1,!0)._set_loaded());const{length:c,width:l}=t.job_prm.properties;return a.params.clear(),r.find_rows({cnstr:-e,inset:n},t=>{t.param!=c&&t.param!=l&&a.params.add({param:t.param,value:t.value})}),o.find_rows({cnstr:-e,inset:n},t=>{a.clr=t.clr}),a.name=a.prod_name(),a}get calc_order_row(){let t;return this.calc_order.production.find_rows({characteristic:this},e=>(t=e,!1)),t}get prod_nom(){if(!this.sys.empty()){var e,n=this.params;1==this.sys.production.count()?this.owner=this.sys.production.get(0).nom:this.sys.production.count()>1&&(this.sys.production.forEach(t=>{if(e)return!1;t.param&&!t.param.empty()&&n.find_rows({cnstr:0,param:t.param,value:t.value},()=>(e=!0,n._owner.owner=t.nom,!1))}),e||this.sys.production.find_rows({param:t.utils.blank.guid},t=>(e=!0,n._owner.owner=t.nom,!1)),e||(this.owner=this.sys.production.get(0).nom))}return this.owner}get builder_props(){const t=this.constructor.builder_props_defaults,e={};let n;try{n=JSON.parse(this._obj.builder_props||"{}")}catch(t){n=e}for(const s in t)n.hasOwnProperty(s)?e[s]="number"===typeof n[s]?n[s]:!!n[s]:e[s]=t[s];return e}set builder_props(t){if(this.empty())return;const{_obj:e,_data:n}=this,s="builder_props";if(n&&n._loading)return void(e[s]=t);let i;e[s]&&"string"===typeof e[s]||(e[s]=JSON.stringify(this.constructor.builder_props_defaults),i=!0);const r=this.builder_props;for(const e in t)r[e]!==t[e]&&(r[e]=t[e],i=!0);i&&(e[s]=JSON.stringify(r),this.__notify(s))}recalc(e={},n){const s=!n;s&&(n=new t.EditorInvisible);const i=n.create_scheme();return i.load(this,!0).then(()=>{i.save_coordinates(Object.assign({save:!0,svg:!1},e))}).then(()=>(i.ox="",s?n.unload():i.unload(),this))}draw(e={},n){const s=t.utils.snake_ref(this.ref),i=e.res||{};i[s]={imgs:{}};const r=!n;r&&(n=new t.EditorInvisible);const o=n.create_scheme();return o.load(this,e.builder_props||!0).then(()=>{const{_obj:{glasses:t,constructions:n,coordinates:r}}=this;if(e.elm){o.draw_fragment({elm:e.elm});const t=e.elm>0?"g"+e.elm:"l"+e.elm;"png"===e.format?i[s].imgs[t]=o.view.element.toDataURL("image/png").substr(22):i[s].imgs[t]=o.get_svg(e)}else e.glasses?(i[s].glasses=t.map(t=>Object.assign({},t)),i[s].glasses.forEach(t=>{const n=o.draw_fragment({elm:t.elm});"png"===e.format?i[s].imgs["g"+t.elm]=o.view.element.toDataURL("image/png").substr(22):i[s].imgs["g"+t.elm]=o.get_svg(e),n&&(t.formula_long=n.formula(!0),n.visible=!1)})):("png"===e.format?i[s].imgs.l0=o.view.element.toDataURL("image/png").substr(22):i[s].imgs.l0=o.get_svg(e),!1!==e.glasses&&n.forEach(({cnstr:t})=>{o.draw_fragment({elm:-t}),"png"===e.format?i[s].imgs["l"+t]=o.view.element.toDataURL("image/png").substr(22):i[s].imgs["l"+t]=o.get_svg(e)}))}).then(()=>(o.ox="",r?n.unload():o.unload(),i))}extract_value({cnstr:e,inset:n,param:s}){const{utils:{blank:i},CatNom:r,cat:o}=t;n=n?n.valueOf():i.guid,s=s?s.valueOf():i.guid;const a=this.params._obj.find(t=>t.cnstr===e&&(!t.inset&&n===i.guid||t.inset===n)&&t.param===s);return s instanceof r?o.characteristics.get(a.value):a.value}},t.CatCharacteristics.builder_props_defaults={auto_lines:!0,custom_lines:!0,cnns:!0,visualization:!0,txts:!0,rounding:0,mosquito:!0,jalousie:!0},t.CatCharacteristicsInsertsRow.prototype.value_change=function(e,n,s){if("inset"==e&&s!=this.inset){const{_owner:e}=this._owner,{cnstr:n}=this;if(s!=t.utils.blank.guid){if(e.params.find_rows({cnstr:n,inset:s,row:{not:this.row}}).length)return t.md.emit("alert",{obj:e,row:this,title:t.msg.data_error,type:"alert-error",text:"Нельзя добавлять две одинаковые вставки в один контур"}),!1}!this.inset.empty()&&e.params.clear({inset:this.inset,cnstr:n}),this._obj.inset=s,this.inset.clr_group.default_clr(this),e.add_inset_params(this.inset,n)}},t.cat.clrs.__define({by_predefined:{value(t,e,n,s,i){const{predefined_name:r}=t;if(r)switch(r){case"КакЭлемент":return e;case"КакИзделие":return n;case"КакЭлементСнаружи":return e.clr_out.empty()?e:e.clr_out;case"КакЭлементИзнутри":return e.clr_in.empty()?e:e.clr_in;case"КакИзделиеСнаружи":return n.clr_out.empty()?n:n.clr_out;case"КакИзделиеИзнутри":return n.clr_in.empty()?n:n.clr_in;case"КакЭлементИнверсный":return this.inverted(e);case"КакИзделиеИнверсный":return this.inverted(n);case"БезЦвета":return this.get();case"КакВедущий":case"КакВедущийИзнутри":case"КакВедущийСнаружи":case"КакВедущийИнверсный":const t=this.predefined(r.replace("КакВедущий","КакЭлемент")),o=s&&s.t_parent();if(!s||s===o)return this.by_predefined(t,e);let a=!1;return i&&i.find_rows({elm:o.elm,nom:o.nom},e=>(a=this.by_predefined(t,e.clr),!1)),a||e;default:return e}return t.empty()?e:t}},inverted:{value(e){if(e.clr_in==e.clr_out||e.clr_in.empty()||e.clr_out.empty())return e;const n=t.wsql.alasql("select top 1 ref from ? where clr_in = ? and clr_out = ? and (not ref = ?)",[this.alatable,e.clr_out.ref,e.clr_in.ref,t.utils.blank.guid]);return n.length?this.get(n[0]):e}},selection_exclude_service:{value(e,n){e.choice_params?e.choice_params.length=0:e.choice_params=[],e.choice_params.push({name:"parent",path:{not:t.cat.clrs.predefined("СЛУЖЕБНЫЕ")}}),n&&e.choice_params.push({name:"ref",get path(){const e=[];let s;if(n instanceof t.Editor.BuilderElement)s=n.inset.clr_group,!s.empty()||n instanceof t.Editor.Filling||(s=n.project._dp.sys.clr_group);else if(n.hasOwnProperty("sys")&&n.profile&&n.profile.inset){const t=n.sys.clr_group,e=n.profile.inset.clr_group;s=e.empty()?t:e}else s=n.sys&&n.sys.clr_group?n.sys.clr_group:n.clr_group;return s.empty()||!s.clr_conformity.count()?{not:""}:(function n(s){if(s instanceof t.CatClrs){const{ref:n}=s;s.is_folder?t.cat.clrs.alatable.forEach(t=>t.parent==n&&e.push(t.ref)):e.push(n)}else s instanceof t.CatColor_price_groups&&s.clr_conformity.forEach(({clr1:t})=>n(t))}(s),{in:e})}})}},form_selection:{value(e,n){const s=this.get();n.hide_filter=!0,n.toolbar_click=function(n,i){if("btn_select"==n&&!s.clr_in.empty()&&!s.clr_out.empty()){if(s.clr_in==s.clr_out)e.on_select.call(e,s.clr_in);else{const{wsql:n,job_prm:i,utils:r,cat:o,adapters:{pouch:a}}=t,{remote:{ram:c},props:l}=a,_=[s,{clr_in:s.clr_out,clr_out:s.clr_in}].map(({clr_in:t,clr_out:e},s)=>{const _=n.alasql("select top 1 ref from cat_clrs where clr_in = ? and clr_out = ? and (not ref = ?)",[t.ref,e.ref,r.blank.guid]);if(_.length)return Promise.resolve(o.clrs.get(_[0]));if(o.clrs.metadata().common){if(s>0)return Promise.resolve();const n=c.getBasicAuthHeaders({prefix:a.auth_prefix(),...c.__opts.auth});return fetch(l.path.replace(i.local_storage_prefix,"common/cat.clrs/composite"),{method:"POST",headers:Object.assign({"Content-Type":"application/json"},n),body:JSON.stringify({clr_in:t.ref,clr_out:e.ref})}).then(t=>t.json()).then(t=>(o.clrs.load_array([t.clr,t.inverted]),o.clrs.get(t.clr)))}return o.clrs.create({clr_in:t,clr_out:e,name:`${t.name} \\ ${e.name}`,parent:i.builder.composite_clr_folder}).then(t=>t.register_on_server())});Promise.all(_).then(t=>e.on_select.call(e,t[0])).catch(e=>t.msg.show_msg({type:"alert-warning",text:e&&e.message||"Недостаточно прав для добавления составного цвета",title:"Составной цвет"}))}return i.close(),!1}};const i=this.constructor.prototype.form_selection.call(this,e,n);function r(e,s){return e.clr_in=t.utils.blank.guid,e.clr_out=t.utils.blank.guid,n.selection&&n.selection.some(t=>{for(const n in t)if("ref"==n)return e.ref=t.ref,!0}),this.constructor.prototype.get_option_list.call(this,e,s)}return(i instanceof Promise?i:Promise.resolve(i)).then(e=>{const n=e.elmnts.filter;n.__define({get_filter:{value(){const t={selection:[]};return i.getSelectedValue()&&t.selection.push({clr_in:i.getSelectedValue()}),o.getSelectedValue()&&t.selection.push({clr_out:o.getSelectedValue()}),t.selection.length&&(t.hide_tree=!0),t}}}),e.attachEvent("onClose",()=>(i.unload(),o.unload(),s.clr_in=t.utils.blank.guid,s.clr_out=t.utils.blank.guid,!0)),s.clr_in=t.utils.blank.guid,s.clr_out=t.utils.blank.guid;const i=new t.iface.OCombo({parent:n.div.obj,obj:s,field:"clr_in",width:160,hide_frm:!0,get_option_list:r}),o=new t.iface.OCombo({parent:n.div.obj,obj:s,field:"clr_out",width:160,hide_frm:!0,get_option_list:r});return i.DOMelem.style.float="left",i.DOMelem_input.placeholder="Цвет изнутри",o.DOMelem_input.placeholder="Цвет снаружи",i.attachEvent("onChange",n.call_event),o.attachEvent("onChange",n.call_event),i.attachEvent("onClose",n.call_event),o.attachEvent("onClose",n.call_event),e.elmnts.toolbar.hideItem("btn_new"),e.elmnts.toolbar.hideItem("btn_edit"),e.elmnts.toolbar.hideItem("btn_delete"),e.elmnts.toolbar.setItemText("btn_select","<b>Выбрать или создать</b>"),e})},configurable:!0,writable:!0},sync_grid:{value(e,n){return"get_selection"==e.action&&e.selection&&e.selection.some((function(t){return t.hasOwnProperty("clr_in")||t.hasOwnProperty("clr_out")}))&&(delete e.parent,delete e.initial_value),t.classes.DataManager.prototype.sync_grid.call(this,e,n)}}}),t.CatClrs=class extends t.CatClrs{register_on_server(){if(this.parent!==t.job_prm.builder.composite_clr_folder)return Promise.reject(new Error("composite_clr_folder"));const{pouch:e}=t.adapters;return e.save_obj(this,{db:e.remote.ram})}get sides(){const t={is_in:!1,is_out:!1};return this.empty()||this.predefined_name||(this.clr_in.empty()&&this.clr_out.empty()?t.is_in=t.is_out=!0:(this.clr_in.empty()||this.clr_in.predefined_name||(t.is_in=!0),this.clr_out.empty()||this.clr_out.predefined_name||(t.is_out=!0))),t}},t.cat.cnns.__define({sql_selection_list_flds:{value:t=>"SELECT _t_.ref, _t_.`_deleted`, _t_.is_folder, _t_.id, _t_.name as presentation, _k_.synonym as cnn_type, case when _t_.ref = '"+t+"' then 0 else 1 end as is_initial_value FROM cat_cnns AS _t_ left outer join enm_cnn_types as _k_ on _k_.ref = _t_.cnn_type %3 %4 LIMIT 300"},nom_cnn:{value:function(e,n,s,i,r){const{ProfileItem:o,BuilderElement:a,Filling:c}=t.Editor,{orientations:{Вертикальная:l},cnn_types:{acn:_}}=t.enm;if(e instanceof o&&n instanceof o&&s&&-1!=s.indexOf(t.enm.cnn_types.ad)&&e.orientation!=l&&n.orientation==l)return this.nom_cnn(n,e,s);const h=r?t.enm.cnn_sides.Снаружи:!i&&e instanceof o&&n instanceof o&&n.cnn_side(e);let p,d,u,f,m,g=!1,y=!1,b=!1;!n||t.utils.is_data_obj(n)&&n.empty()?(g=!0,p=n=t.cat.nom.get()):p=n instanceof a?n.nom:t.utils.is_data_obj(n)?n:t.cat.nom.get(n);const w=e.ref,x=p.ref;if(g||(e instanceof c?(y=!0,f=e.thickness):n instanceof c&&(b=!0,m=n.thickness)),this._nomcache[w]||(this._nomcache[w]={}),d=this._nomcache[w],d[x]||(u=d[x]=[],this.forEach(e=>{let n=!!y&&(e.art1glass&&f>=e.tmin&&f<=e.tmax&&e.cnn_type==t.enm.cnn_types.ii),s=!!b&&(e.art2glass&&m>=e.tmin&&m<=e.tmax);e.cnn_elmnts.forEach(t=>{if(n&&s)return!1;n=n||t.nom1==w&&(t.nom2.empty()||t.nom2==p),s=s||t.nom2==p&&(t.nom1.empty()||t.nom1==w)}),n&&s&&u.push(e)})),s){const e=Array.isArray(s)?s:-1!=_.a.indexOf(s)?_.a:[s];return d[x].filter(n=>{if(-1!=e.indexOf(n.cnn_type))return!h||(n.sd1==t.enm.cnn_sides.Изнутри?h==t.enm.cnn_sides.Изнутри:n.sd1!=t.enm.cnn_sides.Снаружи||h==t.enm.cnn_sides.Снаружи)}).sort(this.sort_cnns)}return d[x]}},elm_cnn:{value:function(e,n,s,i,r,o){if(i&&s&&-1!=s.indexOf(i.cnn_type)&&s!=t.enm.cnn_types.acn.ii)if(r||i.sd1!=t.enm.cnn_sides.Изнутри){if(r||i.sd1!=t.enm.cnn_sides.Снаружи)return i;if(o||n.cnn_side(e)==t.enm.cnn_sides.Снаружи)return i}else if("boolean"==typeof o){if(!o)return i}else if(n.cnn_side(e)==t.enm.cnn_sides.Изнутри)return i;const a=this.nom_cnn(e,n,s,r,o);if(a.length)return a[0]}}}),t.cat.contracts.__define({sql_selection_list_flds:{value:t=>"SELECT _t_.ref, _t_.`_deleted`, _t_.is_folder, _t_.id, _t_.name as presentation, _k_.synonym as contract_kind, _m_.synonym as mutual_settlements, _o_.name as organization, _p_.name as partner, case when _t_.ref = '"+t+"' then 0 else 1 end as is_initial_value FROM cat_contracts AS _t_ left outer join cat_organizations as _o_ on _o_.ref = _t_.organization left outer join cat_partners as _p_ on _p_.ref = _t_.owner left outer join enm_mutual_contract_settlements as _m_ on _m_.ref = _t_.mutual_settlements left outer join enm_contract_kinds as _k_ on _k_.ref = _t_.contract_kind %3 %4 LIMIT 300"},by_partner_and_org:{value(e,n,s=t.enm.contract_kinds.СПокупателем){const{main_contract:i}=t.cat.partners.get(e);if(i&&i.contract_kind==s&&i.organization==n)return i;const r=this.find_rows({owner:e,organization:n,contract_kind:s});return r.sort((t,e)=>t.date>e.date),r.length?r[0]:this.get()}}}),t.CatElm_visualization.prototype.__define({draw:{value(e,n,s){const{CompoundPath:i,PointText:r,Path:o,constructor:a}=e.project._scope;let c;if(0==this.svg_path.indexOf('{"method":')){const t=JSON.parse(this.svg_path);if(["subpath_inner","subpath_outer","subpath_generatrix","subpath_median"].includes(t.method)){if("subpath_outer"==t.method)c=e.rays.outer.get_subpath(e.corns(1),e.corns(2)).equidistant(t.offset||10);else if("subpath_inner"==t.method)c=e.rays.inner.get_subpath(e.corns(3),e.corns(4)).equidistant(t.offset||10);else if("subpath_median"==t.method)if(e.is_linear())c=new o({segments:[e.corns(1).add(e.corns(4)).divide(2),e.corns(2).add(e.corns(3)).divide(2)]}).equidistant(t.offset||0);else{const n=e.rays.inner.get_subpath(e.corns(3),e.corns(4));n.reverse();const s=e.rays.outer.get_subpath(e.corns(1),e.corns(2)),i=n.length/50,r=s.length/50;c=new o;for(let t=0;t<50;t++)c.add(n.getPointAt(i*t).add(s.getPointAt(r*t)).divide(2));c.simplify(.8),t.offset&&(c=c.equidistant(t.offset))}else c=e.generatrix.get_subpath(e.b,e.e).equidistant(t.offset||0);c.parent=n._by_spec,c.strokeWidth=t.strokeWidth||4,c.strokeColor=t.strokeColor||"red",c.strokeCap=t.strokeCap||"round",t.dashArray&&(c.dashArray=t.dashArray)}}else if(this.svg_path){if(1===this.mode){const e=JSON.parse(this.attributes||"{}");c=new r(Object.assign({parent:n._by_spec,fillColor:"black",fontFamily:t.job_prm.builder.font_family,fontSize:e.fontSize||60,guide:!0,content:this.svg_path},e))}else c=new i({pathData:this.svg_path,parent:n._by_spec,strokeColor:"black",fillColor:e.constructor.clr_by_clr.call(e,e._row.clr,!1),strokeScaling:!1,guide:!0,pivot:[0,0],opacity:e.opacity});if(e instanceof a.Filling)c.position=e.bounds.topLeft.add(s);else{const{generatrix:n,rays:{inner:i,outer:r}}=e;let o;o=e.is_linear()||s<0?n.getTangentAt(0).angle:s>n.length?n.getTangentAt(n.length).angle:n.getTangentAt(s).angle,-1==this.rotate&&e.orientation!=t.enm.orientations.Горизонтальная||o==this.angle_hor||(c.rotation=o-this.angle_hor),s+=n.getOffsetOf(n.getNearestPoint(e.corns(1)));const a=n.getPointAt(s>n.length?n.length:s||0);if(-1==this.elm_side){const t=i.getNearestPoint(a),e=r.getNearestPoint(a);c.position=t.add(e).divide(2)}else this.elm_side?c.position=r.getNearestPoint(a):c.position=i.getNearestPoint(a)}}}}}),t.cat.furns.metadata("selection_params").index="elm",t.cat.furns.metadata("specification").index="elm",t.CatFurns=class extends t.CatFurns{refill_prm({project:e,furn:n,cnstr:s}){const i=e.ox.params,{CatNom:r,job_prm:{properties:{direction:o}}}=t,a=n.furn_set.used_params();a.sort((t,e)=>t.presentation>e.presentation?1:t.presentation<e.presentation?-1:0),a.forEach(t=>{if(t==o)return;let n,a=!0;i.find_rows({param:t,cnstr:s},t=>(n=t,a=!1)),n||(n=i.add({param:t,cnstr:s},!0));const{param:c}=n;e._dp.sys[c instanceof r?"params":"furn_params"].find_rows({param:c},t=>((t.forcibly||a)&&(n.value=t.value),n.hide=t.hide||c.is_calculated&&!c.show_calculated,!1)),c.linked_values(c.params_links({grid:{selection:{cnstr:s}},obj:{_owner:{_owner:e.ox}}}),n)});const c=[];i.find_rows({cnstr:s,inset:t.utils.blank.guid},t=>{-1==a.indexOf(t.param)&&c.push(t)}),c.forEach(t=>i.del(t,!0))}used_params(){const{_data:e}=this;if(e.used_params)return e.used_params;const n=[];this.selection_params.forEach(({param:t})=>{!t.empty()&&(!t.is_calculated||t.show_calculated)&&!n.includes(t)&&n.push(t)});const{CatFurns:s,CatNom:i,enm:{predefined_formulas:{cx_prm:r}}}=t;return this.specification.forEach(({nom:t,algorithm:e})=>{if(t instanceof s)for(const e of t.used_params())!n.includes(e)&&n.push(e);else e===r&&t instanceof i&&!n.includes(t)&&n.push(t)}),e.used_params=n}get_spec(e,n,s){const i=t.dp.buyers_order.create({specification:[]},!0).specification,{ox:r}=e.project,{transfer_operations_options:{НаПримыкающий:o,ЧерезПримыкающий:a,НаПримыкающийОтКонца:c},open_directions:l,offset_options:_}=t.enm;return this.specification.find_rows({dop:0},h=>{if(h.check_restrictions(e,n))if(s||this.specification.find_rows({elm:h.elm,dop:{not:0}},s=>{if(s.check_restrictions(e,n))if(s.is_procedure_row){const p=e.direction==l.Правое,d=e.profile_by_furn_side(s.side,n),{len:u}=d._row,{sizefurn:f}=d.nom,m=t.job_prm.builder.add_d?f:0,g=u-2*f;let y=0;if(s.offset_option==_.Формула)s.formula.empty()||(y=s.formula.execute({ox:r,elm:d,contour:e,len:u,sizefurn:f,dx1:m,faltz:g,invert:p,dop_row:s}));else if(s.offset_option==_.РазмерПоФальцу)y=g+s.contraction;else if(s.offset_option==_.ОтРучки){const{generatrix:t}=d,n=e.handle_line(d);y=t.getOffsetOf(t.intersect_point(n))-t.getOffsetOf(t.getNearestPoint(d.corns(1)))+(p?s.contraction:-s.contraction)}else y=s.offset_option==_.ОтСередины?u/2+(p?s.contraction:-s.contraction):p?s.offset_option==_.ОтКонцаСтороны?s.contraction:u-s.contraction:s.offset_option==_.ОтКонцаСтороны?u-s.contraction:s.contraction;const b=i.add(s);if(b.origin=this,b.specify=h.nom,b.handle_height_max=e.cnstr,[o,a,c].includes(s.transfer_option)){let t=d.nearest();if(s.transfer_option==a){const e=t.joined_nearests().reduce((t,e)=>(e!==d&&t.push(e),t),[]);e.length&&(t=e[0])}const{outer:e}=d.rays,n=t.rays.outer,i=e.getPointAt(e.getOffsetOf(e.getNearestPoint(d.corns(1)))+y);b.handle_height_min=t.elm,s.transfer_option==c?b.coefficient=n.getOffsetOf(n.getNearestPoint(t.corns(2)))-n.getOffsetOf(n.getNearestPoint(i)):b.coefficient=n.getOffsetOf(n.getNearestPoint(i))-n.getOffsetOf(n.getNearestPoint(t.corns(1))),s.overmeasure&&(b.coefficient+=t.dx0)}else b.handle_height_min=d.elm,b.coefficient=y,s.overmeasure&&(b.coefficient+=d.dx0)}else if(s.quantity)if(s.is_set_row){const{nom:t}=s;t&&t.get_spec(e,n).forEach(t=>{t.is_procedure_row?i.add(t):t.quantity&&(i.add(t).quantity=(h.quantity||1)*(s.quantity||1)*t.quantity)})}else{const t=i.add(s);t.origin=this,t.specify=h.nom}}),h.is_set_row){const{nom:t}=h;t&&t.get_spec(e,n,s).forEach(t=>{if(t.is_procedure_row)i.add(t);else if(!t.quantity)return;i.add(t).quantity=(h.quantity||1)*t.quantity})}else h.quantity&&this.add_with_algorithm(i,r,e,h)}),i}add_with_algorithm(t,e,n,s){const{algorithm:i,formula:r}=s;let o;if("cx_prm"==i&&(o=e.extract_value({cnstr:n.cnstr,param:s.nom}),"нет"===o.toString().toLowerCase()))return;const a=t.add(s);a.origin=this,"cx_prm"==i&&(a.nom_characteristic=o),r.empty()||r.condition_formula||r.execute({ox:e,contour:n,row_furn:s,row_spec:a})}shtulp_kind(){let t=0;return this.open_tunes.forEach(({shtulp_available:e,shtulp_fix_here:n})=>{e&&!t&&(t=1),n&&(t=2)}),t}},t.CatFurnsSpecificationRow=class extends t.CatFurnsSpecificationRow{check_restrictions(e,n){const{elm:s,dop:i,handle_height_min:r,handle_height_max:o,formula:a,side:c}=this,{direction:l,h_ruch:_,cnstr:h}=e;if(_<r||o&&_>o)return!1;if(!n.ignore_formulas&&!a.empty()&&a.condition_formula&&!a.execute({ox:n.ox,contour:e,row_furn:this}))return!1;const{selection_params:p,specification_restrictions:d}=this._owner._owner,u=t.job_prm.properties.direction;let f,m=!0;return p.find_rows({elm:s,dop:i},t=>{if(f||(f=e.profile_by_furn_side(c,n)),!(u==t.param?l==t.value:t.param.check_condition({row_spec:this,prm_row:t,elm:f,cnstr:h,ox:n.ox})))return m=!1}),m&&d.find_rows({elm:s,dop:i},s=>{const{lmin:i,lmax:r,amin:o,amax:a,side:c,for_direct_profile_only:_}=s,h=e.profile_by_furn_side(c,n);if(-1===_&&h.is_linear())return m=!1;if(1===_&&!h.is_linear())return m=!1;const{side_count:p}=e,d=e.profile_by_furn_side(1===s.side?p:s.side-1,n),u=e.profile_by_furn_side(s.side===p?1:s.side+1,n),f=(h._row.len-d.nom.sizefurn-u.nom.sizefurn).round();if(f<i||f>r)return m=!1;const g=l==t.enm.open_directions.Правое?h.generatrix.angle_to(d.generatrix,h.e):d.generatrix.angle_to(h.generatrix,h.b);return g<o||g>a?m=!1:void 0}),m}get nom(){return this._getter("nom")||this._getter("nom_set")}set nom(t){""!==t&&this._setter("nom",t)}get nom_set(){return this.nom}set nom_set(t){this.nom=t}},(({md:t})=>{const{fields:e}=t.get("cat.furns").tabular_sections.specification;e.nom_set=e.nom})(t),(({md:e,cat:n,enm:s,cch:i,dp:r,utils:o,adapters:{pouch:a},job_prm:c})=>{!1!==c.use_ram&&e.once("predefined_elmnts_inited",()=>{n.scheme_settings&&n.scheme_settings.find_schemas("dp.buyers_order.production")}),n.inserts.__define({_inserts_types_filling:{value:[s.inserts_types.Заполнение]},_prms_by_type:{value(t){const e=new Set;return this.find_rows({available:!0,insert_type:t},t=>{t.used_params().forEach(t=>{!t.is_calculated&&e.add(t)})}),e}},ItemData:{value:class{constructor(e,c){this.Renderer=c,this.count=0;const l=this;class _ extends t.DpBuyers_orderProductionRow{tune(t,e,n){const{inset:s}=this,r=i.properties.get(t);if(e.choice_params){const t=new Set;for(const n of e.choice_params)"owner"!==n.name&&n.path!=r&&t.add(n);for(const n of t)e.choice_params.splice(e.choice_params.indexOf(n),1)}else e.choice_params=[];const o=new Set;if(s.used_params().forEach(t=>{!t.is_calculated&&o.add(t)}),e.read_only=!o.has(r),!e.read_only){const t=r.params_links({grid:{selection:{}},obj:this});if(t.some(t=>t.hide)&&!e.read_only&&(e.read_only=!0),t.length){const n={};r.filter_params_links(n,null,t),n.ref&&e.choice_params.push({name:"ref",path:n.ref})}}}get_row(t){const{product_params:e}=this._owner._owner;return e.find({elm:this.row,param:t})||e.add({elm:this.row,param:t})}value_change(t,e,i){"inset"===t&&(i=n.inserts.get(i)).insert_type==s.inserts_types.Параметрик&&l.tune_meta(i,this),super.value_change(t,e,i)}get elm(){return this.row}}if(this.ProductionRow=_,this.meta=o._clone(r.buyers_order.metadata("production")),this.meta.fields.inset.choice_params[0].path=e,this.meta.fields.inset.disable_clear=!0,e!==s.inserts_types.Параметрик){const n=this.tune_meta(e),{current_user:s}=t;for(const t of n)("http"!==a.local.doc.adapter||t.user||s&&s.roles.includes("doc_full"))&&t.save()}}tune_meta(t,e){const s=new Set;let i,r,a;if(e?(i=new Set,t.product_params.forEach(({param:t})=>i.add(t)),e._meta||Object.defineProperty(e,"_meta",{value:o._clone(this.meta)}),a=e._meta):(e=this.ProductionRow.prototype,i=n.inserts._prms_by_type(t),r=!0,a=this.meta),!r)for(const t in e)if(o.is_guid(t)&&!Array.from(i).some(({ref:e})=>e===t)&&(delete e[t],delete a.fields[t],e._owner&&e._owner._owner)){const{product_params:n}=e._owner._owner;for(const s of n.find_rows({elm:e.row,fld:t}))n.del(s)}for(const o of i){r&&n.scheme_settings.find_rows({obj:"dp.buyers_order.production",name:t.name},t=>{if(!t.fields.find({field:o.ref})){const e=t.fields.add({field:o.ref,caption:o.caption,use:!0}),n=t.fields.find({field:"note"});n&&t.fields.swap(e,n),s.add(t)}}),a.fields[o.ref]||(a.fields[o.ref]={synonym:o.caption,type:o.type});const i=a.fields[o.ref];o.type.types.some(t=>"cat.property_values"===t)&&(i.choice_params=[{name:"owner",path:o}]);const c=t.product_params&&t.product_params.find({param:o});if(c&&c.list)try{i.list=JSON.parse(c.list)}catch(t){delete i.list}else delete i.list;e.hasOwnProperty(o.ref)||Object.defineProperty(e,o.ref,{get(){return this.get_row(o).value},set(t){this.get_row(o).value=t},configurable:!0,enumerable:!0})}return s}}},by_thickness:{value(t,e){this._by_thickness||(this._by_thickness={},this.find_rows({insert_type:{in:this._inserts_types_filling}},t=>{t.thickness>0&&(this._by_thickness[t.thickness]||(this._by_thickness[t.thickness]=[]),this._by_thickness[t.thickness].push(t))}));const n=[];for(let s in this._by_thickness)parseFloat(s)>=t&&parseFloat(s)<=e&&Array.prototype.push.apply(n,this._by_thickness[s]);return n}},sql_selection_list_flds:{value:t=>"SELECT _t_.ref, _t_.`_deleted`, _t_.is_folder, _t_.id,_t_.note as note,_t_.priority as priority ,_t_.name as presentation, _k_.synonym as insert_type, case when _t_.ref = '"+t+"' then 0 else 1 end as is_initial_value FROM cat_inserts AS _t_ left outer join enm_inserts_types as _k_ on _k_.ref = _t_.insert_type %3 ORDER BY is_initial_value, priority desc, presentation LIMIT 1000 "},sql_selection_where_flds:{value:t=>` OR _t_.note LIKE '${t}' OR _t_.id LIKE '${t}' OR _t_.name LIKE '${t}'`}}),n.inserts.metadata("selection_params").index="elm",n.inserts.metadata("specification").index="is_main_elm",t.CatInserts=class e extends t.CatInserts{nom(e,s){const{_data:i}=this;if(!s&&!e&&i.nom)return i.nom;let r,o=this.specification._obj.filter(({is_main_elm:t})=>t).map(({_row:t})=>t);if(o.length>1&&e){const{check_params:t}=F;o=o.filter(n=>t({params:this.selection_params,ox:e.project.ox,elm:e,row_spec:n,cnstr:0,origin:e.fake_origin||0}))}if(o.length||s||!this.specification.count()||o.push(this.specification.get(0)),o.length&&o[0].nom instanceof t.CatInserts)r=o[0].nom==this?n.nom.get():o[0].nom.nom(e,s);else if(o.length)if(e&&!o[0].formula.empty())try{r=o[0].formula.execute({elm:e}),r||(r=o[0].nom)}catch(t){r=o[0].nom}else r=o[0].nom;else r=n.nom.get();return o.length<2?i.nom="string"==typeof r?n.nom.get(r):r:i.nom=r,i.nom}width(t,e){const{_data:n}=this;if(!n.width){const t=new Set;this.specification._obj.filter(({is_main_elm:t})=>t).forEach(({_row:e})=>t.add(e.nom.width)),1===t.size?n.width=t.values()[0]:n.width=-1}return(n.width>0?n.width:this.nom(t,e).width)||80}contour_attrs(e){const n=[],i={calc_order:e.project.ox.calc_order};if(this.specification.find_rows({is_main_elm:!0},t=>(n.push(t),!1)),n.length){const r=n[0],o={},a={},l=["length","width","thickness"].map(t=>{const e=c.properties[t];return a[e.ref]=t,e});if(i.owner=r.nom instanceof t.CatInserts?r.nom.nom():r.nom,e.project.ox.params.find_rows({cnstr:e.cnstr,inset:this,param:{in:l}},t=>{o[a[t.param.ref]]=t.value}),Object.keys(o).length>0)i.x=o.length?(o.length+r.sz)*(1e3*r.coefficient||1):0,i.y=o.width?(o.width+r.sz)*(1e3*r.coefficient||1):0,i.s=(i.x*i.y/1e6).round(3),i.z=o.thickness*(1e3*r.coefficient||1);else if(r.count_calc_method!=s.count_calculating_ways.ПоФормуле||r.formula.empty()||r.formula.execute({ox:e.project.ox,contour:e,inset:this,row_ins:r,res:i}),r.count_calc_method==s.count_calculating_ways.ПоПлощади&&this.insert_type==s.inserts_types.МоскитнаяСетка){const t=e.bounds_inner(r.sz);i.x=t.width.round(1),i.y=t.height.round(1),i.s=(i.x*i.y/1e6).round(3)}else i.x=e.w+r.sz,i.y=e.h+r.sz,i.s=(i.x*i.y/1e6).round(3)}return i}check_restrictions(t,e,n,i){const{_row:r}=e,a=i?i.len:r.len,c=!e.is_linear||e.is_linear();if(t.smin>r.s||r.s&&t.smax&&t.smax<r.s)return!1;if(t.is_main_elm&&!t.quantity)return!1;if(t.for_direct_profile_only>0&&!c||t.for_direct_profile_only<0&&c)return!1;if(!o.is_data_obj(t)||n||t.count_calc_method!=s.count_calculating_ways.ПоПериметру){if(t.lmin>a||t.lmax<a&&t.lmax>0)return!1;if(t.ahmin>r.angle_hor||t.ahmax<r.angle_hor)return!1}return!0}filtered_spec({elm:e,is_high_level_call:n,len_angl:i,own_row:r,ox:a}){const c=[];if(this.empty())return c;function l(t){if(t._metadata){const e={};for(let n in t._metadata().fields)e[n]=t[n];return e}return Object.assign({},t)}const{insert_type:_,check_restrictions:h}=this,{Профиль:p,Заполнение:d}=s.inserts_types,{check_params:u}=F;if(n&&_==d){const t=[];if(a.glass_specification.find_rows({elm:e.elm,inset:{not:o.blank.guid}},e=>{t.push(e)}),t.length)return t.forEach(t=>{t.inset.filtered_spec({elm:e,len_angl:i,ox:a,own_row:{clr:t.clr}}).forEach(t=>{c.push(t)})}),c}return this.specification.forEach(n=>{h(n,e,_==p,i)&&(r&&n.clr.empty()&&!r.clr.empty()&&((n=l(n)).clr=r.clr),u({params:this.selection_params,ox:a,elm:e,row_spec:n,cnstr:i&&i.cnstr,origin:i&&i.origin})&&(n.nom instanceof t.CatInserts?n.nom.filtered_spec({elm:e,len_angl:i,ox:a,own_row:r||n}).forEach(t=>{const e=l(t);e.quantity=(t.quantity||1)*(n.quantity||1),e.coefficient=(t.coefficient||1)*(n.coefficient||1),e._origin=n.nom,e.clr.empty()&&(e.clr=n.clr),c.push(e)}):c.push(n)))}),c}calculate_spec({elm:t,len_angl:e,ox:n,spec:i,clr:r}){const{_row:a}=t,{ПоПериметру:c,ПоШагам:l,ПоФормуле:_,ДляЭлемента:h,ПоПлощади:p,ДлинаПоПарам:d,ГабаритыПоПарам:u,ПоСоединениям:f}=s.count_calculating_ways,{profile_items:m}=s.elm_types,{new_spec_row:g,calc_qty_len:y,calc_count_area_mass:b}=F;if(i||(i=n.specification),this.filtered_spec({elm:t,is_high_level_call:!0,len_angl:e,ox:n,clr:r}).forEach(w=>{const x=w._origin||this;let v,{count_calc_method:j,sz:k,offsets:P,coefficient:z,formula:S}=w;if(z||(z=.001),(j!=c&&j!=l||m.includes(a.elm_type))&&(v=g({elm:t,row_base:w,origin:x,spec:i,ox:n})),j!=_||S.empty())if(m.includes(a.elm_type)||j==h){if(y(v,w,e?e.len:a.len),j==f)for(const e of[t.rays.b,t.rays.e]){const{cnn:s}=e;s&&(v.len-=s.nom_size({nom:v.nom,elm:t,len_angl:e.len_angl(),ox:n})*z)}}else if(j==p)if(v.qty=w.quantity,this.insert_type==s.inserts_types.МоскитнаяСетка){const e=t.layer.bounds_inner(k);v.len=e.height*z,v.width=e.width*z,v.s=(v.len*v.width).round(3)}else if(this.insert_type==s.inserts_types.Жалюзи){if(t.bounds_light){const e=t.bounds_light();v.len=(e.height+P)*z,v.width=(e.width+k)*z}else v.len=t.len*z,v.width=t.height*z;v.s=(v.len*v.width).round(3)}else v.len=(a.y2-a.y1-k)*z,v.width=(a.x2-a.x1-k)*z,v.s=a.s;else if(j==c){const c={_row:{len:0,angle_hor:0,s:a.s}};(t.perimeter?t.perimeter:this.insert_type==s.inserts_types.МоскитнаяСетка?t.layer.perimeter_inner(k):t.layer.perimeter).forEach(s=>{if(c._row._mixin(s),c.is_linear=()=>!s.profile||s.profile.is_linear(),this.check_restrictions(w,c,!0)){v=g({elm:t,row_base:w,origin:x,spec:i,ox:n});const c=!S.empty()&&S.execute({ox:n,elm:s.profile||s,cnstr:e&&e.cnstr||0,inset:e&&e.hasOwnProperty("cnstr")?e.origin:o.blank.guid,row_ins:w,row_spec:v,clr:r,len:s.len});c?v.qty||(v.qty=c):y(v,w,s.len),b(v,i,a,w.angle_calc_method)}v=null})}else if(j==l){const e=this.insert_type==s.inserts_types.МоскитнаяСетка?t.layer.bounds_inner(k):{height:a.y2-a.y1,width:a.x2-a.x1},r=w.step_angle&&180!=w.step_angle?e.width:e.height,o=w.step_angle&&180!=w.step_angle?e.height:e.width;if(w.step){let e,s=0;if(w.do_center&&r>=w.step){e=r/2,e>=P&&e<=r-P&&s++;for(let t=1;t<=Math.ceil(r/w.step);t++)e=r/2+t*w.step,e>=P&&e<=r-P&&s++,e=r/2-t*w.step,e>=P&&e<=r-P&&s++}else for(let t=1;t<=Math.ceil(r/w.step);t++)e=t*w.step,e>=P&&e<=r-P&&s++;s&&(v=g({elm:t,row_base:w,origin:x,spec:i,ox:n}),y(v,w,o),v.qty*=s,b(v,i,a,w.angle_calc_method)),v=null}}else if(j==d){let t=0;this.selection_params.find_rows({elm:w.elm},({param:e})=>{if(e.type.digits&&n.params.find_rows({cnstr:0,param:e},({value:e})=>(t=e,!1)),t)return!1}),v.qty=w.quantity,v.len=(t-k)*z,v.width=0,v.s=0}else{if(j!=u)throw new Error("count_calc_method: "+w.count_calc_method);{let t=0,e=0;this.selection_params.find_rows({elm:w.elm},({param:s})=>{if(s.type.digits&&n.params.find_rows({cnstr:0,param:s},({value:n})=>(t?e||(e=n):t=n,!1)),t&&e)return!1}),v.qty=w.quantity,v.len=(t-k)*z,v.width=(e-k)*z,v.s=(v.len*v.width).round(3)}}else v=g({row_spec:v,elm:t,row_base:w,origin:x,spec:i,ox:n});if(v){if(!S.empty()){const s=S.execute({ox:n,elm:t,cnstr:e&&e.cnstr||0,inset:e&&e.hasOwnProperty("cnstr")?e.origin:o.blank.guid,row_ins:w,row_spec:v,clr:r,len:e?e.len:a.len});j==_?v.qty=s:S.condition_formula&&!s&&(v.qty=0)}b(v,i,a,w.angle_calc_method)}}),i!==n.specification&&this.insert_type==s.inserts_types.Жалюзи){const t={x:0,y:0};i.forEach(({len:e,width:n})=>{e&&n&&(t.x<e&&(t.x=e),t.y<n&&(t.y=n))});const{_owner:e}=i;e.x=1e3*t.y,e.y=1e3*t.x,e.s=(t.x*t.y).round(3)}}get thickness(){const{_data:t}=this;if(!t.hasOwnProperty("thickness")){t.thickness=0;const e=this.nom(null,!0);e&&!e.empty()?t.thickness=e.thickness:this.specification.forEach(({nom:e})=>{e&&(t.thickness+=e.thickness)})}return t.thickness}used_params(){const{_data:n}=this;if(n.used_params)return n.used_params;const s=[];this.selection_params.forEach(({param:t})=>{t.empty()||t.is_calculated&&!t.show_calculated||s.includes(t)||s.push(t)}),this.product_params.forEach(({param:t})=>{t.empty()||t.is_calculated&&!t.show_calculated||s.includes(t)||s.push(t)});const{CatFurns:i,enm:{predefined_formulas:{cx_prm:r}}}=t;return this.specification.forEach(({nom:t,algorithm:n})=>{if(t instanceof e)for(const e of t.used_params())!s.includes(e)&&s.push(e);else n!==r||s.includes(t)||s.push(t)}),n.used_params=s}}})(t),t.cat.insert_bind.__define({insets:{value(t){const{sys:e,owner:n}=t,s=[];return this.forEach(t=>{t.production.forEach(i=>{const{nom:r}=i;(e._hierarchy(r)||n._hierarchy(r))&&t.inserts.forEach(({inset:t,elm_type:e})=>{s.some(n=>n.inset==t&&n.elm_type==e)||s.push({inset:t,elm_type:e})})})}),s}}}),t.cat.nom.__define({sql_selection_list_flds:{value:t=>"SELECT _t_.ref, _t_.`_deleted`, _t_.is_folder, _t_.id, _t_.article, _t_.name as presentation, _u_.name as nom_unit, _k_.name as nom_kind, _t_.thickness, case when _t_.ref = '"+t+"' then 0 else 1 end as is_initial_value FROM cat_nom AS _t_ left outer join cat_units as _u_ on _u_.ref = _t_.base_unit left outer join cat_nom_kinds as _k_ on _k_.ref = _t_.nom_kind %3 %4 LIMIT 300"},sql_selection_where_flds:{value:t=>" OR _t_.article LIKE '"+t+"' OR _t_.id LIKE '"+t+"' OR _t_.name LIKE '"+t+"'"}}),t.cat.partners.__define({sql_selection_where_flds:{value:t=>" OR inn LIKE '"+t+"' OR name_full LIKE '"+t+"' OR name LIKE '"+t+"'"}}),t.CatPartners.prototype.__define({addr:{get(){return this.contact_information._obj.reduce((function(e,n){return n.kind==t.cat.contact_information_kinds.predefined("ЮрАдресКонтрагента")&&n.presentation?n.presentation:e||(!n.presentation||n.kind!=t.cat.contact_information_kinds.predefined("ФактАдресКонтрагента")&&n.kind!=t.cat.contact_information_kinds.predefined("ПочтовыйАдресКонтрагента")?void 0:n.presentation)}),"")}},phone:{get(){return this.contact_information._obj.reduce((function(e,n){return n.kind==t.cat.contact_information_kinds.predefined("ТелефонКонтрагента")&&n.presentation?n.presentation:e||(n.kind==t.cat.contact_information_kinds.predefined("ТелефонКонтрагентаМобильный")&&n.presentation?n.presentation:void 0)}),"")}},long_presentation:{get(){const{addr:t,phone:e,inn:n,kpp:s}=this;let i=this.name_full||this.name;return n&&(i+=", ИНН"+n),s&&(i+=", КПП"+s),t&&(i+=", "+t),e&&(i+=", "+e),i}}}),t.cat.production_params.__define({slist:function(e,n){var s,i,r,o=[],a=this.get(e);if(a&&a.type.is_ref)for(s in a.type.types)a.type.types[s].indexOf(".")>-1&&(i=a.type.types[s].split("."),(r=t[i[0]][i[1]])&&("enm.open_directions"==r.class_name?r.forEach((function(e){e.name!=t.enm.tso.folding&&o.push({value:e.ref,text:e.synonym})})):r.find_rows({owner:e},(function(t){o.push({value:t.ref,text:t.presentation})}))));return o}}),t.CatProduction_params.prototype.__define({noms:{get(){const e=[];return this.elmnts._obj.forEach(({nom:n})=>!t.utils.is_empty_guid(n)&&-1==e.indexOf(n)&&e.push(n)),e}},furns:{value(e,n=0){const{furn:s}=t.job_prm.properties,{furns:i}=t.cat,r=[];if(s){const t=s.params_links({grid:{selection:{cnstr:n}},obj:{_owner:{_owner:e}}});t.length&&t.forEach(t=>t.values._obj.forEach(({value:t,by_default:e,forcibly:n})=>{const s=i.get(t);s&&r.push({furn:s,by_default:e,forcibly:n})}))}return r}},inserts:{value(e,n){var s=[];return e?"string"==typeof e?e=t.enm.elm_types[e]:Array.isArray(e)||(e=[e]):e=t.enm.elm_types.rama_impost,this.elmnts.forEach(t=>{t.nom.empty()||-1==e.indexOf(t.elm_type)||"rows"!=n&&s.some(e=>t.nom==e.nom)||s.push(t)}),"rows"==n?s:(s.sort((function(t,e){return n?t.by_default&&!e.by_default?-1:!t.by_default&&e.by_default?1:0:t.nom.name<e.nom.name?-1:t.nom.name>e.nom.name?1:0})),s.map(t=>t.nom))}},refill_prm:{value(e,n=0,s,i){const r=n?this.furn_params:this.product_params,o=[],a=e.calc_order.obj_delivery_state==t.enm.obj_delivery_states.Шаблон&&t.job_prm.properties.auto_align,{params:c}=e;function l(t){let e;if(c.find_rows({cnstr:n,param:t.param},t=>(e=t,!1)),!e){if(n)return;e=c.add({cnstr:n,param:t.param,value:t.value})}const s=t.param.params_links({grid:{selection:{cnstr:n}},obj:e}),i=t.hide||s.some(t=>t.hide);e.hide!=i&&(e.hide=i),t.forcibly&&e.value!=t.value&&(e.value=t.value)}n||(c.find_rows({cnstr:n},t=>{const{param:e}=t;e!==a&&0==r.find_rows({param:e}).length&&o.push(t)}),o.forEach(t=>c.del(t))),r.forEach(l),!n&&a&&l({param:a,value:"",hide:!1}),n||(e.sys=this,e.owner=e.prod_nom,e.constructions.forEach(t=>{if(!t.furn.empty()){let n=s;const r=this.furns(e,t.cnstr);if(r.length&&(r.some(e=>{if(e.forcibly)return t.furn=e.furn,n=!0})||r.some(e=>t.furn===e.furn)||r.some(e=>{if(e.by_default)return t.furn=e.furn,n=!0})||(t.furn=r[0].furn,n=!0)),n){!i&&"undefined"!==typeof window&&window.paper&&(i=window.paper.project);const n=i&&i.getItem({cnstr:t.cnstr});n?(t.furn.refill_prm(n),n.notify(n,"furn_changed")):e.sys.refill_prm(e,t.cnstr)}}}))}}});class B{constructor({len:t,inset:e}){this.len=t,this.origin=e}get angle(){return 0}get alp1(){return 0}get alp2(){return 0}get cnstr(){return 0}}class G{constructor(t){this.row_spec=t}get elm(){return 0}get angle_hor(){return 0}get _row(){return this}get clr(){const{row_spec:e}=this;return e instanceof t.DocCalc_orderProductionRow?e.characteristic.clr:e.clr}get len(){return this.row_spec.len}get height(){const{height:t,width:e}=this.row_spec;return void 0===t?e:t}get depth(){return this.row_spec.depth||0}get s(){return this.row_spec.s}get perimeter(){const{len:t,height:e,width:n}=this.row_spec;return[{len:t,angle:0},{len:void 0===e?n:e,angle:90}]}get x1(){return 0}get y1(){return 0}get x2(){return this.height}get y2(){return this.len}}return t.DocCalc_order=class extends t.DocCalc_order{after_create(){const{enm:e,cat:n,current_user:s,DocCalc_order:i}=t;if(!s)return Promise.resolve(this);const{acl_objs:r}=s;return r.find_rows({by_default:!0,type:n.organizations.class_name},t=>(this.organization=t.acl_obj,!1)),i.set_department.call(this),r.find_rows({by_default:!0,type:n.partners.class_name},t=>(this.partner=t.acl_obj,!1)),this.contract=n.contracts.by_partner_and_org(this.partner,this.organization),this.manager=s,this.obj_delivery_state=e.obj_delivery_states.Черновик,this.number_doc?Promise.resolve(this):this.new_number_doc()}before_save(){const{msg:e,pricing:n,utils:{blank:s},cat:i,enm:{obj_delivery_states:{Отклонен:r,Отозван:o,Шаблон:a,Подтвержден:c,Отправлен:l},elm_types:{ОшибкаКритическая:_,ОшибкаИнфо:h}}}=t,p=-1==[c,l].indexOf(this.obj_delivery_state);if(this.posted){if(this.obj_delivery_state==r||this.obj_delivery_state==o||this.obj_delivery_state==a)return e.show_msg&&e.show_msg({type:"alert-warning",text:'Нельзя провести заказ со статусом<br/>"Отклонён", "Отозван" или "Шаблон"',title:this.presentation}),!1;this.obj_delivery_state!=c&&(this.obj_delivery_state=c)}else this.obj_delivery_state==c&&(this.obj_delivery_state=l);if(this.obj_delivery_state==a)this.department=s.guid,this.partner=s.guid;else{if(this.department.empty())return e.show_msg&&e.show_msg({type:"alert-warning",text:'Не заполнен реквизит "офис продаж" (подразделение)',title:this.presentation}),p;if(this.partner.empty())return e.show_msg&&e.show_msg({type:"alert-warning",text:"Не указан контрагент (дилер)",title:this.presentation}),p}let d=0,u=0;const f=this._data.errors=new Map;this.production.forEach(({amount:t,amount_internal:e,characteristic:n})=>{d+=t,u+=e,n.specification.forEach(({nom:t,elm:e})=>{[_,h].includes(t.elm_type)&&(f.has(n)||f.set(n,new Map),f.has(t.elm_type)||f.set(t.elm_type,new Set),f.get(n).has(t)||f.get(n).set(t,new Set),f.get(n).get(t).add(e),f.get(t.elm_type).add(t))})});const{rounding:m}=this,{_obj:g,obj_delivery_state:y,category:b}=this;if(this.doc_amount=d.round(m),this.amount_internal=u.round(m),this.amount_operation=n.from_currency_to_currency(d,this.date,this.doc_currency).round(m),f.size){let n,s="";if(f.forEach((e,i)=>{i instanceof t.CatCharacteristics&&(s+=`<b>${i.name}:</b><br/>`,e.forEach((t,e)=>{s+=`${e.name} - элементы:${Array.from(t)}<br/>`,e.elm_type==_&&(n=!0)}))}),e.show_msg&&e.show_msg({type:"alert-warning",title:"Ошибки в заказе",text:s}),console.error(s),n&&!p)return"Отправлен"==y&&(this.obj_delivery_state="Черновик"),!1}return g.state="Шаблон"==y?"template":"service"==b?"service":"complaints"==b?"complaints":"Отправлен"==y?"sent":"Отклонен"==y?"declined":"Подтвержден"==y?"confirmed":"Архив"==y?"zarchive":"draft",this.product_rows(!0).then(()=>this._manager.pouch_db.query("linked",{startkey:[this.ref,"cat.characteristics"],endkey:[this.ref,"cat.characteristics࿿"]}).then(({rows:t})=>{let e=Promise.resolve(),n=0;for(const{id:s}of t){const t=s.substr(20);this.production.find_rows({characteristic:t}).length||(n++,e=e.then(()=>i.characteristics.get(t,"promise")).then(t=>!t.is_new()&&!t._deleted&&t.mark_deleted(!0)))}return e.then(()=>n)}).then(t=>{t&&this._manager.emit_async("svgs",this)}).catch(t=>null)).then(()=>this)}value_change(e,n,s){"organization"===e?(this.organization=s,this.contract.organization!=s&&(this.contract=t.cat.contracts.by_partner_and_org(this.partner,s),!this.constructor.prototype.hasOwnProperty("new_number_doc")&&this.new_number_doc())):"partner"===e&&this.contract.owner!=s&&(this.contract=t.cat.contracts.by_partner_and_org(s,this.organization));const i=["contract"];"obj_delivery_state"===e&&this.clear_templates_props&&(i.push("extra_fields"),"Шаблон"!=s&&this.clear_templates_props()),this._manager.emit_add_fields(this,i)}del_row(e){if(e instanceof t.DocCalc_orderProductionRow){const{characteristic:n}=e;if(!n.empty()&&!n.calc_order.empty()){const{production:e,orders:s,presentation:i,_data:r}=this,{msg:o}=t,{leading_elm:a,leading_product:c,origin:l}=n;if(!c.empty()&&c.calc_order_row&&c.inserts.find({cnstr:-a,inset:l}))return o.show_msg&&o.show_msg({type:"alert-warning",text:`Изделие <i>${n.prod_name(!0)}</i> не может быть удалено<br/><br/>Для удаления, пройдите в <i>${c.prod_name(!0)}</i> и отредактируйте доп. вставки`,title:i}),!1;const{_loading:_}=r;r._loading=!0,e.find_rows({ordn:n}).forEach(({_row:t})=>{e.del(t.row-1)}),s.forEach(({invoice:t})=>{t.empty()||t.goods.find_rows({nom_characteristic:n}).forEach(({_row:e})=>{t.goods.del(e.row-1)})}),r._loading=_}}return this}after_del_row(t){return"production"===t&&this.product_rows(),this}unload(){return this.production.forEach(({characteristic:t})=>{t.empty()||t.calc_order!==this||t.unload()}),super.unload()}get doc_currency(){const e=this.contract.settlements_currency;return e.empty()?t.job_prm.pricing.main_currency:e}set doc_currency(t){}get rounding(){const{pricing:e}=t.job_prm;if(!e.hasOwnProperty("rounding")){const t=this.doc_currency?this.doc_currency.parameters_russian_recipe.split(","):[2];e.rounding=parseInt(t[t.length-1]),isNaN(e.rounding)&&(e.rounding=2)}return e.rounding}get contract(){return this._getter("contract")}set contract(t){this._setter("contract",t),this.vat_consider=this.contract.vat_consider,this.vat_included=this.contract.vat_included}product_rows(t){let e=Promise.resolve();return this.production.forEach(({row:n,characteristic:s})=>{s.empty()||s.calc_order!==this||(s.product!==n||s._modified||s.partner!==this.partner||s.obj_delivery_state!==this.obj_delivery_state||s.department!==this.department)&&(s.product=n,s.obj_delivery_state=this.obj_delivery_state,s.partner=this.partner,s.department=this.department,s.owner.empty()||(t?e=e.then(()=>s.save()):s.name=s.prod_name()))}),e}dispatching_totals(){var e={reduce:!0,limit:1e4,group:!0,keys:[]};return this.production.forEach(({nom:t,characteristic:n})=>{n.empty()||t.is_procedure||t.is_service||t.is_accessory||e.keys.push([n.ref,"305e374b-3aa9-11e6-bf30-82cf9717e145",1,0])}),t.adapters.pouch.remote.doc.query("server/dispatching",e).then((function({rows:t}){const e={};return t&&t.forEach((function({key:t,value:n}){n.plan&&(n.plan=moment(n.plan).format("L")),n.fact&&(n.fact=moment(n.fact).format("L")),e[t[0]]=n})),e}))}print_data(e={}){const{organization:n,bank_account:s,partner:i,contract:r,manager:o}=this,{individual_person:a}=o,c=s&&!s.empty()?s:n.main_bank_account,l=[],{cat:{contact_information_kinds:_},utils:{blank:h,blob_as_text:p,snake_ref:d}}=t,u={АдресДоставки:this.shipping_address,ВалютаДокумента:this.doc_currency.presentation,ДатаЗаказаФорматD:moment(this.date).format("L"),ДатаЗаказаФорматDD:moment(this.date).format("LL"),ДатаТекущаяФорматD:moment().format("L"),ДатаТекущаяФорматDD:moment().format("LL"),ДоговорДатаФорматD:moment(r.date.valueOf()==h.date.valueOf()?this.date:r.date).format("L"),ДоговорДатаФорматDD:moment(r.date.valueOf()==h.date.valueOf()?this.date:r.date).format("LL"),ДоговорНомер:r.number_doc?r.number_doc:this.number_doc,ДоговорСрокДействия:moment(r.validity).format("L"),ЗаказНомер:this.number_doc,Контрагент:i.presentation,КонтрагентОписание:i.long_presentation,КонтрагентДокумент:"",КонтрагентКЛДолжность:"",КонтрагентКЛДолжностьРП:"",КонтрагентКЛИмя:"",КонтрагентКЛИмяРП:"",КонтрагентКЛК:"",КонтрагентКЛОснованиеРП:"",КонтрагентКЛОтчество:"",КонтрагентКЛОтчествоРП:"",КонтрагентКЛФамилия:"",КонтрагентКЛФамилияРП:"",КонтрагентИНН:i.inn,КонтрагентКПП:i.kpp,КонтрагентЮрФизЛицо:"",КратностьВзаиморасчетов:this.settlements_multiplicity,КурсВзаиморасчетов:this.settlements_course,ЛистКомплектацииГруппы:"",ЛистКомплектацииСтроки:"",Организация:n.presentation,ОрганизацияГород:n.contact_information._obj.reduce((t,e)=>t||e.city,"")||"Москва",ОрганизацияАдрес:n.contact_information._obj.reduce((t,e)=>e.kind==_.predefined("ЮрАдресОрганизации")&&e.presentation?e.presentation:t||(!e.presentation||e.kind!=_.predefined("ФактАдресОрганизации")&&e.kind!=_.predefined("ПочтовыйАдресОрганизации")?void 0:e.presentation),""),ОрганизацияТелефон:n.contact_information._obj.reduce((t,e)=>e.kind==_.predefined("ТелефонОрганизации")&&e.presentation?e.presentation:t||(e.kind==_.predefined("ФаксОрганизации")&&e.presentation?e.presentation:void 0),""),ОрганизацияБанкБИК:c.bank.id,ОрганизацияБанкГород:c.bank.city,ОрганизацияБанкКоррСчет:c.bank.correspondent_account,ОрганизацияБанкНаименование:c.bank.name,ОрганизацияБанкНомерСчета:c.account_number,ОрганизацияИндивидуальныйПредприниматель:n.individual_entrepreneur.presentation,ОрганизацияИНН:n.inn,ОрганизацияКПП:n.kpp,ОрганизацияСвидетельствоДатаВыдачи:n.certificate_date_issue,ОрганизацияСвидетельствоКодОргана:n.certificate_authority_code,ОрганизацияСвидетельствоНаименованиеОргана:n.certificate_authority_name,ОрганизацияСвидетельствоСерияНомер:n.certificate_series_number,ОрганизацияЮрФизЛицо:n.individual_legal.presentation,Офис:this.department.presentation,ПродукцияЭскизы:{},Проект:this.project.presentation,СистемыПрофилей:this.sys_profile,СистемыФурнитуры:this.sys_furn,Сотрудник:o.presentation,СотрудникКомментарий:o.note,СотрудникДолжность:a.Должность||"менеджер",СотрудникДолжностьРП:a.ДолжностьРП,СотрудникИмя:a.Имя,СотрудникИмяРП:a.ИмяРП,СотрудникОснованиеРП:a.ОснованиеРП,СотрудникОтчество:a.Отчество,СотрудникОтчествоРП:a.ОтчествоРП,СотрудникФамилия:a.Фамилия,СотрудникФамилияРП:a.ФамилияРП,СотрудникФИО:a.Фамилия+(a.Имя?" "+a.Имя[0].toUpperCase()+".":"")+(a.Отчество?" "+a.Отчество[0].toUpperCase()+".":""),СотрудникФИОРП:a.ФамилияРП+" "+a.ИмяРП+" "+a.ОтчествоРП,СуммаДокумента:this.doc_amount.toFixed(2),СуммаДокументаПрописью:this.doc_amount.in_words(),СуммаДокументаБезСкидки:this.production._obj.reduce((t,e)=>t+e.quantity*e.price,0).toFixed(2),СуммаСкидки:this.production._obj.reduce((t,e)=>t+e.discount,0).toFixed(2),СуммаНДС:this.production._obj.reduce((t,e)=>t+e.vat_amount,0).toFixed(2),ТекстНДС:this.vat_consider?this.vat_included?"В том числе НДС 18%":"НДС 18% (сверху)":"Без НДС",ТелефонПоАдресуДоставки:this.phone,СуммаВключаетНДС:r.vat_included,УчитыватьНДС:r.vat_consider,ВсегоНаименований:this.production.count(),ВсегоИзделий:0,ВсегоПлощадьИзделий:0,Продукция:[],Аксессуары:[],Услуги:[],Материалы:[],НомерВнутр:this.number_internal,КлиентДилера:this.client_of_dealer,Комментарий:this.note};this.extra_fields.forEach(t=>{u["Свойство"+t.property.name.replace(/\s/g,"")]=String(t.value)}),u.МонтажДоставкаСамовывоз=this.shipping_address?"Монтаж по адресу: "+this.shipping_address:"Самовывоз";for(let e in n._attachments)if(-1!=e.indexOf("logo")){l.push(n.get_attachment(e).then(t=>p(t,-1==t.type.indexOf("svg")?"data_url":"")).then(t=>{u.ОрганизацияЛоготип=t}).catch(t.record_log));break}return this.load_production().then(()=>{let n,s=Promise.resolve();const i=e.builder_props&&Object.assign({},t.CatCharacteristics.builder_props_defaults,e.builder_props);return this.production.forEach(r=>{r.characteristic.empty()||r.nom.is_procedure||r.nom.is_service||r.nom.is_accessory?r.nom.is_procedure||r.nom.is_service||!r.nom.is_accessory?r.nom.is_procedure||!r.nom.is_service||r.nom.is_accessory?r.nom.is_procedure||r.nom.is_service||r.nom.is_accessory||u.Материалы.push(this.row_description(r)):u.Услуги.push(this.row_description(r)):u.Аксессуары.push(this.row_description(r)):(u.Продукция.push(this.row_description(r)),u.ВсегоИзделий+=r.quantity,u.ВсегоПлощадьИзделий+=r.quantity*r.s,i?(n||(n=new t.EditorInvisible),s=s.then(()=>r.characteristic.draw(e,n).then(t=>{u.ПродукцияЭскизы[r.characteristic.ref]=t[d(r.characteristic.ref)].imgs.l0}))):r.characteristic.svg&&(u.ПродукцияЭскизы[r.characteristic.ref]=r.characteristic.svg))}),u.ВсегоПлощадьИзделий=u.ВсегоПлощадьИзделий.round(3),s.then(()=>(n&&n.unload(),(l.length?Promise.all(l):Promise.resolve([])).then(()=>{if("function"===typeof QRCode){const t=document.createElement("SVG");t.innerHTML="<g />";new QRCode(t,{text:"http://www.oknosoft.ru/zd/",width:100,height:100,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H,useSVG:!0});u.qrcode=t.innerHTML}return u})))})}row_description(e){e instanceof t.DocCalc_orderProductionRow||!e.characteristic||this.production.find_rows({characteristic:e.characteristic},t=>(e=t,!1));const{characteristic:n,nom:s,s:i,quantity:r,note:o}=e,a={ref:n.ref,НомерСтроки:e.row,Количество:r,Ед:e.unit.name||"шт",Цвет:n.clr.name,Размеры:e.len+"x"+e.width+", "+i+"м²",Площадь:i,Длина:e.len,Ширина:e.width,ВсегоПлощадь:i*r,Примечание:o,Комментарий:o,СистемаПрофилей:n.sys.name,Номенклатура:s.name_full||s.name,Характеристика:n.name,Заполнения:"",Фурнитура:"",Параметры:[],Цена:e.price,ЦенаВнутр:e.price_internal,СкидкаПроцент:e.discount_percent,СкидкаПроцентВнутр:e.discount_percent_internal,Скидка:e.discount.round(2),Сумма:e.amount.round(2),СуммаВнутр:e.amount_internal.round(2)};n.glasses.forEach(t=>{const{name:e}=t.nom;-1==a.Заполнения.indexOf(e)&&(a.Заполнения&&(a.Заполнения+=", "),a.Заполнения+=e)}),n.constructions.forEach(t=>{const{name:e}=t.furn;e&&-1==a.Фурнитура.indexOf(e)&&(a.Фурнитура&&(a.Фурнитура+=", "),a.Фурнитура+=e)});const c=new Map;n.params.forEach(t=>{t.param.include_to_description&&c.set(t.param,t.value)});for(let[t,e]of c)a.Параметры.push({param:t.presentation,value:e.presentation||e});return a}fill_plan(){this.planning.clear();const{wsql:e,aes:n,current_user:{suffix:s},msg:i,utils:r}=t,o=(e.get_user_param("windowbuilder_planning","string")||"/plan/")+"doc.calc_order/"+this.ref,a=r._clone(this._obj);a.characteristics={},this.load_production().then(t=>{for(const e of t)a.characteristics[e.ref]=r._clone(e._obj)}).then(()=>{const r=new Headers;r.append("Authorization","Basic "+btoa(unescape(encodeURIComponent(e.get_user_param("user_name")+":"+n.Ctr.decrypt(e.get_user_param("user_pwd")))))),s&&r.append("suffix",s),fetch(o,{method:"POST",headers:r,body:JSON.stringify(a)}).then(t=>t.json()).then(t=>{t.rows?this.planning.load(t.rows):console.log(t)}).catch(e=>{i.show_msg({type:"alert-warning",text:e.message,title:"Сервис планирования"}),t.record_log(e)})})}get is_read_only(){const{obj_delivery_state:e,posted:n,_data:s}=this,{Черновик:i,Шаблон:r,Отозван:o,Отправлен:a}=t.enm.obj_delivery_states;let c=!1;return e==r?c=!t.current_user.role_available("ИзменениеТехнологическойНСИ"):n||s._deleted?c=!t.current_user.role_available("СогласованиеРасчетовЗаказов"):e==a?c=!s._saving_trans&&!t.current_user.role_available("СогласованиеРасчетовЗаказов"):e.empty()||(c=e!=i&&e!=o&&!t.current_user.role_available("СогласованиеРасчетовЗаказов")),c}load_production(e){const n=[],{cat:{characteristics:s},enm:{obj_delivery_states:i}}=t;return this.production.forEach(({characteristic:t})=>{t.empty()||!e&&!t.is_new()||n.push(t.ref)}),s.adapter.load_array(s,n,!1,this.obj_delivery_state==i.Шаблон&&s.adapter.local.templates).then(()=>(n.length=0,this.production.forEach(({nom:t,characteristic:e})=>{e.empty()||(!t.is_procedure&&!t.is_accessory||e.specification.count()||e.constructions.count()||e.coordinates.count())&&n.push(e)}),n))}characteristic_saved(t,e){const{ox:n,_dp:s}=t,i=n.calc_order_row;i&&n.calc_order==this&&(i._data._loading=!0,i.nom=n.owner,i.note=s.note,i.quantity=s.quantity||1,i.len=n.x,i.width=n.y,i.s=n.s,i.discount_percent=s.discount_percent,i.discount_percent_internal=s.discount_percent_internal,i.unit.owner!=i.nom&&(i.unit=i.nom.storage_unit),i._data._loading=!1)}create_product_row({row_spec:e,elm:n,len_angl:s,params:i,create:r,grid:o}){const a=e instanceof t.DpBuyers_orderProductionRow&&!e.characteristic.empty()&&e.characteristic.calc_order===this?e.characteristic.calc_order_row:this.production.add({qty:1,quantity:1,discount_percent_internal:t.wsql.get_user_param("discount_percent_internal","number")});if(o&&(this.production.sync_grid(o),o.selectRowById(a.row)),!r)return a;const c=t.cat.characteristics;let l;return a.characteristic.empty()||a.characteristic._deleted||function(t){if(!t._deleted){for(let e in c.metadata().tabular_sections)t[e].clear();t.leading_elm=0,t.leading_product="",l=Promise.resolve(t)}}(a.characteristic),(l||c.create({ref:t.utils.generate_guid(),calc_order:this,product:a.row},!0)).then(s=>{if(e instanceof t.DpBuyers_orderProductionRow){if(i){const t=e.inset.used_params();i.find_rows({elm:e.row},n=>{t.includes(n.param)&&(s.params.add(n,!0).inset=e.inset)})}n.project={ox:s},n.fake_origin=e.inset,s.owner=e.inset.nom(n),s.origin=e.inset,s.x=e.len,s.y=e.height,s.z=e.depth,s.s=e.s||e.len*e.height/1e6,s.clr=e.clr,s.note=e.note}return Object.assign(a._obj,{characteristic:s.ref,nom:s.owner.ref,unit:s.owner.storage_unit.ref,len:s.x,width:s.y,s:s.s,qty:e&&e.quantity||1,quantity:e&&e.quantity||1,note:s.note}),s.name=s.prod_name(),this.is_new()&&!t.wsql.alasql.utils.isNode?this.save().then(()=>a):a})}process_add_product_list(e){let n=Promise.resolve();const s=[];return e.production.forEach(i=>{let r;if(i.inset.empty())r=this.production.add(i),r.unit=r.nom.storage_unit,i.clr.empty()||t.cat.characteristics.find_rows({owner:i.nom},t=>{if(t.clr==i.clr)return r.characteristic=t,!1}),n=n.then(()=>r);else{const t=new B(i),s=new G(i);n=n.then(()=>this.create_product_row({row_spec:i,elm:s,len_angl:t,params:e.product_params,create:!0})).then(e=>(i.inset.calculate_spec({elm:s,len_angl:t,ox:e.characteristic}),e.characteristic.specification.group_by("nom,clr,characteristic,len,width,s,elm,alp1,alp2,origin,dop","qty,totqty,totqty1"),i.characteristic=e.characteristic,e))}n=n.then(e=>Promise.all(t.spec_building.specification_adjustment({calc_order_row:e,spec:e.characteristic.specification,save:!0},!0)).then(t=>[].push.apply(s,t)))}),n.then(()=>s)}recalc(e={},n){const s=!n;s&&(n=new t.EditorInvisible);const i=n.create_scheme();let r=Promise.resolve();return this.load_production().then(t=>(this.production.forEach(t=>{const{characteristic:e}=t;if(e.empty()||e.calc_order!==this)t.value_change("quantity","",t.quantity);else if(e.coordinates.count())r=r.then(()=>i.load(e,!0).then(()=>{i.save_coordinates({svg:!1}),this.characteristic_saved(i)}));else{if(e.leading_product.calc_order===this)return;e.origin.empty()||e.origin.slave||(e.specification.clear(),e.origin.calculate_spec({elm:new G(t),len_angl:new B({len:t.len,inset:e.origin}),ox:e})),t.value_change("quantity","",t.quantity)}}),r)).then(()=>(i.ox="",s?n.unload():i.remove(),e.save?this.save():this))}draw(e={},n){!n&&(n=new t.EditorInvisible);n.create_scheme();e.res={number_doc:this.number_doc};let s=Promise.resolve();return this.load_production().then(t=>{for(let i of t)i.coordinates.count()&&(s=s.then(()=>i.draw(e,n)));return s})}static set_department(){const e=t.wsql.get_user_param("current_department");e&&(this.department=e);const{current_user:n,cat:s}=t;(n&&this.department.empty()||this.department.is_new())&&n.acl_objs&&n.acl_objs.find_rows({by_default:!0,type:s.divisions.class_name},t=>(this.department!=t.acl_obj&&(this.department=t.acl_obj),!1))}},t.DocCalc_order.FakeElm=G,t.DocCalc_order.FakeLenAngl=B,t.DocCalc_orderProductionRow=class extends t.DocCalc_orderProductionRow{value_change(e,n,s,i){let r,{_obj:o,_owner:a,nom:c,characteristic:l,unit:_}=this;const{rounding:h,_slave_recalc:p}=a._owner,d=t.DocCalc_orderProductionRow.rfields[e];if(d){o[e]="n"===d?parseFloat(s):""+s,c=this.nom,l=this.characteristic,l.empty()||(l.calc_order.empty()||l.owner==c?l.owner!=c&&(o.characteristic=t.utils.blank.guid,l=this.characteristic):l.owner=c),_.owner!=c&&(o.unit=c.storage_unit.ref);const{origin:n}=l;if(n&&!n.empty()&&n.slave){l.specification.clear(),l.x=this.len,l.y=this.width,l.s=this.s||this.len*this.width/1e6;const t=new B({len:this.len,inset:n}),e=new G(this);n.calculate_spec({elm:e,len_angl:t,ox:l}),r=!0}const i={calc_order_row:this,spec:l.specification},{price:a}=o;t.pricing.price_type(i),n instanceof t.DocPurchase_order?i.first_cost=o.first_cost:t.pricing.calc_first_cost(i),t.pricing.calc_amount(i),a&&!o.price&&(o.price=a,r=!0)}if(t.DocCalc_orderProductionRow.pfields.includes(e)||r){if(r||(o[e]=parseFloat(s)),isNaN(o.price)&&(o.price=0),isNaN(o.price_internal)&&(o.price_internal=0),isNaN(o.discount_percent)&&(o.discount_percent=0),isNaN(o.discount_percent_internal)&&(o.discount_percent_internal=0),o.amount=(o.price*((100-o.discount_percent)/100)*o.quantity).round(h),!i){const n={calc_order_row:this};let s=t.wsql.get_user_param("surcharge_internal","number");t.current_user.partners_uids.length&&s||(t.pricing.price_type(n),s=n.price_type.extra_charge_external),"price_internal"!=e&&o.price&&(o.price_internal=(o.price*(100-o.discount_percent)/100*(100+s)/100).round(h))}o.amount_internal=(o.price_internal*((100-o.discount_percent_internal)/100)*o.quantity).round(h);const _=a._owner;if(_.vat_consider){const{НДС18:e,НДС18_118:n,НДС10:s,НДС10_110:i,НДС20:r,НДС20_120:a,НДС0:l,БезНДС:h}=t.enm.vat_rates;switch(o.vat_rate=(c.vat_rate.empty()?e:c.vat_rate).ref,this.vat_rate){case e:case n:o.vat_amount=(18*o.amount/118).round(2);break;case s:case i:o.vat_amount=(10*o.amount/110).round(2);break;case r:case a:o.vat_amount=(20*o.amount/120).round(2);break;case l:case h:case"_":case"":o.vat_amount=0}_.vat_included||(o.amount=(o.amount+o.vat_amount).round(2))}else o.vat_rate="",o.vat_amount=0;const d=a.aggregate([],["amount","amount_internal"]);return d.doc_amount=d.amount.round(h),d.amount_internal=d.amount_internal.round(h),delete d.amount,Object.assign(_,d),_._manager.emit_async("update",_,d),p||(a._owner._slave_recalc=!0,a.forEach(t=>{if(t===this)return;const{origin:e}=t.characteristic;e&&!e.empty()&&e.slave&&t.value_change("quantity","update",t.quantity,i)}),a._owner._slave_recalc=!1),"quantity"!==e||l.empty()||l.calc_order.empty()||this._owner.find_rows({ordn:l},t=>{t.value_change("quantity",n,o.quantity,i)}),!1}}},t.DocCalc_orderProductionRow.rfields={nom:"s",characteristic:"s",quantity:"n",len:"n",width:"n",s:"n"},t.DocCalc_orderProductionRow.pfields="price,price_internal,quantity,discount_percent_internal",t.md.once("predefined_elmnts_inited",()=>{const{DocCalc_order:e,doc:{calc_order:n},cat:{destinations:s},cch:{properties:i},enm:{obj_delivery_states:r},job_prm:o}=t,a=s.predefined("Документ_Расчет");if(!a)return;const c=[{class_name:"cch.properties",ref:"198ac4ac-8453-11e9-bc71-873e65ad9246",name:"Параметры из системы",caption:"Параметры из системы",sorting_field:1143,available:!0,list:0,destination:a.ref,type:{types:["boolean"]}},{class_name:"cch.properties",ref:"28278e46-8453-11e9-bc71-873e65ad9246",name:"Уточнять систему",caption:"Уточнять систему",sorting_field:1144,available:!0,list:0,destination:a.ref,type:{types:["boolean"]}},{class_name:"cch.properties",ref:"323b3eaa-8453-11e9-bc71-873e65ad9246",name:"Уточнять фурнитуру",caption:"Уточнять фурнитуру",sorting_field:1145,available:!0,list:0,destination:a.ref,type:{types:["boolean"]}}];i.load_array(c);const l=c.map(({ref:t})=>i.get(t));Object.defineProperties(e.prototype,{refill_props:{get(){const t=this.extra_fields.find({property:l[0]});return t?t.value:o.builder.refill_props}},specify_sys:{get(){const t=this.extra_fields.find({property:l[1]});return!!t&&t.value}},specify_furn:{get(){const t=this.extra_fields.find({property:l[2]});return!!t&&t.value}},clear_templates_props:{value(){this.extra_fields.clear({property:{in:l}})}}});const{extra_fields:_}=Object.getPrototypeOf(n);n.extra_fields=function(t){const e=_.call(n,t);return t.obj_delivery_state===r.Шаблон?e.concat(l):e}}),(({adapters:{pouch:e},classes:n,cat:s,doc:i,job_prm:r,md:o,pricing:a,utils:c})=>{i.calc_order.constructor.prototype.get;function l(n){return e.local.templates&&e.remote.templates?function(t){return t?e.from_files(e.local.templates,e.remote.templates):Promise.resolve()}(n).then(s=>e.local.templates.replicate.from(e.remote.templates,{batch_size:300,batches_limit:3}).on("change",t=>{if(t.db="templates",e.emit_async("repl_state",t),!n&&t.ok)for(const{doc:e}of t.docs)"doc.nom_prices_setup"===e.class_name&&setTimeout(a.by_doc.bind(a,e),1e3)}).then(t=>(t.db="templates",e.emit_async("repl_state",t),s)).catch(n=>{n.result.db="templates",e.emit_async("repl_state",n.result),t.record_log(n)})):Promise.resolve()}function _(){return e.props._suffix&&r.templates||!e.local.templates&&e.local.__define("templates",{get:()=>e.remote.doc,configurable:!0,enumerable:!1}),Promise.resolve()}e.on({on_log_in:function(){if(!e.props._suffix||!r.templates)return _();!function(){const t=["cat.parameters_keys","cat.stores","cat.delivery_directions","cat.cash_flow_articles","cat.nonstandard_attributes","cat.projects","cat.choice_params","cat.nom_prices_types","cat.scheme_settings","doc.nom_prices_setup"];for(const e of t){const t=o.get(e);t.cachable=t.cachable.replace(/^doc/,"templates")}}();const{__opts:t}=e.remote.ram;if(e.remote.templates=new n.PouchDB(t.name.replace(/ram$/,"templates"),{skip_setup:!0,adapter:"http",auth:t.auth}),!e.props.direct)return e.local.templates=new n.PouchDB("templates",{adapter:"idb",auto_compaction:!0,revs_limit:3}),setInterval(l,6e5),l(!0).then(t=>"number"===typeof t&&e.rebuild_indexes("templates"));!e.local.templates&&e.local.__define("templates",{get:()=>e.remote.templates,configurable:!0,enumerable:!1})},user_log_out:function(){e.local.templates&&!e.local.hasOwnProperty("templates")&&delete e.local.templates}}),e.once("pouch_doc_ram_loaded",_)})(t),i}}).call(this,n(77))}}]);
//# sourceMappingURL=45.0b4a8f5f.chunk.js.map