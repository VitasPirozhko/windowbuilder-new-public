(this.webpackJsonpwindowbuilder=this.webpackJsonpwindowbuilder||[]).push([[3],{603:function(e,t,n){"use strict";var s=n(0),a=n.n(s),o=n(1),l=n.n(o),r=n(552),h=n(20),i=n(582),d=n.n(i),c=n(210),m=n(629),p=n(572),f=n(93),_=n(218);function g(){return(g=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e}).apply(this,arguments)}class u extends r.a{constructor(e,t){super(e,t),this.flatChange=()=>{this.setState(({flat:e})=>({flat:!e}),this.handleFilterChange)},this.handleSchemeChange=e=>{const{props:{handlers:t,_mgr:n},_meta:{fields:s},_mounted:a}=this;if(a&&e){e.set_default(),t.handleSchemeChange&&t.handleSchemeChange(e);const a=e.rx_columns({mode:"ts",fields:s,_mgr:n});this.handleFilterChange(e,a)}},this.handleFilterChange=(e,t)=>{const{state:n,rows:s,fakeRows:a,ranges:o}=this;e instanceof $p.CatScheme_settings||(e=n.scheme),t||(t=n.columns),s.clear(),a.clear(),o.length=0,this.onRowSelect({scheme:e,columns:t,rowCount:0,selectedRow:null},()=>{this.loadMoreRows({startIndex:0,stopIndex:49})})},this.loadMoreRows=({startIndex:e,stopIndex:t})=>{const{props:{_mgr:n,_owner:s,find_rows:a},state:{scheme:o,columns:l,ref:r,scrollSetted:h,flat:i,parent:d},rows:c,fakeRows:m,ranges:p}=this;e<0&&(e=0),t<e&&(t=e);let f=t-e;if(!f&&c.get(e))return;const _={startIndex:e,stopIndex:t};let g;for(const e of p){if(e.stopIndex>=_.stopIndex&&e.startIndex<=_.startIndex)return;e.stopIndex>=_.startIndex&&e.stopIndex<=_.stopIndex&&(e.stopIndex=Math.max(e.stopIndex,_.stopIndex),g=!0),e.startIndex<=_.stopIndex&&e.startIndex>=_.startIndex&&(e.startIndex=Math.min(e.startIndex,_.startIndex),g=!0)}g||p.push(_);for(let n=e;n<t;n++)m.set(n,{});return Promise.resolve().then(()=>{const c={no_rows:!1,network_error:null};if(h&&(c.scrollSetted=!1,c.ref=""),this.setState(c),/ram$/.test(n.cachable)||n._direct_loaded||n.direct_load){const a=n.get_search_selector({_obj:s?s._obj||s.props&&s.props._obj:null,_meta:s?s._meta:{},_fld:s&&s.props._fld,search:o._search,skip:e,top:f+1,sorting:o.sorting,flat:i,parent:d});return a.top<25&&(a.top=25),(n.direct_load&&!n._direct_loaded?n.direct_load():Promise.resolve()).then(()=>$p.utils._find_rows_with_sort.call(n,n.alatable,a)).then(({docs:n,count:s})=>{if(!i&&d&&!e){let e=d;do{n.unshift(e.toJSON()),s++,e=e.parent}while(!e.empty())}for(let n=e;n<=t;n++)m.delete(n);this.updateList(n,e,s),!e&&n.length&&this.setState({selectedRow:this.rows.get(0)},()=>this.grid.selectCell({rowIdx:0,idx:0}))})}{const i={columns:l,skip:e,limit:f+1,_owner:s};i.limit<25&&(i.limit=25);const d=n.mango_selector?n.mango_selector(o,i):o.mango_selector(i);return r&&!h&&(d.ref=r),d._raw=!0,(a?a(d,o):this.fromIndexer(d)).then(n=>{if(this._mounted){for(let n=e;n<=t;n++)m.delete(n);if(Array.isArray(n))this.updateList(n,e);else{const{docs:t,scroll:s,flag:a,count:o}=n;if(this.updateList(t,e,o),r&&!h){const e={scrollSetted:!0,ref:""};this.setState(e,()=>{this.grid.selectCell({rowIdx:s,idx:0})})}}}}).catch(e=>{this.setState({network_error:e}),this._mounted&&(this._timer=setTimeout(this.handleFilterChange,2600))})}})},this.updateList=(e,t,n)=>{const{rows:s}=this;for(let n=0;n<e.length;n++)s.set(n+t,e[n]);if(this._mounted){void 0===n&&(n=s.size);const e={no_rows:!n,rowCount:n};this.setState(e)}},this.rowGetter=e=>{if(e<0)return;const{rows:t}=this,n=t.get(e);if(!n){const{fakeRows:t,ranges:n,state:{rowCount:s}}=this;if(!t.get(e))if(s&&e>s-25)this.loadMoreRows({startIndex:s-50,stopIndex:s+1});else{let t,s=1/0;for(const a of n){const n=Math.min(Math.abs(a.startIndex-e),Math.abs(a.stopIndex-e));n<s&&(t=a,s=n)}if(t&&e<=t.startIndex){t.startIndex-e<50?this.loadMoreRows({startIndex:t.startIndex-50,stopIndex:t.startIndex}):this.loadMoreRows({startIndex:e-25,stopIndex:e+25+1})}else if(t&&e>=t.stopIndex){e-t.stopIndex<50?this.loadMoreRows({startIndex:t.stopIndex,stopIndex:t.stopIndex+50}):this.loadMoreRows({startIndex:e-25,stopIndex:e+25})}else this.loadMoreRows({startIndex:e,stopIndex:e+50})}return t.get(e)}return n},this.handleSettingsOpen=()=>{this.setState({settings_open:!0})},this.handleSettingsClose=()=>{this.setState({settings_open:!1})},this.handleConfirmClose=()=>{this.setState({confirm_text:""})},this.handleInfoText=e=>{"string"!==typeof e&&(e=""),this.setState({info_text:e})},this.handleSelect=()=>{const{selectedRow:e,props:{handlers:t,_mgr:n},state:{flat:s,parent:a},_mounted:o}=this;o&&(e?!s&&a&&e.is_folder?this.setState({parent:e.ref==a?a.parent:n.get(e.ref)},()=>this.handleFilterChange()):t.handleSelect&&t.handleSelect(e,n):this.handleInfoText("Не выбрана строка"))},this.handleAdd=e=>{const{handlers:t,_mgr:n}=this.props;t.handleAdd&&t.handleAdd(n,e)},this.handleEdit=e=>()=>{const{_meta:t,selectedRow:n,props:{handlers:s,_mgr:a},state:{flat:o,parent:l}}=this;if(!n||$p.utils.is_empty_guid(n.ref))return s.handleIfaceState({component:"",name:"alert",value:{open:!0,text:"Укажите строку для редактирования",title:t.synonym}});!e&&!o&&l&&n.is_folder?this.setState({parent:n.ref==l?l.parent:a.get(n.ref)},()=>this.handleFilterChange()):s.handleEdit&&s.handleEdit({row:n,ref:n.ref,_mgr:a})},this.handleRemove=()=>{const{_meta:e,selectedRow:t,props:{handlers:n,_mgr:s}}=this;!t||$p.utils.is_empty_guid(t.ref)?n.handleIfaceState({component:"",name:"alert",value:{open:!0,text:"Укажите строку для удаления",title:e.synonym}}):n.handleMarkDeleted&&(this._handleRemove=()=>{this.setState({confirm_text:""},()=>{Promise.resolve().then(()=>n.handleMarkDeleted({row:t,ref:t.ref,_mgr:s})).then(this.handleFilterChange).catch(e=>this.setState({network_error:e}))})},this.setState({confirm_text:"Удалить объект?"}))},this.handlePrint=e=>{const{selectedRow:t,props:{_mgr:n}}=this;t&&n.print(t.ref,e)},this.handleAttachments=()=>{const{selectedRow:e,props:{handlers:t,_mgr:n}}=this;e&&t.handleAttachments&&t.handleAttachments(e,n)},this.state={selectedRow:null,scrollSetted:!1,rowCount:0,settings_open:!1,network_error:"",no_rows:!1,ref:"",scheme:null,columns:[]},this.rows=new Map,this.fakeRows=new Map,this.ranges=[]}componentDidMount(){super.componentDidMount(),this.handleManagerChange(this.props)}handleManagerChange({_mgr:e,_meta:t,_ref:n}){const{class_name:s}=e,{flat:a,parent:o,_owner:l}=this.props;this._meta=t||e.metadata(),this.show_flat=this._meta.hierarchical;const r={ref:n||"",scrollSetted:!1,flat:a||!this.show_flat,parent:o||e.get()};if(!r.flat&&l&&l.props){const e=(l._obj||l.props&&l.props._obj)[l.props._fld];e&&!e.empty()&&(r.parent=e.parent)}this.setState(r),$p.cat.scheme_settings.get_scheme(s).then(this.handleSchemeChange)}fromIndexer(e){const{props:{_mgr:t,indexer:n},state:{scheme:s}}=this;if(!navigator.onLine||!s||!n)return t.find_rows_remote(e);const{remote:{doc:a},props:{_suffix:o}}=$p.adapters.pouch,{username:l,password:r}=a.__opts.auth;s.append_selection(e);const h={method:"post",credentials:"include",headers:{Authorization:"Basic "+btoa(unescape(encodeURIComponent(l+":"+r))),suffix:o||"0"},body:JSON.stringify(e)};return fetch("/r/_find",h).then(e=>e.status<=201?e.json():e.text().then(t=>{throw new Error(`${e.statusText}: ${t}`)})).then(e=>(e.docs.forEach(e=>{e.ref||(e.ref=e._id.split("|")[1],delete e._id)}),e))}get selectedRow(){const{state:{selectedRow:e},rows:t}=this;return"number"===typeof e?t.get(e):e}get ltitle(){const{_mgr:e}=this.props;return(e.metadata().list_presentation||e.metadata().synonym)+" (список)"}get Toolbar(){return m.a}onRowSelect(e,t){this.setState(e,t),this.props.onRowSelect&&this.props.onRowSelect(e)}render(){const{state:e,props:t,context:n,sizes:s,handleFilterChange:o,handleSchemeChange:l,Toolbar:r,show_flat:h}=this,{columns:i,scheme:m,confirm_text:u,info_text:w,settings_open:x,rowCount:C,flat:S}=e,{_mgr:{RepParams:I},classes:E,title:y,registerFilterChange:b,width:v,height:R,GridRenderer:k,rowHeight:M,...j}=t;if(!m)return a.a.createElement(c.a,{text:"Чтение настроек компоновки..."});if(!i||!i.length)return a.a.createElement(c.a,{text:"Ошибка настроек компоновки..."});b&&b(o);const A=!x||s.height>572,O={scheme:m,...j,settings_open:x,flat:S,show_flat:h,flatChange:this.flatChange,handleSelect:this.handleSelect,handleAdd:this.handleAdd,handleEdit:this.handleEdit(!0),handleRemove:this.handleRemove,handlePrint:this.handlePrint,handleSettingsOpen:this.handleSettingsOpen,handleSettingsClose:this.handleSettingsClose,handleSchemeChange:l,handleFilterChange:o};return a.a.createElement("div",null,!n.dnr&&a.a.createElement(_.a,{key:"helmet",title:y},a.a.createElement("meta",{name:"description",content:"Форма списка"}),a.a.createElement("meta",{property:"og:title",content:y}),a.a.createElement("meta",{property:"og:description",content:"Форма списка"})),u&&a.a.createElement(f.a,{key:"confirm",title:this._meta.synonym,text:u,handleOk:this._handleRemove,handleCancel:this.handleConfirmClose,open:!0}),w&&a.a.createElement(f.a,{key:"info",title:this._meta.synonym,text:w,handleOk:this.handleInfoText,handleCancel:this.handleInfoText,open:!0}),a.a.createElement(r,g({key:"toolbar"},O)),x&&a.a.createElement(p.a,{key:"settings",height:A?272:(s.height||500)-104,scheme:m,tabParams:I&&a.a.createElement(I,{scheme:m,handleFilterChange:o}),handleSchemeChange:l}),a.a.createElement(d.a,{key:"grid",ref:e=>this.grid=e,rowHeight:M||33,minHeight:s.height-50-(x?320:0),minWidth:n.dnr&&Math.max(s.width,s.columnsWidth),cellNavigationMode:"changeRow",columns:i,rowGetter:this.rowGetter,rowsCount:C,onCellDeSelected:()=>this.onRowSelect({selectedRow:null}),onCellSelected:e=>this.onRowSelect({selectedRow:this.rows.get(e.rowIdx)||e.rowIdx}),onRowDoubleClick:t.selectionMode?this.handleSelect:this.handleEdit(),onGridSort:(e,t)=>{m.first_sorting(e,t),this.handleFilterChange()}}))}}u.propTypes={_mgr:l.a.object.isRequired,_acl:l.a.string,_meta:l.a.object,_ref:l.a.string,_owner:l.a.object,selectionMode:l.a.bool,read_only:l.a.bool,denyAddDel:l.a.bool,show_search:l.a.bool,show_variants:l.a.bool,modal:l.a.bool,handlers:l.a.object.isRequired},u.defaultProps={denyAddDel:!1,read_only:!1,minHeight:220},u.contextTypes={dnr:l.a.object},t.a=Object(h.withIface)(u)},629:function(e,t,n){"use strict";var s=n(0),a=n.n(s),o=(n(1),n(447)),l=n(160),r=n(159),h=n(158),i=n(206),d=n(524),c=n(214),m=n.n(c),p=n(601),f=n.n(p),_=n(231),g=n.n(_),u=n(215),w=n.n(u),x=n(561),C=n.n(x),S=n(221),I=n.n(S),E=n(631),y=n.n(E),b=n(630),v=n.n(b),R=n(604),k=n(600),M=n(607),j=n(34),A=(n(7),n(86)),O=n(484),F=n(560);class P extends s.Component{constructor(...e){super(...e),this.state={anchorEl:void 0,open:!1},this.handleClick=e=>{this.setState({open:!0,anchorEl:e.currentTarget})},this.handleRequestClose=()=>{this.setState({open:!1})},this.handleSettingsToggle=()=>{const{props:e}=this;e.settings_open?e.handleSettingsClose():e.handleSettingsOpen(),this.handleRequestClose()}}render(){const{props:e,state:t}=this,{classes:n,scheme:s,width:c,btns:p,end_btns:_,menu_items:u,toolbar2row:x,flat:S,show_flat:E,setting_in_menu:b}=e,j=Object(O.c)("sm",c);return[a.a.createElement(o.a,{key:"toolbar1",disableGutters:!0,className:n.toolbar},e.selectionMode&&a.a.createElement(r.a,{key:"select",title:"Выбрать из списка",size:"small",variant:"outlined",className:n.spaceLeft,onClick:e.handleSelect},"Выбрать"),!e.denyAddDel&&a.a.createElement(l.a,{key:"create",title:"Создать объект",onClick:e.handleAdd},a.a.createElement(m.a,null)),a.a.createElement(l.a,{key:"edit",title:"Открыть форму объекта",onClick:e.handleEdit},a.a.createElement(g.a,null)),!e.denyAddDel&&!e.denyDel&&a.a.createElement(l.a,{key:"del",title:"Пометить на удаление",onClick:e.handleRemove},a.a.createElement(f.a,null)),E&&a.a.createElement(l.a,{key:"flat",title:S?"Включить иерархию":"Включить плоский список",onClick:e.flatChange},S?a.a.createElement(v.a,null):a.a.createElement(y.a,null)),!s.standard_period.empty()&&j&&a.a.createElement(l.a,{disabled:!0},"|"),!s.standard_period.empty()&&j&&a.a.createElement(M.a,{_obj:s,_fld:"date",_meta:{synonym:"Период"},classes:n,handleChange:e.handleFilterChange}),(!x||j)&&p,a.a.createElement("div",{className:n.flex}),a.a.createElement(R.a,{handleSettingsOpen:e.handleSettingsOpen,handleSettingsClose:e.handleSettingsClose,handleSchemeChange:e.handleSchemeChange,handleFilterChange:e.handleFilterChange,settings_open:e.settings_open,classes:n,scheme:s,show_search:e.show_search&&(!x||j),show_variants:e.show_variants,hide_btn:!j||b}),(!x||j)&&_,a.a.createElement(l.a,{onClick:this.handleClick,title:"Дополнительно"},a.a.createElement(w.a,null)),a.a.createElement(h.a,{anchorEl:t.anchorEl,open:t.open,onClose:this.handleRequestClose},(!j||b)&&a.a.createElement(i.a,{onClick:this.handleSettingsToggle},a.a.createElement(d.a,null,a.a.createElement(I.a,null)),"Настройки"),e.handlePrint&&a.a.createElement(F.a,{scheme:s,handlePrint:e.handlePrint}),e.handleAttachments&&a.a.createElement(i.a,{onClick:e.handleAttachments},a.a.createElement(d.a,null,a.a.createElement(C.a,null)),"Вложения"),u)),x&&!j&&a.a.createElement(o.a,{key:"toolbar2",disableGutters:!0,className:n.toolbar},p,a.a.createElement("div",{className:n.flex}),_,a.a.createElement(k.a,{scheme:s,handleFilterChange:e.handleFilterChange,isWidthUp:j}))]}}P.propTypes={},P.defaultProps={show_search:!0},t.a=Object(j.compose)(A.a,Object(O.a)())(P)},630:function(e,t,n){"use strict";var s=n(12);Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var a=s(n(0)),o=(0,s(n(13)).default)(a.default.createElement("path",{d:"M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"}),"List");t.default=o},631:function(e,t,n){"use strict";var s=n(12);Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var a=s(n(0)),o=(0,s(n(13)).default)(a.default.createElement("path",{d:"M22 11V3h-7v3H9V3H2v8h7V8h2v10h4v3h7v-8h-7v3h-2V8h2v3z"}),"AccountTree");t.default=o}}]);
//# sourceMappingURL=3.2e80dbf5.chunk.js.map