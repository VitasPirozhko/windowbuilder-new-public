(this.webpackJsonpwindowbuilder=this.webpackJsonpwindowbuilder||[]).push([[41],{1032:function(e,t,s){"use strict";s.r(t);var r=s(0),a=s.n(r),n=s(159),o=s(85),c=s(166),l=s(74);var i=Object(l.a)(e=>({entered:{minHeight:120},secondary:{marginTop:-e.spacing(1.5)},groupTitle:{fontWeight:"bold"},listitem:{paddingTop:e.spacing(),paddingBottom:e.spacing()}})),d=s(34);var h=Object(d.compose)(i,Object(c.connect)((function(e,t){return{handleCalck:()=>Promise.resolve(),handleCancel(){t.handlers.handleIfaceState({component:"CalcOrderList",name:"dialog",value:null}),"btn_share"===t.dialog.cmd&&t.handlers.handleIfaceState({component:"DataObjPage",name:"dialog",value:null})},handleOpen(e){t.handlers.handleNavigate("/doc.calc_order/"+e.replace("doc.calc_order|",""))}}}))),p=s(1),u=s.n(p),m=s(235);class f extends m.a{constructor(...e){super(...e),this.on_index=e=>{this.setState({step:`Перестраиваем индекс ${e.index}...`})}}sync_orders(e,t){const{local:s,remote:r}=$p.adapters.pouch;return this.setState({step:"Сравниваем версии заказов local и remote...",completed:0,buffer:10}),r.doc.allDocs({keys:t}).then(({rows:s})=>{const r=[];for(const t of s)t.value&&(e.some(e=>e.key&&e.value?e.id===t.id&&e.value.rev===t.value.rev:e._id===t.id&&e._rev===t.value.rev)||r.push(t.id));return{ldoc:t,diff:r}}).then(({ldoc:e,diff:t})=>t.length?(this.setState({step:"Получаем объекты заказов с сервера...",completed:0,buffer:10}),r.doc.allDocs({include_docs:!0,attachments:!0,keys:t}).then(({rows:e})=>(this.setState({step:"Записываем изменённые заказы..."}),s.doc.bulkDocs(e.filter(e=>e.doc).map(({doc:e})=>e),{new_edits:!1}))).then(()=>(this.setState({step:"Получаем объекты заказов из базы браузера...",completed:0,buffer:10}),s.doc.allDocs({include_docs:!0,keys:e})))):(this.setState({step:"Получаем объекты заказов из базы браузера...",completed:0,buffer:10}),s.doc.allDocs({include_docs:!0,keys:e})))}sync_products(e){const{local:t,remote:s}=$p.adapters.pouch,r=[];for(const{production:t}of e)if(t)for(const e of t)e.characteristic&&e.characteristic!==$p.utils.blank.guid&&r.push("cat.characteristics|"+e.characteristic);return this.setState({step:"Сравниваем версии характеристик продукций...",completed:0,buffer:10}),Promise.all([t.doc.allDocs({keys:r}),s.doc.allDocs({keys:r})]).then(e=>{const t=e[0].rows,s=[];for(const r of e[1].rows)r.value&&(t.some(e=>!e.error&&e.id===r.id&&e.value.rev===r.value.rev)||s.push(r.id));const r={length:s.length,rows:[]};this.setState({step:`Найдено ${r.length} отличий в характеристиках`,completed:0,buffer:10});let a=[];for(const e of s)a.length<100?a.push(e):(r.rows.push(a),a=[e]);return a.length&&r.rows.push(a),r}).then(e=>e.rows.reduce((r,a,n)=>r.then(()=>(this.setState({step:`Обработано ${100*n} из ${e.length} характеристик продукций`}),s.doc.allDocs({include_docs:!0,keys:a}).then(({rows:e})=>t.doc.bulkDocs(e.filter(e=>e.doc&&!e.doc._attachments).map(e=>e.doc),{new_edits:!1})))),Promise.resolve()))}rebuild_indexes(e="doc"){return this.setState({step:"Перестраиваем индексы...",completed:0,buffer:10}),$p.adapters.pouch.on("rebuild_indexes",this.on_index),$p.adapters.pouch.rebuild_indexes(e,!0).then(()=>{$p.adapters.pouch.off("rebuild_indexes",this.on_index),this.timer&&(clearInterval(this.timer),this.timer=0),this.setState({error:"Обработка завершена"}),setTimeout(()=>{const{props:e}=this;if(e.handleCancel(),e.dialog&&e.dialog.wnd){const{elmnts:t}=e.dialog.wnd;t&&t.filter&&t.filter.call_event()}},2e3)})}}f.propTypes={handleCancel:u.a.func.isRequired};var _=f;class b extends _{init(){const{local:e,remote:t}=$p.adapters.pouch,{utils:{moment:s},doc:{calc_order:r}}=$p;this.setState({step:"Получаем последние 70 заказов текущего пользователя..."}),r.create({},!0).then(e=>{const s=e.number_doc.substr(0,7);return e.unload(),t.doc.query("doc/number_doc",{limit:70,include_docs:!1,startkey:[r.class_name,(new Date).getFullYear(),s+"￰"],endkey:[r.class_name,(new Date).getFullYear(),s],descending:!0})}).then(({rows:t})=>(this.setState({step:"Получаем массив заказов текущей базы..."}),e.doc.find({selector:{class_name:r.class_name,date:{$gte:s().subtract(3,"months").format("YYYY-MM-DD"),$lte:s().add(1,"months").format("YYYY-MM-DD")}},fields:["_id","_rev","state"],limit:1e4}).then(({docs:e})=>{const s=e.filter(e=>"template"!==e.state).map(e=>e._id);for(const{id:e}of t)-1===s.indexOf(e)&&s.push(e);return this.sync_orders(e,s)}))).then(({rows:e})=>{const t=e.filter(e=>e.doc).map(e=>e.doc);return this.sync_products(t)}).then(()=>this.rebuild_indexes()).catch(e=>{this.setState({error:e.message||"Ошибка синхронизации заказов"})})}}b.propTypes={dialog:u.a.object.isRequired,handleCancel:u.a.func.isRequired};var g=b,y=s(329),v=s(456),k=s(460),w=s(521);class $ extends _{constructor(...e){super(...e),this.handleOpen=e=>()=>{this.props.handleCancel(),this.props.handleOpen(e)}}init(){const{local:e,remote:t}=$p.adapters.pouch;this.setState({step:"Получаем inbox-документ текущего пользователя..."}),t.doc.get("_local/inbox_"+$p.current_user.ref).then(t=>{this.setState({step:"Сравниваем версии входящих заказов..."});const s=[];for(const e in t)"_"!=e[0]&&s.push({ref:e});const r=s.map(e=>"doc.calc_order|"+e.ref);return e.doc.allDocs({keys:r}).then(({rows:e})=>this.sync_orders(e,r))}).then(({rows:e})=>{const t=e.filter(e=>e.doc).map(e=>e.doc);return this.sync_products(t).then(()=>{t.sort((e,t)=>{const s=e.timestamp?e.timestamp.moment:e.date,r=t.timestamp?t.timestamp.moment:t.date;return s>r?-1:r>s?1:0}),this.timer&&(clearInterval(this.timer),this.timer=0),this.setState({docs:t})})}).catch(e=>{this.setState({error:e.message||"Ошибка доступа к _local/inbox_"})})}render(){const{error:e,step:t,docs:s,completed:r,buffer:n}=this.state,{moment:o}=$p.utils;return e?a.a.createElement("div",null,e):s?a.a.createElement(v.a,{key:"list"},s.map(e=>{const{_id:t,number_doc:s,date:r,posted:n,timestamp:c,partner:l,client_of_dealer:i,manager:d}=e;return a.a.createElement(k.a,{key:t,button:!0,onDoubleClick:this.handleOpen(t)},a.a.createElement(w.a,{primary:`№${s||"б/н"} от ${o(r).format(o._masks.ldt)} (${n?"":"не "}проведен), ${i||$p.cat.partners.get(l).name||"Клиент не указан"}`,secondary:""+($p.cat.users.get(d).name||c&&c.user)}))})):[a.a.createElement("div",{key:"progress",style:{flexGrow:1}},a.a.createElement(y.a,{color:"secondary",variant:"buffer",value:r,valueBuffer:n}),a.a.createElement("br",null)),a.a.createElement("div",{key:"text"},t)]}}$.propTypes={dialog:u.a.object.isRequired};var S=$,C=s(538),x=s(46);class D extends r.Component{constructor(e,t){super(e,t),this.handleToggle=e=>()=>{const t=this.state.users.get(e),{ref:s}=this.state.doc,{doc:r}=$p.adapters.pouch.remote;Object.prototype.hasOwnProperty.call(t,s)?delete t[s]:t[s]=!0,r.get(t._id).catch(e=>{if(404!=e.status)throw e;return t}).then(e=>(e!==t&&(Object.prototype.hasOwnProperty.call(e,s)?delete e[s]:e[s]=!0),r.put(e))).then(()=>{this.forceUpdate()}).catch(e=>{this.setState({error:e.message||"Не удалось записать "+t._id})})},this.state={error:"",doc:null,users:null};const{ref:s}=this.props.dialog,{current_user:r}=$p;$p.utils.is_empty_guid(s)?this.state.error="При открытии из формы списка, укажите текущую строку заказа, который собираетесь отправить сотруднику":r&&!r.branch.empty()||(this.state.error="Нельзя поделиться заказом центральной базы - только из базы отдела")}componentDidMount(){const{state:{error:e},props:{dialog:t}}=this,s=new Map;if(!e){const e=$p.doc.calc_order.get(t.ref),{branch:r}=$p.current_user;(e.is_new()?e.load():Promise.resolve()).then(()=>{$p.cat.users.find_rows({branch:r,push_only:!0},e=>s.set(e,{})),s.size<1?this.setState({error:`Некому отправлять, в филиале "${r.name}", нет сотрудников с push-репликацией`}):$p.adapters.pouch.remote.doc.allDocs({include_docs:!0,keys:Array.from(s.keys()).map(e=>"_local/inbox_"+e.ref)}).then(({rows:t})=>{for(const e of t){const t=s.get($p.cat.users.get(e.key.replace("_local/inbox_","")));e.error?t._id=e.key:Object.assign(t,e.doc)}this.setState({doc:e,users:s})}).catch(e=>{this.setState({error:e.message||"Ошибка доступа к _local/inbox_"})})})}}render(){const{error:e,doc:t,users:s}=this.state;return e?a.a.createElement("div",null,e):t?[a.a.createElement(x.a,{variant:"subtitle1",key:"doc",gutterBottom:!0},t.presentation),a.a.createElement(v.a,{key:"list"},Array.from(s.keys()).map(e=>a.a.createElement(k.a,{key:e.ref,button:!0,onClick:this.handleToggle(e)},a.a.createElement(C.a,{checked:!!s.get(e)[t.ref],tabIndex:-1,disableRipple:!0}),a.a.createElement(w.a,{primary:e.name}))))]:a.a.createElement("div",null,"Подготовка данных...")}}var E=D;class O extends r.Component{constructor(e,t){super(e,t),this.handleOk=()=>{this.handleCalck().then(this.handleCancel)};const{handleCancel:s,handleCalck:r}=e;this.handleCancel=s.bind(this),this.handleCalck=r.bind(this),this.state={info:null,err:null,title:"Утилиты автономного режима",Component:null}}componentDidMount(){$p.adapters.pouch.remote.doc.info().then(e=>{this.setState({info:e},()=>{switch(this.props.dialog.cmd){case"btn_download":this.setState({Component:g,title:"Обновление заказов из облака"});break;case"btn_share":this.setState({Component:E,title:"Отправка заказа сотруднику"});break;case"btn_inbox":this.setState({Component:S,title:"Входящие заказы"})}})}).catch(e=>{this.setState({error:e.message||"Ошибка доступа к базе doc"})})}renderContent(){const{err:e,info:t,Component:s}=this.state;return e?a.a.createElement("div",null,"Сервер недоступен"):t?s?a.a.createElement(s,Object.assign({},this.props,{handleCancel:this.handleCancel})):a.a.createElement("div",null,"Подготовка данных..."):a.a.createElement("div",null,"Проверка связи с сервером...")}render(){const{handleCancel:e,state:{title:t}}=this;return a.a.createElement(o.a,{open:!0,initFullScreen:!0,large:!0,title:t,onClose:e,actions:[a.a.createElement(n.a,{key:"cancel",onClick:e,color:"primary"},"Закрыть")]},this.renderContent())}}var j=h(O);t.default=j}}]);
//# sourceMappingURL=41.129054ec.chunk.js.map