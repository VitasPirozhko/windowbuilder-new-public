(this.webpackJsonpwindowbuilder=this.webpackJsonpwindowbuilder||[]).push([[15],{1041:function(e,t,a){"use strict";a.r(t);var n=a(0),s=a.n(n),r=a(563),c=a(5),i=a(1014),o=a(1011),l=a(1012),d=a(159),h=a(456),u=a(537),m=a(500),p=a(517),g=a(147),f=a(453);function _({mode:e,setMode:t}){return s.a.createElement(g.a,{component:"fieldset"},s.a.createElement(f.a,{component:"legend"},"Материалы к оптимизации"),s.a.createElement(m.a,{value:e,onChange:e=>{t(e.target.value)}},s.a.createElement(p.a,{value:"all",control:s.a.createElement(u.a,null),label:"Все профили"}),s.a.createElement(p.a,{value:"clrs",control:s.a.createElement(u.a,null),label:"Только цветные"})))}var w=a(585),k=a(636);const E=["Выбор профилей","Раскрой","Анализ"];class y extends s.a.Component{constructor(...e){super(...e),this.state={activeStep:0,evaluating:!0,statuses:[],mode:"all"},this.handleNext=()=>{const{activeStep:e}=this.state;this.setState({activeStep:e+1}),0===e&&this.fillAndRun().then(()=>{}).catch(()=>null).then(()=>{this.setState({evaluating:!1},this.handleNext)})},this.handleBack=()=>{const{activeStep:e}=this.state;this.setState({activeStep:e-1})},this.handleReset=()=>{this.setState({activeStep:0})},this.setMode=e=>{this.setState({mode:e})},this.handleOnStep=e=>{const{nom:t,characteristic:a}=e.cut_row,n=$p.utils._clone(this.state.statuses);let s;n.some(e=>{if(e.nom===t&&e.characteristic===a)return s=e,!0})||(s={nom:t,characteristic:a},n.push(s)),Object.assign(s,e),this.setState({statuses:n})}}componentDidMount(){$p.doc.work_centers_task.create().then(e=>{this.doc=e,e.fill_by_orders([this.props.dialog.ref]).then(()=>this.setState({evaluating:!1}))})}componentWillUnmount(){this.doc&&this.doc.unload()}handleCalck(){const{props:{dialog:e},doc:t}=this,a=$p.doc.calc_order.get(e.ref),{production:n}=e.wnd?e.wnd.elmnts.grids:{};return t.cuts.clear({record_kind:"Расход"}),t.cuts.group_by(["nom","characteristic"],["quantity"]),t.cuts.forEach(e=>{if(!e.quantity)return;const t=a.production.add({nom:e.nom,characteristic:e.characteristic,quantity:e.quantity,qty:e.quantity,len:0,width:0});t.s=0,n&&n.refresh_row(t)}),Promise.resolve()}fillAndRun(){const{state:{mode:e},doc:t}=this;return this.setState({evaluating:!0,statuses:[]}),t.demand.clear(),t.cuts.clear(),t.cutting.clear(),t.fill_cutting({clr_only:"clrs"===e}).then(()=>t.optimize({onStep:this.handleOnStep}))}getStepContent(){const{state:{mode:e,activeStep:t,statuses:a},setMode:n,doc:r}=this;switch(t){case 0:return s.a.createElement(_,{mode:e,setMode:n});case 1:return s.a.createElement(h.a,null,a.map((e,t)=>s.a.createElement(w.a,{key:"p-"+t,status:e})));case 2:return r?s.a.createElement(k.a,{_obj:r,hide_head:!0}):"Документ пуст";default:return"Ошибка шага"}}render(){const{props:{classes:e},state:{activeStep:t,evaluating:a},doc:n}=this;return s.a.createElement("div",{className:e.root},s.a.createElement(i.a,{activeStep:t,classes:{root:e.head}},E.map(e=>s.a.createElement(o.a,{key:e},s.a.createElement(l.a,null,e)))),s.a.createElement("div",null,s.a.createElement("div",{className:e.instructions},this.getStepContent()),!n&&s.a.createElement("div",null,"Подготовка данных"),s.a.createElement("div",null,s.a.createElement(d.a,{disabled:0===t||t===E.length-1||a,onClick:this.handleBack,className:e.backButton},"Назад"),s.a.createElement(d.a,{disabled:a,variant:"contained",color:"primary",onClick:t===E.length-1?this.handleReset:this.handleNext},t===E.length-1?"Сброс":"Далее"))))}}var v=Object(c.a)(e=>({root:{width:"100%"},head:{padding:e.spacing()},backButton:{marginRight:e.spacing()},instructions:{marginTop:e.spacing(),marginBottom:e.spacing(),maxHeight:"calc(100vh - 320px)",overflow:"auto"}}))(y);t.default=function(e){return s.a.createElement(r.a,Object.assign({Content:v,title:"Раскрой",actions:{ok:"Добавить обрезь в заказ"}},e))}},548:function(e,t,a){"use strict";a.d(t,"b",(function(){return h})),a.d(t,"c",(function(){return u})),a.d(t,"e",(function(){return m})),a.d(t,"f",(function(){return p})),a.d(t,"d",(function(){return g}));var n=a(166),s=a(555),r=a(34),c=a(0),i=a.n(c),o=a(546);class l extends c.Component{render(){const{dp:e,meta:t,scheme:a,tref:n,onRowUpdated:s,onCellSelected:r,minHeight:c}=this.props;return i.a.createElement(o.a,{ref:n,_obj:e,_meta:t,_tabular:"production",scheme:a,onRowUpdated:s,onCellSelected:r,minHeight:c,hideToolbar:!0})}}const{ItemData:d}=$p.cat.inserts;function h(e,t){t||(t=this.items=$p.enm.inserts_types.additions_groups);const a=this.dp=$p.dp.buyers_order.create();a.calc_order=$p.doc.calc_order.by_ref[e];const n=this.components=new Map;t.forEach(e=>n.set(e,new d(e,l)));const{production:s,product_params:r}=a;a._data._loading=!0,a.calc_order.production.find_rows({ordn:$p.utils.blank.guid},e=>{const{characteristic:a}=e,{origin:c}=a;if(!a.empty()&&c&&!c.empty()&&-1!=t.indexOf(c.insert_type)){const t=n.get(c.insert_type),i=s.count()+1;a.params.forEach(({param:e,value:t})=>{r.add({elm:i,param:e,value:t})}),s.add({characteristic:a,inset:c,clr:a.clr,len:e.len,height:e.width,quantity:e.quantity,note:e.note},!1,t.ProductionRow),t.count++}}),a._data._loading=!1}function u(e=[]){const t=new Map;for(const a of e)for(const e of this.items)if(e&&a.name==e.name){t.set(e,a);break}this.setState({schemas:t})}function m(){const{tabular:e,props:t}=this,a=g.call(this,t.group);if(a&&e){const{_data:n}=e.state._tabular._owner;n._loading=!0;const s=e.state._tabular.add({inset:a,quantity:1},!1,t.ProductionRow);if(n._loading=!1,s.value_change("inset","force",s.inset),this.setState({count:this.state.count+1}),a.insert_type==$p.enm.inserts_types.Параметрик)for(let t=0;t<s.row;t++)if(e.rowGetter(t)===s){setTimeout(()=>e._grid.selectCell({rowIdx:t,idx:0},!0));break}}else $p.msg.show_msg({type:"alert-info",text:`Нет вставки подходящего типа (${t.group})`,title:"Новая строка"})}function p(){const{props:e,tabular:t,state:a,selectedRow:n}=this;if(t&&n){const{calc_order_row:s}=n.characteristic;n._owner.del(n),this.selectedRow=null,t.forceUpdate(),a.count&&this.setState({count:a.count-1}),s&&s._owner.del(s),e.onSelect&&e.onSelect(null)}else $p.msg.show_msg({type:"alert-info",text:`Укажите строку для удаления (${e.group})`,title:"Удаление строки"})}function g(e){if(!this._inset){const{choice_params:t}=$p.dp.buyers_order.metadata("production").fields.inset,a={insert_type:e};t&&t.forEach(({name:e,path:t})=>{"insert_type"!==e&&(Object.prototype.hasOwnProperty.call(a,e)?(a[e]=[a[e]],a[e].push(t)):a[e]=t)}),this._inset=$p.cat.inserts.find_rows(a).reduce((e,t)=>e&&e.priority>=t.priority?e:t,null)}return this._inset}t.a=Object(r.compose)(s.a,Object(n.connect)((function(e,t){return{handleCalck(){const{additions:e}=this,{dp:a}=e;return a?a.calc_order.process_add_product_list(a).then(()=>{a.calc_order.production.sync_grid(t.dialog.wnd.elmnts.grids.production)}):e.handleCalck()},handleCancel(){t.handlers.handleIfaceState({component:"DataObjPage",name:"dialog",value:null})}}})))},555:function(e,t,a){"use strict";var n=a(74);t.a=Object(n.a)(e=>({entered:{minHeight:120},secondary:{marginTop:-e.spacing(1.5)},groupTitle:{fontWeight:"bold"},listitem:{paddingTop:e.spacing(),paddingBottom:e.spacing()}}))},563:function(e,t,a){"use strict";var n=a(0),s=a.n(n),r=a(159),c=a(85),i=a(548);class o extends s.a.Component{constructor(e,t){super(e,t),this.handleOk=()=>{this.props.handleCalck.call(this).then(this.handleCancel).catch(e=>{this.setState({msg:e.msg||e.message})})},this.handleCalck=()=>{this.props.handleCalck.call(this).catch(e=>{this.setState({msg:e.msg})})},this.handleErrClose=()=>{this.setState({msg:null,queryClose:!1})},this.queryClose=()=>{this.setState({queryClose:!0})};const{handleCancel:a}=e;this.handleCancel=a.bind(this),this.state={msg:null,queryClose:!1}}render(){const{handleCancel:e,handleErrClose:t,props:{dialog:a,title:n,actions:i,Content:o},state:{msg:l,queryClose:d}}=this;return s.a.createElement(c.a,{open:!0,initFullScreen:!0,large:!0,title:n,onClose:this.queryClose,actions:[!i&&s.a.createElement(r.a,{key:"ok",onClick:this.handleOk,color:"primary"},"Рассчитать и закрыть"),i&&i.ok&&s.a.createElement(r.a,{key:"ok",onClick:this.handleOk,color:"primary"},i.ok),!i&&s.a.createElement(r.a,{key:"calck",onClick:this.handleCalck,color:"primary"},"Рассчитать"),i&&i.calck&&s.a.createElement(r.a,{key:"calck",onClick:this.handleCalck,color:"primary"},i.calck),s.a.createElement(r.a,{key:"cancel",onClick:e,color:"primary"},"Закрыть")]},s.a.createElement(o,{ref:e=>this.additions=e,dialog:a}),l&&s.a.createElement(c.a,{open:!0,title:l.title||"Ошибка при записи",onClose:t,actions:[s.a.createElement(r.a,{key:"ok",onClick:t,color:"primary"},"Ок")]},l.obj&&s.a.createElement("div",null,l.obj.name),l.text||l),d&&s.a.createElement(c.a,{open:!0,title:`Закрыть ${n.toLowerCase()}?`,onClose:t,actions:[s.a.createElement(r.a,{key:"ok",onClick:e,color:"primary"},"Ок"),s.a.createElement(r.a,{key:"cancel",onClick:t,color:"primary"},"Отмена")]},"Внесённые изменения будут потеряны"))}}t.a=Object(i.a)(o)},585:function(e,t,a){"use strict";a.d(t,"b",(function(){return o}));var n=a(0),s=a.n(n),r=a(521),c=a(329),i=a(74);function o(e){const{rows:t,workpieces:a,products_len:n,workpieces_len:s,scraps_percent:r,scraps_len:c,userData:{usefulscrap:i}}=e;return`${(n/1e3).toFixed(1)}м, ${t.length}шт, Заготовок: ${(s/1e3).toFixed(1)}м, ${a.length}шт, Обрезь: ${(c/1e3).toFixed(1)}м, ${a.reduce((e,t)=>t>i?e+1:e,0)}шт, Отходы: ${((s-n-c)/1e3).toFixed(1)}м, ${r.toFixed(1)}%`}class l extends n.Component{render(){const{status:e,classes:t}=this.props,a=100*e.progress,n=a+6*Math.random();return s.a.createElement("div",{className:t.bottom},s.a.createElement(r.a,{primary:`${e.nom.name}${e.characteristic.empty()?"":" "+e.characteristic.name}`}),s.a.createElement(c.a,{color:"secondary",variant:"buffer",value:a,valueBuffer:n}),s.a.createElement(r.a,{secondary:o(e),className:t.noPadding}))}}t.a=Object(i.a)(e=>({bottom:{marginBottom:e.spacing(2)},noPadding:{padding:0}}))(l)},636:function(e,t,a){"use strict";var n=a(0),s=a.n(n),r=a(1),c=a.n(r),i=a(46),o=a(528),l=a(529),d=a(527),h=a(526),u=a(74);var m=Object(u.a)(e=>({root:{width:"80vw",marginLeft:"auto",marginRight:"auto","@media print":{width:"190mm",backgroundColor:e.palette.common.white},"& td":{padding:e.spacing()/2,border:"1px solid rgba(224, 224, 224, 1)"}},row:{height:"inherit"},nom:{marginTop:e.spacing(2)},data:{marginBottom:e.spacing(2)},canvas:{width:"100%"}})),p=a(585);function g({_obj:e,classes:t}){const a=new Set;return e.planning.forEach(({obj:e})=>a.add(e.calc_order)),s.a.createElement("div",null,s.a.createElement(i.a,{variant:"headline"},e.presentation),s.a.createElement(o.a,{classes:{cell:t.cell}},s.a.createElement(l.a,null,s.a.createElement(h.a,{className:t.row},s.a.createElement(d.a,null,s.a.createElement(i.a,{variant:"subtitle1"},"Участок")),s.a.createElement(d.a,null,e.key.presentation),s.a.createElement(d.a,null,s.a.createElement(i.a,{variant:"subtitle1"},"Получатель")),s.a.createElement(d.a,null,e.recipient.presentation)),s.a.createElement(h.a,{className:t.row},s.a.createElement(d.a,null,s.a.createElement(i.a,{variant:"subtitle1"},"Заказы")),s.a.createElement(d.a,{colSpan:3},Array.from(a).map(e=>e.number_doc).sort().join(", "))))))}function f({_obj:e,classes:t}){const a=[],{debit_credit_kinds:n}=$p.enm;return e.fragments().forEach((r,c)=>{for(const[o]of r){const r=e.cutting.find_rows({nom:c,characteristic:o}),l=e.cuts.find_rows({record_kind:n.credit,nom:c,characteristic:o}),d=e.cuts.find_rows({record_kind:n.debit,nom:c,characteristic:o}),h=r.reduce((e,t)=>e+t.len,0),u=l.reduce((e,t)=>e+t.len,0),m=d.reduce((e,t)=>e+t.len,0),g=c.knifewidth||7,f=l.map(({len:e,stick:t})=>(r.forEach(a=>{t===a.stick&&(e-=a.len+g)}),e>0?e:0)),_=100*(u-h-m-r.length*g)/u,k={rows:r,cuts_in:l,workpieces:f,products_len:h,workpieces_len:u,scraps_len:m,scraps_percent:_>0?_:0,userData:{usefulscrap:600,knifewidth:g}};a.push(s.a.createElement("div",{key:`${c.ref}-${o.ref}`,className:t.nom},s.a.createElement(i.a,{variant:"h6"},c.name+(o.empty()?"":" "+o.name)),s.a.createElement(i.a,{variant:"subtitle1"},Object(p.b)(k)),s.a.createElement(w,{classes:t,status:k})))}}),a}class _ extends paper.Project{redraw({userData:e,cuts_in:t,rows:a}){this.clear();let n=88;for(let s=0;s<t.length;s++){const r=t[s],c=r.len,i=Math.round(114.4)*s;new paper.Path({segments:[[0,i],[0+c,i],[0+c,i+n],[0,i+n]],strokeColor:"grey",strokeScaling:!1,strokeWidth:1,closed:!0});const o=[];a.forEach(({stick:e,len:t})=>{e===r.stick&&o.push(t)}),o.sort((e,t)=>t-e),o.reduce((t,a)=>(new paper.Path({segments:[[0+t+44,i+4],[0+t+a-44,i+4],[0+t+a,i+n-4],[0+t,i+n-4]],fillColor:new paper.Color(.1*Math.random()+.7,.2*Math.random()+.8,.1*Math.random()+.88),closed:!0}),new paper.PointText({point:[0+t+a/2,i+24+44],content:a,fillColor:"black",justification:"center",fontSize:72}),t+a+e.knifewidth),0)}this.zoom_fit(),this.view.update()}zoom_fit(){var e=this.activeLayer&&this.activeLayer.strokeBounds;e&&e.height&&e.width&&(this.view.zoom=Math.min((this.view.viewSize.height-8)/e.height,(this.view.viewSize.width-8)/e.width),this.view.center=e.center)}}function w({status:e,classes:t}){return s.a.createElement("canvas",{className:t.canvas,ref:t=>{if(t){t.height=27*e.cuts_in.length*t.width/1530,new _(t).redraw(e)}}})}f.propTypes={_obj:c.a.object.isRequired,classes:c.a.object.isRequired};t.a=m((function({hide_head:e,...t}){return s.a.createElement("div",{className:t.classes.root},!e&&s.a.createElement(g,Object.assign({key:"head"},t)),s.a.createElement("div",{className:t.classes.data,key:"table"},s.a.createElement(f,t)))}))}}]);
//# sourceMappingURL=15.c6a2b644.chunk.js.map