(this.webpackJsonpwindowbuilder=this.webpackJsonpwindowbuilder||[]).push([[16],{1035:function(e,t,n){"use strict";n.r(t);var a=n(0),s=n.n(a),o=n(563),r=n(546),l=n(548),i=n(447),c=n(160),d=n(214),h=n.n(d),p=n(562),u=n.n(p);function m({handleAdd:e,handleRemove:t,count:n}){return s.a.createElement(i.a,{disableGutters:!0},s.a.createElement(c.a,{title:"Добавить строку",onClick:e},s.a.createElement(h.a,null)),s.a.createElement(c.a,{title:"Удалить строку",disabled:!n,onClick:t},s.a.createElement(u.a,null)))}class _ extends s.a.Component{constructor(e){super(e),this.cellSelect=({idx:e,rowIdx:t})=>{const{tabular:n,props:a,selectedRow:s}=this,o=n&&n.rowGetter(t);o!==s&&(this.selectedRow=o,a.onSelect(o,e))},this.cellDeSelect=()=>{this.selectedRow&&(this.selectedRow=null,this.props.onSelect(null))},this.selectedRow=null,this.handleAdd=l.e.bind(this),this.handleRemove=l.f.bind(this),this.state={count:e.dp.production.count()}}render(){const{props:e,state:{count:t}}=this,{dp:n,scheme:a,meta:o}=e;let l=120;t&&(l+=33*((t<8?t:8)-1));return s.a.createElement("div",{style:{height:l+35}},s.a.createElement(r.a,{ref:e=>this.tabular=e,_obj:n,_meta:o,_tabular:"production",scheme:a,onCellSelected:this.cellSelect,onCellDeSelected:this.cellDeSelect,minHeight:l,Toolbar:()=>s.a.createElement(m,{handleAdd:this.handleAdd,handleRemove:this.handleRemove,count:t})}))}}var g=_,f=n(334),y=n(46),b=n(119);var w=function({row:e,param:t,meta:n,handleValueChange:a,id:o,...r}){const l=t.valueOf(),i=Object.assign({},n.fields[l]),{types:c}=t.type;let d=1===c.length&&"cat.property_values"===c[0];const h={selection:{cnstr:e.row}},p=t.params_links({grid:h,obj:e});let u=!t.show_calculated&&t.is_calculated;if(!u&&p.length&&(u=p.some(e=>e.hide)),u)return null;if(p.length){const n=[],s=e._owner._owner.product_params.find({elm:e.row,param:t});s&&t.linked_values(p,s,n)&&a(o),n.length&&(n.length<50&&(d=!0),i.choice_params||(i.choice_params=[]),i.choice_params.push({name:"ref",path:{in:n.map(e=>e.value)}}))}return s.a.createElement(b.a,Object.assign({_obj:e,_fld:l,_meta:i,ctrl_type:d?"oselect":void 0,handleValueChange:()=>a(o),isTabular:!1},r))};class k extends s.a.Component{constructor(...e){super(...e),this._refs={},this.handleValueChange=e=>{this.timer&&clearTimeout(this.timer),this.timer=setTimeout(()=>{this._refs[e]-=1,this.forceUpdate()},100)}}componentWillUnmount(){this.timer&&clearTimeout(this.timer)}render(){const{row:e,inset:t,meta:n}=this.props;if(!e)return s.a.createElement(y.a,{variant:"subtitle1",color:"secondary"},"Нет параметров, либо не выбрана строка продукции");const{product_params:a,presentation:o}=t,r=[s.a.createElement(y.a,{key:"title",variant:"subtitle1",color:"primary"},"Параметры "+o)],l=new Map,{elm_positions:i}=$p.enm;a.forEach(e=>{e.pos.empty()||(l.get(e.pos)||l.set(e.pos,[]),l.get(e.pos).push(e))});const c=(t,a)=>{const o=`${t.param.ref}-${a}`;return this._refs.hasOwnProperty(o)||(this._refs[o]=0),this._refs[o]+=1,s.a.createElement(w,{key:`${o}-${this._refs[o]}`,id:o,row:e,param:t.param,meta:n,handleValueChange:this.handleValueChange})};let d=l.get(i.top);return d&&r.push(s.a.createElement(f.a,{key:"top",row:!0},d.map(c))),[1,2,3].some(e=>l.get(i["column"+e]))&&r.push(s.a.createElement(f.a,{key:"columns",row:!0},[1,2,3].map(e=>{const t=l.get(i["column"+e]);return t?s.a.createElement(f.a,{key:"column"+e},t.map(c)):null}))),d=l.get(i.bottom),d&&r.push(s.a.createElement(f.a,{key:"bottom",row:!0},d.map(c))),r}}class C extends s.a.Component{constructor(e,t){super(e,t),this.inset_change=(e,t)=>{Object.prototype.hasOwnProperty.call(t,"inset")&&this.setState({inset:e.inset})},this.setProduct=e=>{const{inset:t}=e||{};e&&this.state.inset!=t&&e.value_change("inset","",t),this.setState({row:e,inset:t})},this.group=$p.enm.inserts_types.Параметрик,this.items=[this.group],this.state={row:null,inset:null}}componentDidMount(){l.b.call(this,this.props.dialog.ref,[this.group]);const{cat:e,dp:t}=$p;l.c.call(this,e.scheme_settings.find_rows({obj:"dp.buyers_order.production",user:""})),t.buyers_order.on("update",this.inset_change)}componentWillUnmount(){$p.dp.buyers_order.off("update",this.inset_change)}render(){const{state:{schemas:e,row:t,inset:n},props:a,dp:o,components:r,group:l}=this,i=e&&Object.assign({},r.get(l),t&&t._meta&&{meta:t._meta});return e?s.a.createElement(f.a,null,s.a.createElement(g,Object.assign({dp:o,group:l},i,{scheme:e.get(l),onSelect:this.setProduct})),s.a.createElement(k,Object.assign({dp:o,row:t,inset:n},i,a))):s.a.createElement("div",null,"Чтение настроек компоновки...")}}var E=C;t.default=function(e){return s.a.createElement(o.a,Object.assign({Content:E,title:"Параметрические изделия"},e))}},548:function(e,t,n){"use strict";n.d(t,"b",(function(){return h})),n.d(t,"c",(function(){return p})),n.d(t,"e",(function(){return u})),n.d(t,"f",(function(){return m})),n.d(t,"d",(function(){return _}));var a=n(166),s=n(555),o=n(34),r=n(0),l=n.n(r),i=n(546);class c extends r.Component{render(){const{dp:e,meta:t,scheme:n,tref:a,onRowUpdated:s,onCellSelected:o,minHeight:r}=this.props;return l.a.createElement(i.a,{ref:a,_obj:e,_meta:t,_tabular:"production",scheme:n,onRowUpdated:s,onCellSelected:o,minHeight:r,hideToolbar:!0})}}const{ItemData:d}=$p.cat.inserts;function h(e,t){t||(t=this.items=$p.enm.inserts_types.additions_groups);const n=this.dp=$p.dp.buyers_order.create();n.calc_order=$p.doc.calc_order.by_ref[e];const a=this.components=new Map;t.forEach(e=>a.set(e,new d(e,c)));const{production:s,product_params:o}=n;n._data._loading=!0,n.calc_order.production.find_rows({ordn:$p.utils.blank.guid},e=>{const{characteristic:n}=e,{origin:r}=n;if(!n.empty()&&r&&!r.empty()&&-1!=t.indexOf(r.insert_type)){const t=a.get(r.insert_type),l=s.count()+1;n.params.forEach(({param:e,value:t})=>{o.add({elm:l,param:e,value:t})}),s.add({characteristic:n,inset:r,clr:n.clr,len:e.len,height:e.width,quantity:e.quantity,note:e.note},!1,t.ProductionRow),t.count++}}),n._data._loading=!1}function p(e=[]){const t=new Map;for(const n of e)for(const e of this.items)if(e&&n.name==e.name){t.set(e,n);break}this.setState({schemas:t})}function u(){const{tabular:e,props:t}=this,n=_.call(this,t.group);if(n&&e){const{_data:a}=e.state._tabular._owner;a._loading=!0;const s=e.state._tabular.add({inset:n,quantity:1},!1,t.ProductionRow);if(a._loading=!1,s.value_change("inset","force",s.inset),this.setState({count:this.state.count+1}),n.insert_type==$p.enm.inserts_types.Параметрик)for(let t=0;t<s.row;t++)if(e.rowGetter(t)===s){setTimeout(()=>e._grid.selectCell({rowIdx:t,idx:0},!0));break}}else $p.msg.show_msg({type:"alert-info",text:`Нет вставки подходящего типа (${t.group})`,title:"Новая строка"})}function m(){const{props:e,tabular:t,state:n,selectedRow:a}=this;if(t&&a){const{calc_order_row:s}=a.characteristic;a._owner.del(a),this.selectedRow=null,t.forceUpdate(),n.count&&this.setState({count:n.count-1}),s&&s._owner.del(s),e.onSelect&&e.onSelect(null)}else $p.msg.show_msg({type:"alert-info",text:`Укажите строку для удаления (${e.group})`,title:"Удаление строки"})}function _(e){if(!this._inset){const{choice_params:t}=$p.dp.buyers_order.metadata("production").fields.inset,n={insert_type:e};t&&t.forEach(({name:e,path:t})=>{"insert_type"!==e&&(Object.prototype.hasOwnProperty.call(n,e)?(n[e]=[n[e]],n[e].push(t)):n[e]=t)}),this._inset=$p.cat.inserts.find_rows(n).reduce((e,t)=>e&&e.priority>=t.priority?e:t,null)}return this._inset}t.a=Object(o.compose)(s.a,Object(a.connect)((function(e,t){return{handleCalck(){const{additions:e}=this,{dp:n}=e;return n?n.calc_order.process_add_product_list(n).then(()=>{n.calc_order.production.sync_grid(t.dialog.wnd.elmnts.grids.production)}):e.handleCalck()},handleCancel(){t.handlers.handleIfaceState({component:"DataObjPage",name:"dialog",value:null})}}})))},555:function(e,t,n){"use strict";var a=n(74);t.a=Object(a.a)(e=>({entered:{minHeight:120},secondary:{marginTop:-e.spacing(1.5)},groupTitle:{fontWeight:"bold"},listitem:{paddingTop:e.spacing(),paddingBottom:e.spacing()}}))},562:function(e,t,n){"use strict";var a=n(12);Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var s=a(n(0)),o=(0,a(n(13)).default)(s.default.createElement("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"}),"Delete");t.default=o},563:function(e,t,n){"use strict";var a=n(0),s=n.n(a),o=n(159),r=n(85),l=n(548);class i extends s.a.Component{constructor(e,t){super(e,t),this.handleOk=()=>{this.props.handleCalck.call(this).then(this.handleCancel).catch(e=>{this.setState({msg:e.msg||e.message})})},this.handleCalck=()=>{this.props.handleCalck.call(this).catch(e=>{this.setState({msg:e.msg})})},this.handleErrClose=()=>{this.setState({msg:null,queryClose:!1})},this.queryClose=()=>{this.setState({queryClose:!0})};const{handleCancel:n}=e;this.handleCancel=n.bind(this),this.state={msg:null,queryClose:!1}}render(){const{handleCancel:e,handleErrClose:t,props:{dialog:n,title:a,actions:l,Content:i},state:{msg:c,queryClose:d}}=this;return s.a.createElement(r.a,{open:!0,initFullScreen:!0,large:!0,title:a,onClose:this.queryClose,actions:[!l&&s.a.createElement(o.a,{key:"ok",onClick:this.handleOk,color:"primary"},"Рассчитать и закрыть"),l&&l.ok&&s.a.createElement(o.a,{key:"ok",onClick:this.handleOk,color:"primary"},l.ok),!l&&s.a.createElement(o.a,{key:"calck",onClick:this.handleCalck,color:"primary"},"Рассчитать"),l&&l.calck&&s.a.createElement(o.a,{key:"calck",onClick:this.handleCalck,color:"primary"},l.calck),s.a.createElement(o.a,{key:"cancel",onClick:e,color:"primary"},"Закрыть")]},s.a.createElement(i,{ref:e=>this.additions=e,dialog:n}),c&&s.a.createElement(r.a,{open:!0,title:c.title||"Ошибка при записи",onClose:t,actions:[s.a.createElement(o.a,{key:"ok",onClick:t,color:"primary"},"Ок")]},c.obj&&s.a.createElement("div",null,c.obj.name),c.text||c),d&&s.a.createElement(r.a,{open:!0,title:`Закрыть ${a.toLowerCase()}?`,onClose:t,actions:[s.a.createElement(o.a,{key:"ok",onClick:e,color:"primary"},"Ок"),s.a.createElement(o.a,{key:"cancel",onClick:t,color:"primary"},"Отмена")]},"Внесённые изменения будут потеряны"))}}t.a=Object(l.a)(i)}}]);
//# sourceMappingURL=16.5b77a00d.chunk.js.map