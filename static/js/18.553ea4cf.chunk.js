(this.webpackJsonpwindowbuilder=this.webpackJsonpwindowbuilder||[]).push([[18],{1036:function(e,t,a){"use strict";a.r(t);var r=a(0),o=a.n(r),n=a(563),i=a(534),s=a(46),c=a(210),l=a(739),p=a(161),d=a(206),m=a(147),u=a(337),h=a(524),_=a(521);const f=Object(l.a)(e=>({formControl:{margin:e.spacing()},select:{display:"contents"},img:{width:120,margin:-e.spacing()}}));function g({foroomApi:e,product:t,setProduct:a}){const r=f(),[n,i]=o.a.useState(!t),{init_data:s,foroom_pics_url:c}=e.params;return o.a.createElement(m.a,{className:r.formControl,fullWidth:!0},o.a.createElement(p.a,null,"Изделие"),o.a.createElement(u.a,{open:n,onClose:()=>{i(!1)},onOpen:()=>{i(!0)},value:t,onChange:e=>{a(e.target.value)},classes:t?{selectMenu:r.select}:null},s.all_data.izd.filter(e=>e.enabled).map((e,t)=>o.a.createElement(d.a,{key:"izd-"+t,value:e},o.a.createElement(h.a,null,o.a.createElement("img",{className:r.img,src:`${c}${e.icom||e.icon}`})),o.a.createElement(_.a,{primary:e.nameRu,secondary:`${e.name} ${e.ptype}`})))))}const y=Object(l.a)(e=>({formControl:{margin:e.spacing()},img:{width:92,height:92,backgroundSize:"cover",backgroundPosition:"center",marginRight:e.spacing()},select:{display:"contents"}}));function w({foroomApi:e,product:t,value:a,setProp:r}){const n=y(),{foroom_pics_url:i}=e.params;return o.a.createElement(m.a,{className:n.formControl,fullWidth:!0},o.a.createElement(p.a,null,"Материал"),o.a.createElement(u.a,{value:a,onChange:e=>{r(e.target.value)},classes:a?{selectMenu:n.select}:null},t.materials.filter(e=>e.ost>0).map((e,t)=>o.a.createElement(d.a,{key:"mt-"+t,value:e.tid},o.a.createElement(h.a,null,o.a.createElement("span",{className:n.img,style:{backgroundImage:`url(${i}${e.icos||e.icon})`}})),o.a.createElement(_.a,{primary:e.name})))))}var b=a(115),v=a(634),E=a(272);var k=Object(v.a)((function({classes:e,prop:t,props:a,setProp:r}){const n=Object(v.b)(e);if(t.typ.startsWith("radio"))return o.a.createElement(m.a,{classes:n.control,fullWidth:!0,disabled:t.typ.includes("disabled")},o.a.createElement(p.a,{classes:n.label},t.name),o.a.createElement(u.a,{native:!0,value:a[t.alias],onChange:r,input:o.a.createElement(b.a,{classes:n.input})},t.options.map((e,t)=>o.a.createElement("option",{key:t,value:e.val},e.name))));{const e={synonym:t.name};return o.a.createElement(E.a,{_obj:a,_fld:t.alias,_meta:e,handleValueChange:r,extClasses:n,fullWidth:!0})}}));var C=function({foroomApi:e,product:t,props:a,setProp:r}){return t?o.a.createElement("div",null,o.a.createElement(s.a,{variant:"subtitle1"},"Параметры"),t.params.filter(e.filter_params).map((e,n)=>o.a.createElement(k,{key:`${t.id}-${n}`,prop:e,props:a,setProp:r(e.alias)}))):o.a.createElement(s.a,{variant:"subtitle1",color:"secondary"},"Не выбрано изделие")};let x,$;const O={stamp:Date.now(),data:null};class j extends o.a.Component{constructor(...e){super(...e),this.state={product:null,props:{},price:0},this.setProduct=e=>{const t={};for(const a of e.params)x.filter_params(a)&&(a.typ.startsWith("radio")?t[a.alias]=a.options[0]?a.options[0].val:a.val:t[a.alias]=a.val);e.materials.length&&(t.material=e.materials[0].tid),this.setState({product:e,props:t,price:0})},this.setProp=e=>t=>{const{props:a}=this.state;t&&t.target instanceof HTMLElement&&(t=t.target.value);const r=Object.assign({},a,{[e]:t});this.setState({props:r,price:0})}}setOrder(){const{cat:e,doc:t,current_user:a}=$p,{ref:r,cmd:o}=this.props.dialog;let n=Promise.resolve();if(this.supplier=e.http_apis.by_name("FOROOM"),this.supplier.empty()||this.supplier.is_new())throw"empty supplier";this.calc_order=t.calc_order.get(r);const{organization:i,department:s,orders:c}=this.calc_order;return this.calc_order_row=o,this.invoice_row=c.find({is_supplier:this.supplier}),this.invoice_row||(this.invoice_row=c.add({is_supplier:this.supplier})),this.invoice_row.invoice.empty()?n=n.then(()=>t.purchase_order.create({responsible:a,organization:i,department:s})).then(e=>{this.invoice_row.invoice=e}):this.invoice_row.invoice.is_new()&&(n=n.then(()=>this.invoice_row.invoice.load())),n.then(()=>{const{goods:e}=this.invoice_row.invoice;this.goods_row=e.find({nom_characteristic:this.calc_order_row.characteristic}),this.goods_row||(this.goods_row=e.add({calc_order:this.calc_order,nom:this.calc_order_row.nom,nom_characteristic:this.calc_order_row.characteristic,unit:this.calc_order_row.nom.storage_unit,quantity:this.calc_order_row.quantity})),this.calc_order_row.characteristic.origin=this.invoice_row.invoice;const{identifier:t,params:a}=this.goods_row;if(t&&a){const e=t.split("|"),r=x.params.init_data.all_data.izd.find(({tid:t,ptype:a,category:r})=>t==e[0]&&a==e[1]&&r==e[2]);if(r)try{const e={},t=JSON.parse(a);for(const a of r.params)x.filter_params(a)&&(t.hasOwnProperty(a.alias)?e[a.alias]=t[a.alias]:"amount"===a.alias?e.amount=this.calc_order_row.quantity:a.typ.startsWith("radio")?e[a.alias]=a.options[0]?a.options[0].val:a.val:e[a.alias]=a.val);return t.material?e.material=t.material:r.materials.length&&(e.material=r.materials[0].tid),this.setState({product:r,props:e,price:this.calc_order_row.price})}catch(e){}}this.forceUpdate()})}componentDidMount(){Promise.resolve().then(()=>x||$p.adapters.pouch.fetch("/adm/api/foroom/js").then(e=>e.text()).then(e=>{const t=document.createElement("script");t.type="text/javascript",t.text=e+"\n////# sourceURL=/adm/api/foroom/js\n",document.getElementsByTagName("head")[0].appendChild(t),x=window.foroomApi.default,x.filter_params=function(e){return e.visible&&e.enabled&&!e.deleted&&!["gab_width","gab_height"].includes(e.alias)}}).then(()=>this.forceUpdate())).then(()=>$||(O.data&&Date.now()-O.stamp<36e5?Promise.resolve(O.data):$p.adapters.pouch.fetch("/adm/api/foroom").then(e=>e.json()).then(e=>(Object.assign(O,{data:e,stamp:Date.now()}),e))).then(e=>{const t={debug:!0,account:{price_margin:1,discounts:[]},init_data:e,console_mode:!0,nodejs_mode:!1,destination:"sfr"};x.init(t),x.init_calc(e=>{$=e,this.forceUpdate()})})).then(()=>{this.setOrder()}).catch(e=>null)}handleCalck(){const{product:e,props:t}=this.state,a=Object.assign({},t,{type:e.ptype,subtype:e.category});if($.load_template(a),$.current_item.calcPrice(),$.current_item.error){const{params:t}=e;$p.ui.dialogs.alert({title:"Ошибка расчета жалюзи",text:$.current_item.errors.map(e=>{const a=t.find(t=>t.alias===e);return a?a.name:e}).join(", ")})}else{const{goods_row:t,calc_order_row:r}=this,{characteristic:o}=r;t.price=$.current_item.price,t.quantity=a.amount||1,t.params=JSON.stringify($p.utils._mixin({},a,[],["amount","type","subtype"])),t.identifier=`${e.tid}|${e.ptype}|${e.category}`;const{material:n,name:i}=$.convert_item_to_preview(a);o.x=a.width,o.y=a.height,o.s=o.x*o.y/1e6,o.note=`${i.val}/${n.val}`,o.name=o.prod_name(),Object.assign(r._obj,{len:o.x,width:o.y,s:o.s,first_cost:$.current_item.price}),r.value_change("quantity","",t.quantity);const{wnd:s}=this.props.dialog;this.calc_order._modified=!0,s.set_text(this.calc_order.presentation);const{production:c}=s.elmnts.grids;c.refresh_row(r),this.setState({price:r.price})}return this.invoice_row.invoice.save()}render(){if(!x)return o.a.createElement(c.a,{text:"Загрузка библиотеки..."});if(!O.data)return o.a.createElement(c.a,{text:"Подготовка данных..."});if(!this.goods_row)return o.a.createElement(c.a,{text:"Чтение заказа..."});const{product:e,props:t,price:a}=this.state;return o.a.createElement(i.a,{container:!0,direction:"row",justify:"space-between",alignItems:"flex-start",spacing:3},o.a.createElement(i.a,{item:!0,xs:12,md:4},o.a.createElement(g,{foroomApi:x,product:e,setProduct:this.setProduct}),e&&o.a.createElement(w,{foroomApi:x,product:e,value:t.material,setProp:this.setProp("material")}),o.a.createElement("div",null,o.a.createElement(s.a,{component:"span",variant:"h4"},"Цена: "),o.a.createElement(s.a,{component:"span",variant:a?"h4":"h6",color:"secondary"},a||"Не рассчитана"),a?o.a.createElement(s.a,{component:"span",variant:"h4"}," ₽"):null)),o.a.createElement(i.a,{item:!0,xs:12,md:8},o.a.createElement(C,{foroomApi:x,product:e,props:t,setProp:this.setProp})))}}var P=j;t.default=function(e){return o.a.createElement(n.a,Object.assign({Content:P,title:"Жалюзи"},e))}},548:function(e,t,a){"use strict";a.d(t,"b",(function(){return d})),a.d(t,"c",(function(){return m})),a.d(t,"e",(function(){return u})),a.d(t,"f",(function(){return h})),a.d(t,"d",(function(){return _}));var r=a(166),o=a(555),n=a(34),i=a(0),s=a.n(i),c=a(546);class l extends i.Component{render(){const{dp:e,meta:t,scheme:a,tref:r,onRowUpdated:o,onCellSelected:n,minHeight:i}=this.props;return s.a.createElement(c.a,{ref:r,_obj:e,_meta:t,_tabular:"production",scheme:a,onRowUpdated:o,onCellSelected:n,minHeight:i,hideToolbar:!0})}}const{ItemData:p}=$p.cat.inserts;function d(e,t){t||(t=this.items=$p.enm.inserts_types.additions_groups);const a=this.dp=$p.dp.buyers_order.create();a.calc_order=$p.doc.calc_order.by_ref[e];const r=this.components=new Map;t.forEach(e=>r.set(e,new p(e,l)));const{production:o,product_params:n}=a;a._data._loading=!0,a.calc_order.production.find_rows({ordn:$p.utils.blank.guid},e=>{const{characteristic:a}=e,{origin:i}=a;if(!a.empty()&&i&&!i.empty()&&-1!=t.indexOf(i.insert_type)){const t=r.get(i.insert_type),s=o.count()+1;a.params.forEach(({param:e,value:t})=>{n.add({elm:s,param:e,value:t})}),o.add({characteristic:a,inset:i,clr:a.clr,len:e.len,height:e.width,quantity:e.quantity,note:e.note},!1,t.ProductionRow),t.count++}}),a._data._loading=!1}function m(e=[]){const t=new Map;for(const a of e)for(const e of this.items)if(e&&a.name==e.name){t.set(e,a);break}this.setState({schemas:t})}function u(){const{tabular:e,props:t}=this,a=_.call(this,t.group);if(a&&e){const{_data:r}=e.state._tabular._owner;r._loading=!0;const o=e.state._tabular.add({inset:a,quantity:1},!1,t.ProductionRow);if(r._loading=!1,o.value_change("inset","force",o.inset),this.setState({count:this.state.count+1}),a.insert_type==$p.enm.inserts_types.Параметрик)for(let t=0;t<o.row;t++)if(e.rowGetter(t)===o){setTimeout(()=>e._grid.selectCell({rowIdx:t,idx:0},!0));break}}else $p.msg.show_msg({type:"alert-info",text:`Нет вставки подходящего типа (${t.group})`,title:"Новая строка"})}function h(){const{props:e,tabular:t,state:a,selectedRow:r}=this;if(t&&r){const{calc_order_row:o}=r.characteristic;r._owner.del(r),this.selectedRow=null,t.forceUpdate(),a.count&&this.setState({count:a.count-1}),o&&o._owner.del(o),e.onSelect&&e.onSelect(null)}else $p.msg.show_msg({type:"alert-info",text:`Укажите строку для удаления (${e.group})`,title:"Удаление строки"})}function _(e){if(!this._inset){const{choice_params:t}=$p.dp.buyers_order.metadata("production").fields.inset,a={insert_type:e};t&&t.forEach(({name:e,path:t})=>{"insert_type"!==e&&(Object.prototype.hasOwnProperty.call(a,e)?(a[e]=[a[e]],a[e].push(t)):a[e]=t)}),this._inset=$p.cat.inserts.find_rows(a).reduce((e,t)=>e&&e.priority>=t.priority?e:t,null)}return this._inset}t.a=Object(n.compose)(o.a,Object(r.connect)((function(e,t){return{handleCalck(){const{additions:e}=this,{dp:a}=e;return a?a.calc_order.process_add_product_list(a).then(()=>{a.calc_order.production.sync_grid(t.dialog.wnd.elmnts.grids.production)}):e.handleCalck()},handleCancel(){t.handlers.handleIfaceState({component:"DataObjPage",name:"dialog",value:null})}}})))},555:function(e,t,a){"use strict";var r=a(74);t.a=Object(r.a)(e=>({entered:{minHeight:120},secondary:{marginTop:-e.spacing(1.5)},groupTitle:{fontWeight:"bold"},listitem:{paddingTop:e.spacing(),paddingBottom:e.spacing()}}))},563:function(e,t,a){"use strict";var r=a(0),o=a.n(r),n=a(159),i=a(85),s=a(548);class c extends o.a.Component{constructor(e,t){super(e,t),this.handleOk=()=>{this.props.handleCalck.call(this).then(this.handleCancel).catch(e=>{this.setState({msg:e.msg||e.message})})},this.handleCalck=()=>{this.props.handleCalck.call(this).catch(e=>{this.setState({msg:e.msg})})},this.handleErrClose=()=>{this.setState({msg:null,queryClose:!1})},this.queryClose=()=>{this.setState({queryClose:!0})};const{handleCancel:a}=e;this.handleCancel=a.bind(this),this.state={msg:null,queryClose:!1}}render(){const{handleCancel:e,handleErrClose:t,props:{dialog:a,title:r,actions:s,Content:c},state:{msg:l,queryClose:p}}=this;return o.a.createElement(i.a,{open:!0,initFullScreen:!0,large:!0,title:r,onClose:this.queryClose,actions:[!s&&o.a.createElement(n.a,{key:"ok",onClick:this.handleOk,color:"primary"},"Рассчитать и закрыть"),s&&s.ok&&o.a.createElement(n.a,{key:"ok",onClick:this.handleOk,color:"primary"},s.ok),!s&&o.a.createElement(n.a,{key:"calck",onClick:this.handleCalck,color:"primary"},"Рассчитать"),s&&s.calck&&o.a.createElement(n.a,{key:"calck",onClick:this.handleCalck,color:"primary"},s.calck),o.a.createElement(n.a,{key:"cancel",onClick:e,color:"primary"},"Закрыть")]},o.a.createElement(c,{ref:e=>this.additions=e,dialog:a}),l&&o.a.createElement(i.a,{open:!0,title:l.title||"Ошибка при записи",onClose:t,actions:[o.a.createElement(n.a,{key:"ok",onClick:t,color:"primary"},"Ок")]},l.obj&&o.a.createElement("div",null,l.obj.name),l.text||l),p&&o.a.createElement(i.a,{open:!0,title:`Закрыть ${r.toLowerCase()}?`,onClose:t,actions:[o.a.createElement(n.a,{key:"ok",onClick:e,color:"primary"},"Ок"),o.a.createElement(n.a,{key:"cancel",onClick:t,color:"primary"},"Отмена")]},"Внесённые изменения будут потеряны"))}}t.a=Object(s.a)(c)},634:function(e,t,a){"use strict";a.d(t,"b",(function(){return o}));var r=a(74);const o=e=>({label:{shrink:e.lshrink,formControl:e.lformControl},input:{root:e.iroot},control:{root:e.control},checkbox:{root:e.checkbox}});t.a=Object(r.a)(e=>({lshrink:{transform:"translate(0, 12px)"},lformControl:{top:0,left:0,position:"absolute",transform:"translate(0, 12px)"},iroot:{marginLeft:"40%","label + &":{marginTop:0}},control:{minWidth:300,paddingRight:e.spacing(),paddingTop:2,borderBottom:"1px solid #e8e8e8"},checkbox:{borderRadius:"unset"}}))}}]);
//# sourceMappingURL=18.553ea4cf.chunk.js.map